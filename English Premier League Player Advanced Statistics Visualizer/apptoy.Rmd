```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(fmsb)
library(scales)
library(plotly)
library(highcharter)
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))
library(knitr)
library(DT)
library(png)
library(here)
library(cowplot)
```

```{r}
epl_player_22 <- read_csv("data/epl_player_22.csv") %>% separate(player_positions, into = c("Pos1", "Pos2", "Pos3"), remove = FALSE)
epl_players <- epl_player_22 %>% select(c(4, 6:9, 12:17, 19, 23, 26, 28, 32, 110, 111, 114))

epl_comb <- left_join(epl_standard, epl_players) %>% filter(!is.na(player_face_url)) 
epl_positions <- epl_comb %>% select(Name, Pos1, Pos2, Pos3)
```

```{r}
# for (i in 1:nrow(epl_comb)) {
#   url <- paste(epl_comb[i,39], sep ="")
#   z <- tempfile()
#   download.file(url,z,mode="wb")
#   pic <- readPNG(z)
#   name <- paste(epl_comb %>% slice(i) %>% select(Name))
#   writePNG(pic, here("images", paste(name, ".png", sep = "")))
#   file.remove(z)
# }

# nations <- epl_comb %>% select(nationality_name, nation_flag_url) %>% distinct()
# for (i in 1:nrow(nations)) {
#   url <- paste(nations[i,2], sep ="")
#   z <- tempfile()
#   download.file(url,z,mode="wb")
#   pic <- readPNG(z)
#   name <- paste(nations %>% slice(i) %>% select(nationality_name))
#   writePNG(pic, here("images", paste(name, ".png", sep = "")))
#   file.remove(z)
# }
# 
# clubs <- epl_comb %>% select(club_name, club_logo_url) %>% distinct() %>% arrange(club_name) %>% slice(-c(3,7,11,13, 16, 20,24,25,27,30,31))
# for (i in 1:nrow(clubs)) {
#   url <- paste(clubs[i,2], sep ="")
#   z <- tempfile()
#   download.file(url,z,mode="wb")
#   pic <- readPNG(z)
#   name <- paste(clubs %>% slice(i) %>% select(club_name))
#   writePNG(pic, here("images", paste(name, ".png", sep = "")))
#   file.remove(z)
# }
```


```{r}
epl_standard <- read_csv("data/epl_standard.csv") %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) %>%
  select(-c(`Gls/90`, `Ast/90`, `G+A/90`, `G-PK/90`, `G+A-PK/90`, `xG/90`, `xA/90`, `xG+xA/90`, `npxG/90`, `npxG+xA/90`)) %>% 
  mutate(`G+A` = Gls + Ast)

epl_standard_90 <- read_csv("data/epl_standard_90.csv") %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) 
```

```{r}
epl_standard %>% 
  summarise(`25perc_90s` = quantile(`90s`, c(0.10)))
epl_standard %>% summarise(max(`90s`))
```


```{r}
epl_shooting <- read_csv("data/epl_shooting.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) %>%
  select(-c(`Sh/90`, `SoT/90`))
epl_shooting2 <- read_csv("data/epl_shooting.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) %>%
  select(-c(`Sh/90`, `SoT/90`))

epl_shooting_90 <- read_csv("data/epl_shooting_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) %>%
  select(-c(`Sh/90`, `SoT/90`)) 
epl_shooting_902 <- read_csv("data/epl_shooting_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel)) %>%
  select(-c(`Sh/90`, `SoT/90`)) 

shooting_descr <- read_csv("data/shooting_descr.csv")
```

```{r}
epl_shooting_max <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_shooting_min <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min) 

epl_shoot_player <- epl_shooting %>% filter(Name == "Cristiano Ronaldo")

epl_shooting_max_min <- bind_rows(epl_shooting_max, epl_shooting_min)

epl_shoot_full <- bind_rows(epl_shooting_max_min, epl_shoot_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK))

epl_shoot_full_scaled <- epl_shoot_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_shoot_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(`G-xG` = 1 - `G-xG`,
         `np:G-xG` = 1- `np:G-xG`) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         `Non Penalty: Goals - xGoals` = `np:G-xG`,
         `Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(1:ncol(epl_shoot_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Goals",
                            "Shots",
                            "Goals/Shot",
                            "Shots on Target",
                            "Shots on Target%",
                            "Goals/Shot on Target",
                            "Distance",
                            "Non Penalty: xGoals/Shot",
                            "Non Penalty: Goals - xGoals",
                            "Non Penalty xGoals",
                            "Goals - xGoals",
                            "xGoals"))) 


shooting_plot <- highchart() %>%
  hc_chart(polar = TRUE) %>%
  hc_add_theme(hc_theme_db()) %>%
  hc_xAxis(categories = epl_shoot_full_scaled$variable) %>%
  hc_yAxis(tickAmount = 5,
           max = 1,
           tickPixelInterval = 0.01,
           shared = TRUE) %>%
  hc_title(text = epl_shoot_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_shoot_player$Squad,
              align = "center") %>%
  hc_add_series(data = shooting_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "scatter",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_shoot_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "darkgrey",
                borderWidth = .2) 
```

```{r}
epl_shoot_over_scl <- epl_shooting %>% select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK)) %>%
 pivot_longer(c(2:13), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  mutate(`G-xG` = 1 - `G-xG`,
         `np:G-xG` = 1- `np:G-xG`,
         Gls = Gls * 5
         ) %>%
  pivot_longer(c(1:ncol(epl_shoot_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(shoot_over_scl = mean(value.scaled, na.rm = TRUE))

epl_shoot_over_rnk <- epl_shooting_rank %>%  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK)) %>% select(-c(2:13)) %>%
pivot_longer(cols = c(2:13), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  mutate(`rank_G-xG` = 1 - `rank_G-xG`,
         `rank_np:G-xG` = 1- `rank_np:G-xG`,
         rank_Gls = rank_Gls * 5
         ) %>%
  pivot_longer(c(1:ncol(epl_shoot_full) + 2), names_to = "rankVar", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(shoot_over_rnk = mean(rank.scaled, na.rm = TRUE))


epl_shoot_over <- left_join(epl_shoot_over_scl, epl_shoot_over_rnk) %>% 
  mutate(shoot_over = (shoot_over_scl + shoot_over_rnk)/2) %>% 
  select(Name, shoot_over) %>%
  mutate(shoot_over.scaled = (shoot_over - min(shoot_over))/ (max(shoot_over) - min(shoot_over)),
         shoot_over_rank.scaled = (rank(shoot_over)/max(rank(shoot_over))))
```


```{r}
epl_shooting_max <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_shooting_min <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min) 

epl_shoot_2_player <- epl_shooting %>% filter(Name == "Cristiano Ronaldo" | Name == "Marcus Rashford")

epl_shooting_max_min <- bind_rows(epl_shooting_max, epl_shooting_min)

epl_shoot_2_full <- bind_rows(epl_shooting_max_min, epl_shoot_2_player) %>%
  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK))

epl_shoot_2_full_scaled <- epl_shoot_2_full %>% mutate(type = c("max", "min","player", "player2")) %>%
  pivot_longer(c(1:ncol(epl_shoot_2_full) - 1), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player" | type == "player2") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(`G-xG` = 1 - `G-xG`,
         `np:G-xG` = 1- `np:G-xG`) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         `Non Penalty: Goals - xGoals` = `np:G-xG`,
         `Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(2:ncol(epl_shoot_2_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Goals",
                            "Shots",
                            "Goals/Shot",
                            "Shots on Target",
                            "Shots on Target%",
                            "Goals/Shot on Target",
                            "Distance",
                            "Non Penalty: xGoals/Shot",
                            "Non Penalty: Goals - xGoals",
                            "Non Penalty xGoals",
                            "Goals - xGoals",
                            "xGoals"))) 


shooting_plot <- highchart() %>%
  hc_chart(polar = TRUE) %>%
  hc_add_theme(hc_theme_db()) %>%
  hc_xAxis(categories = epl_shoot_full_scaled$variable) %>%
  hc_yAxis(tickAmount = 5,
           max = 1,
           tickPixelInterval = 0.01,
           shared = TRUE) %>%
  hc_title(text = epl_shoot_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_shoot_player$Squad,
              align = "center") %>%
  hc_add_series(data = shooting_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_shoot_2_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled, group = Name), 
                type = "area",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = TRUE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) 
```

```{r}
epl_shooting_rank <- epl_shooting %>%
  mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK), min_rank, .names = "rank_{.col}")) %>%
  mutate(`rank_G-xG` = rank(-`G-xG`),
         `rank_np:G-xG` = rank(-`np:G-xG`))

epl_shooting_rank_max <- epl_shooting_rank %>%
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)

epl_shooting_rank_min <- epl_shooting_rank %>%
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, min)

epl_shooting_rank_player <- epl_shooting_rank %>% filter(Name == "Cristiano Ronaldo")

epl_shooting_rank_max_min <- bind_rows(epl_shooting_rank_max, epl_shooting_rank_min)

epl_shooting_rank_full <- bind_rows(epl_shooting_rank_max_min, epl_shooting_rank_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK))

epl_shooting_var_vals <- epl_shooting_rank_player %>% 
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  slice(c(1:12))

epl_shooting_var_ranks <- epl_shooting_rank_full %>% 
  select(-c(1:12)) %>%
  mutate(type = c("max", "min","player")) %>%
  pivot_longer(cols = c(1:12), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
  filter(type == "player")
  
epl_shooting_rank_final <- bind_cols(epl_shooting_var_vals, epl_shooting_var_ranks) %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         `Non Penalty: Goals - xGoals` = `np:G-xG`, 
         `Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(5:16), names_to = "variable", values_to = "value") %>%
  filter(!is.na(value)) %>%
  arrange(match(variable, c("Goals",
                            "Shots",
                            "Goals/Shot",
                            "Shots on Target",
                            "Shots on Target%",
                            "Goals/Shot on Target",
                            "Distance",
                            "Non Penalty: xGoals/Shot",
                            "Non Penalty: Goals - xGoals",
                            "Non Penalty xGoals",
                            "Goals - xGoals",
                            "xGoals"))) 

shooting_rank_plot <- highchart() %>%
  hc_chart(polar = TRUE) %>%
  hc_add_theme(hc_theme_db()) %>%
  hc_xAxis(categories = epl_shoot_full_scaled$variable) %>%
  hc_yAxis(tickAmount = 5,
           max = 1,
           tickPixelInterval = 0.01,
           shared = TRUE) %>%
  hc_title(text = epl_shooting_rank_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_shooting_rank_player$Squad,
              align = "center") %>%
  hc_add_series(data = shooting_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "scatter",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_shooting_rank_final, 
                mapping = hcaes(x = variable, y = rank.scaled), 
                type = "column",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "darkgrey",
                borderWidth = .2) 
```

```{r}
epl_shoot_2_player <- epl_shooting %>% filter(Name == "Cristiano Ronaldo" | Name == "Marcus Rashford")
  epl_shooting_2_rank <- epl_shooting %>%
      filter(`90s` >= 4,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != "Cristiano Ronaldo" & Name != "Marcus Rashford") %>%
      bind_rows(epl_shoot_2_player) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK), min_rank, .names = "rank_{.col}")) %>%
      mutate(`rank_G-xG` = rank(-`G-xG`),
             `rank_np:G-xG` = rank(-`np:G-xG`))
      
  epl_shooting_2_rank_max <- 
    epl_shooting_2_rank %>%
    drop_na() %>%
    filter(`90s` >= 4,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  
  epl_shooting_2_rank_min <- 
    epl_shooting_2_rank %>%
    drop_na() %>%
    filter(`90s` >= 4,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  
  epl_shooting_2_rank_player <- 
    epl_shooting_2_rank %>% filter(Name == "Cristiano Ronaldo" | Name == "Marcus Rashford")
  
  epl_shooting_2_rank_max_min <- 
    bind_rows(epl_shooting_2_rank_max, epl_shooting_2_rank_min)
  
  epl_shooting_2_rank_full <- 
    bind_rows(epl_shooting_2_rank_max_min, epl_shooting_2_rank_player) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK))
  
  epl_shooting_2_var_vals <- 
    epl_shooting_2_rank_player %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    slice(c(1:12), c(25:36))
  
  epl_shooting_2_var_ranks <- 
    epl_shooting_2_rank_full %>% 
    select(-c(1:12)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:12), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
    select(-c(Name))

  epl_shooting_2_rank_final <- 
    bind_cols(epl_shooting_2_var_vals, epl_shooting_2_var_ranks) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           `Non Penalty: Goals - xGoals` = `np:G-xG`,
           `Goals - xGoals` = `G-xG`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(6:17), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty: Goals - xGoals",
                              "Non Penalty xGoals",
                              "Goals - xGoals",
                              "xGoals"))) 
  
```

```{r}
epl_shooting_2_rank_max_long <- epl_shooting_2_rank_max %>% select(19:30) %>% pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
  slice(rep(c(1:12), 2)) %>%
  arrange(rankVarMax)
epl_shoot_2_table <- epl_shoot_2_full_scaled %>% select(-c(type)) %>% 
  group_by(variable) %>%
  mutate(maxes = max(value)) %>%
  group_by(Name, variable) %>%
  mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
  select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
  bind_cols(epl_shooting_2_rank_final %>% select(rankVar, rank.scaled)) %>%
  arrange(rankVar) %>%
  bind_cols(epl_shooting_2_rank_max_long) %>%
  mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
  select(variable, value, value.scaled, oppRank, row.color) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled,
         Ranking = oppRank) %>%
    arrange(match(Stat, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "xGoals",
                              "Non Penalty xGoals",
                              "Goals - xGoals",
                              "Non Penalty: Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Distance"
                              ))) %>%
  ungroup() %>%
  mutate_all(as.character) %>%
  pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
  pivot_wider(names_from = "Name", values_from = "numbers") %>%
  pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
  mutate(across(c(3,7), as.numeric)) %>%
  select(c(5,4,3,2,1,6,7,8,9))

  
datatable(epl_shoot_2_table, options = list(pageLength = 25,
                               initComplete =JS(
      "function(settings, json) {",
      "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
      "}"),
      columnDefs = list(list(className = 'dt-center', targets = "_all"),
                      list(targets = c(1,9), visible = F)))) %>% 
  formatStyle(c(2, 3, 4), 1,
              backgroundColor = styleEqual(sort(unique(epl_shoot_2_table[[1]])),
                                           sort(unique(epl_shoot_2_table[[1]])))) %>%
  formatStyle(c(6,7,8),9,
              backgroundColor = styleEqual(sort(unique(epl_shoot_2_table[[9]])),
                                           sort(unique(epl_shoot_2_table[[9]])))) %>%
  formatStyle(columns = c(1:NCOL(epl_shoot_2_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
  formatRound(c(3, 7), digits = 2)
```


```{r}
ranker = function(x, den) {paste0(round(x*den), "/", den)}
epl_shooting_rank_max_long <- epl_shooting_rank_max %>% select(19:30) %>% pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
epl_shoot_table <- left_join(epl_shoot_full_scaled, epl_shooting_rank_final) %>% 
  bind_cols(epl_shooting_rank_max_long) %>%
  mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
  select(variable, value, value.scaled, oppRank) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled,
         Ranking = oppRank) 
  
data <- epl_shoot_table %>% 
  mutate(row.color = case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                               `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                               `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                               `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                               `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                               `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                               `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                               `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                               `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                               `Scaled Value` > 0.9 ~ "#488f31"))

datatable(data, options = list(pageLength = 25,
                               initComplete =JS(
      "function(settings, json) {",
      "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
      "}"),
      columnDefs = list(list(className = 'dt-center', targets = "_all"),
                      list(targets = 5, visible = F)))) %>% formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", backgroundColor = styleEqual(sort(unique(data$row.color)), sort(unique(data$row.color)))) %>%
  formatStyle(columns = c(1:NCOL(data)),'font-size' = '25px',fontWeight = 'Bold') %>%
  formatRound(c("Scaled Value"), digits = 2)
```




```{r}
epl_shooting_90_max <- epl_shooting_90 %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>% 
  summarise_if(is.numeric, max )
epl_shooting_90_min <- epl_shooting_90 %>%  
  drop_na() %>%
  filter(`90s` >= 4) %>%
  summarise_if(is.numeric, min) 

epl_shoot_90_player <- epl_shooting_90 %>% filter(Name == "Cristiano Ronaldo")

epl_shooting_90_max_min <- bind_rows(epl_shooting_90_max, epl_shooting_90_min)

epl_shoot_90_full <- bind_rows(epl_shooting_90_max_min, epl_shoot_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK))

epl_shoot_90_full_scaled <- epl_shoot_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_shoot_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(`G-xG` = 1 - `G-xG`,
         `np:G-xG` = 1- `np:G-xG`) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         `Non Penalty: Goals - xGoals` = `np:G-xG`,
         `Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(1:ncol(epl_shoot_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Goals",
                            "Shots",
                            "Goals/Shot",
                            "Shots on Target",
                            "Shots on Target%",
                            "Goals/Shot on Target",
                            "Distance",
                            "Non Penalty: xGoals/Shot",
                            "Non Penalty: Goals - xGoals",
                            "Non Penalty xGoals",
                            "Goals - xGoals",
                            "xGoals"))) 


shooting_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = shooting_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                color = "lightgrey",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%   
  hc_add_series(data = epl_shoot_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_shoot_full_scaled$variable) %>%
  hc_yAxis(tickAmount = 5,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_shoot_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_shoot_90_player$Squad,
              align = "center")
```

```{r}
epl_shoot_90_table <- epl_shoot_90_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_shoot_90_table, digits = 3, title = "Shooting per 90 Minutes")
```


## shoot touches
```{r}
touches100 <- epl_possesion %>% group_by(Name) %>% summarise(touches100 = Touches / 100)
touches100_90 <- epl_possesion_90 %>% group_by(Name) %>% summarise(touches100 = Touches /100)
```

```{r}
shooting_touches <- left_join(epl_shooting, touches100) %>% mutate(across(-c(1:8, touches100, `G/Sh`, `SoT%`, `G/SoT`, Dist))/touches100) %>% select(-c(touches100))
```

```{r}
shooting_touches_90 <- left_join(epl_shooting_90, touches100_90) %>% mutate(across(-c(1:8, touches100, `G/Sh`, `SoT%`, `G/SoT`, Dist))/touches100) %>% select(-c(touches100))
```



```{r}
epl_shooting_max <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_shooting_min <- epl_shooting %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min) 

epl_shoot_player <- epl_shooting %>% filter(Name == "Cristiano Ronaldo")

epl_shooting_max_min <- bind_rows(epl_shooting_max, epl_shooting_min)

epl_shoot_full <- bind_rows(epl_shooting_max_min, epl_shoot_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'))

epl_shoot_full_scaled <- epl_shoot_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_shoot_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  #mutate(`G-xG` = 1 - `G-xG`,
  #       `np:G-xG` = 1- `np:G-xG`) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         #`Non Penalty: Goals - xGoals` = `np:G-xG`,
         #`Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(1:ncol(epl_shoot_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Goals",
                            "Shots",
                            "Goals/Shot",
                            "Shots on Target",
                            "Shots on Target%",
                            "Goals/Shot on Target",
                            "Distance",
                            "Non Penalty: xGoals/Shot",
                            #"Non Penalty: Goals - xGoals",
                            "Non Penalty xGoals",
                            #"Goals - xGoals",
                            "xGoals"))) 


shooting_plot <- highchart() %>%
  hc_chart(polar = TRUE) %>%
  hc_add_theme(hc_theme_db()) %>%
  hc_xAxis(categories = epl_shoot_full_scaled$variable) %>%
  hc_yAxis(tickAmount = 5,
           max = 1,
           tickPixelInterval = 0.01,
           shared = TRUE) %>%
  hc_title(text = epl_shoot_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_shoot_player$Squad,
              align = "center") %>%
  hc_add_series(data = shooting_descr %>% filter(variable != 'Goals - xGoals' & variable != 'Non Penalty: Goals - xGoals'),
                mapping = hcaes(x = variable, y = 1),
                type = "scatter",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_shoot_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "darkgrey",
                borderWidth = .2) 
```


```{r}
epl_passing <- read_csv("data/epl_passing.csv") %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_passing_90 <- read_csv("data/epl_passing_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
passing_descr <- read_csv("data/passing_descr.csv")
```


```{r}
epl_passtype <- read_csv("data/epl_passtypes.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_passtype_90 <- read_csv("data/epl_passtypes_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
epl_goalandshotcreation <- read_csv("data/epl_goalandshotcreation.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_goalandshotcreation_90 <- read_csv("data/epl_goalandshotcreation_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```
 
```{r}
epl_passing_fill <- left_join(epl_passing, epl_passtype)
epl_passing_comb <- left_join(epl_passing_fill, epl_goalandshotcreation) %>%
  rename(`1/3` = `3-Jan`) %>%
  mutate(SCA_passes = SCA_PassLive + SCA_PassDead,
         GCA_passes = GCA_PassLive + GCA_PassDead)

epl_passing_main <- epl_passing_comb %>% 
  select(c(1:11, 14,16,17,19,20,22:24, 26:28,30,35:38, 72,73))
epl_passing_main2 <- epl_passing_comb %>% 
  select(c(1:11, 14,16,17,19,20,22:24, 26:28,30,35:38, 72,73))

epl_passing_main_max <- epl_passing_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_passing_main_min <- epl_passing_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_pass_player <- epl_passing_main %>% filter(Name == "Joao Cancelo")

epl_passing_main_max_min <- bind_rows(epl_passing_main_max, epl_passing_main_min)

epl_pass_full <-bind_rows(epl_passing_main_max_min, epl_pass_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))

epl_pass_full_scaled <- epl_pass_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_pass_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(3:23), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  

passing_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = passing_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "",pointFormat = "{point.description}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_pass_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_pass_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_pass_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_pass_player$Squad,
              align = "center")
```

```{r}
epl_pass_table <- epl_pass_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_pass_table, digits = 3, title = "Passing")
```

```{r}
epl_passing_rank <- epl_passing_main %>%
  mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 

epl_pass_over_scl <- epl_passing_main %>% select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>%
 pivot_longer(c(2:22), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  mutate(Ast = Ast * 2,
         xA = xA *1.5) %>%
  pivot_longer(c(1:ncol(epl_pass_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(pass_over_scl = mean(value.scaled, na.rm = TRUE))

epl_pass_over_rnk <- epl_passing_rank %>%  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% select(-c(2:22)) %>%
pivot_longer(cols = c(2:22), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  mutate(rank_Ast = rank_Ast * 2,
         rank_xA = rank_xA *1.5) %>%
  pivot_longer(c(1:ncol(epl_pass_full) + 2), names_to = "rankVar", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(pass_over_rnk = mean(rank.scaled, na.rm = TRUE))


epl_pass_over <- left_join(epl_pass_over_scl, epl_pass_over_rnk) %>% 
  mutate(pass_over = (pass_over_scl + pass_over_rnk)/2) %>% 
  select(Name, pass_over) %>%
  mutate(pass_over.scaled = (pass_over - min(pass_over))/ (max(pass_over) - min(pass_over)),
         pass_over_rank.scaled = (rank(pass_over)/max(rank(pass_over))))
```


```{r}
epl_passing_90_fill <- left_join(epl_passing_90, epl_passtype_90)
epl_passing_90_comb <- left_join(epl_passing_90_fill, epl_goalandshotcreation_90) %>%
  rename(`1/3` = `3-Jan`) %>%
  mutate(SCA_passes = SCA_PassLive + SCA_PassDead,
         GCA_passes = GCA_PassLive + GCA_PassDead)

epl_passing_90_main <- epl_passing_90_comb %>% 
  select(c(1:11, 14,16,17,19,20, 22:24, 26:28,30,35:38, 72,73, Sw))
epl_passing_90_main2 <- epl_passing_90_comb %>% 
  select(c(1:11, 14,16,17,19,20, 22:24, 26:28,30,35:38, 72,73, Sw))

epl_passing_90_main_max <- epl_passing_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_passing_90_main_min <- epl_passing_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_pass_90_player <- epl_passing_90_main %>% filter(Name == "Alex Telles")

epl_passing_90_main_max_min <- bind_rows(epl_passing_90_main_max, epl_passing_90_main_min)

epl_pass_90_full <-bind_rows(epl_passing_90_main_max_min, epl_pass_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))

epl_pass_90_full_scaled <- epl_pass_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_pass_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(3:23), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  

passing_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
   hc_add_series(data = epl_pass_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_pass_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_pass_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_pass_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_pass_90_player$Squad,
              align = "center")
```

```{r}
epl_pass_90_table <- epl_pass_90_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_pass_90_table, digits = 3, title = "Passing per 90 Minutes")
```

```{r}
passing_touches <- left_join(epl_passing_main, touches100) %>% mutate(across(-c(1:8, touches100, `Cmp% Total`, `Cmp% Short`, `Cmp% Medium`, `Cmp% Long`))/touches100) %>% select(-c(touches100))
```

```{r}
passing_touches_90 <- left_join(epl_passing_90_main, touches100_90) %>% mutate(across(-c(1:8, touches100, `Cmp% Total`, `Cmp% Short`, `Cmp% Medium`, `Cmp% Long`))/touches100) %>% select(-c(touches100))
```

```{r}
epl_defensiveactions <- read_csv("data/epl_defensiveactions.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_defensiveactions_90 <- read_csv("data/epl_defensiveactions_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
``` 

```{r}
def_descr <- read_csv("data/def_descr.csv")
epl_def_main <- epl_defensiveactions %>% 
  mutate(`TklsW%` = TklsW / Tkls * 100,
         `TklsW%` = as.numeric(format(round(`TklsW%`, 2)))) %>%
  select(c(1:14, 16, 18:23, 25, 27, 28, 30, 32))
  

epl_def_main_max <- epl_def_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_def_main_min <- epl_def_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_def_player <- epl_def_main %>% filter(Name == "Virgil van Dijk")

epl_def_main_max_min <- bind_rows(epl_def_main_max, epl_def_main_min)

epl_def_full <-bind_rows(epl_def_main_max_min, epl_def_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) 

epl_def_full_scaled <- epl_def_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_def_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
  pivot_longer(c(3:20), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Tackles",
                            "Tackles Won",
                            "% of Tackles Won",
                            "Tackles vs Dribbles",
                            "% of Dribbles Tackled",
                            "Tackles in Attacking 3rd",
                            "Tackles in Middle 3rd",
                            "Tackles in Defensive 3rd",
                            "Pressures",
                            "Succesful Pressures",
                            "Succesful Pressures %",
                            "Pressures in Attacking 3rd",
                            "Pressures in Middle 3rd",
                            "Pressures in Defensive 3rd",
                            "Clearances",
                            "Blocked Shots",
                            "Blocked Passes",
                            "Interceptions"))) 

 

def_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey", grouping = FALSE) %>%
  hc_add_series(data = epl_def_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE) %>%
  hc_add_series(data = epl_def_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = .25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_def_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_def_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_def_player$Squad,
              align = "center") 
```

```{r}
epl_def_table <- epl_def_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_def_table, digits = 3, title = "Defending")
```


```{r}
epl_def_90_main <- epl_defensiveactions_90 %>% 
  mutate(`TklsW%` = TklsW / Tkls * 100,
         `TklsW%` = as.numeric(format(round(`TklsW%`, 2)))) %>%
  select(c(1:14, 16, 18:23, 25, 27, 28, 30, 32))
  

epl_def_90_main_max <- epl_def_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4.01,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_def_90_main_min <- epl_def_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_def_90_player <- epl_def_90_main %>% filter(Name == "Declan Rice")

epl_def_90_main_max_min <- bind_rows(epl_def_90_main_max, epl_def_90_main_min)

epl_def_90_full <-bind_rows(epl_def_90_main_max_min, epl_def_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) 

epl_def_90_full_scaled <- epl_def_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_def_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
  pivot_longer(c(3:20), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Tackles",
                            "Tackles Won",
                            "% of Tackles Won",
                            "Tackles vs Dribbles",
                            "% of Dribbles Tackled",
                            "Tackles in Attacking 3rd",
                            "Tackles in Middle 3rd",
                            "Tackles in Defensive 3rd",
                            "Pressures",
                            "Succesful Pressures",
                            "Succesful Pressures %",
                            "Pressures in Attacking 3rd",
                            "Pressures in Middle 3rd",
                            "Pressures in Defensive 3rd",
                            "Clearances",
                            "Blocked Shots",
                            "Blocked Passes",
                            "Interceptions"))) 

 
  

def_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
    hc_add_series(data = epl_def_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_def_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_def_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_def_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_def_90_player$Squad,
              align = "center")
```

```{r}
epl_def_90_table <- epl_def_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_def_90_table, digits = 3, title = "Defending per 90 Minutes")
```
 
```{r}
epl_def_rank <- epl_def_main %>%
  mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 

epl_def_over_scl <- epl_def_main %>% select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% 
  select(-c(4,5,6,12,13,14)) %>%
 pivot_longer(c(2:13), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  select(-c(value)) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  mutate(`Tkl% vs Drib` = `Tkl% vs Drib` * 2,
         `TklsW` = TklsW * 2,
         Int = Int * 2,
         Clr = Clr * 2) %>%
  pivot_longer(c(2:13), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(def_over_scl = mean(value.scaled, na.rm = TRUE))

epl_def_over_rnk <- epl_def_rank %>%  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% select(-c(2:19)) %>%
  select(-c(4,5,6,12,13,14)) %>%
pivot_longer(cols = c(2:13), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  select(-c(rankVal)) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  mutate(`rank_Tkl% vs Drib` = `rank_Tkl% vs Drib` * 2,
         `rank_TklsW` = rank_TklsW * 2,
         rank_Int = rank_Int * 2,
         rank_Clr = rank_Clr * 2) %>%
  pivot_longer(c(2:13), names_to = "rankVar", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(def_over_rnk = mean(rank.scaled, na.rm = TRUE))


epl_def_over <- left_join(epl_def_over_scl, epl_def_over_rnk) %>% 
  mutate(def_over = (def_over_scl + def_over_rnk)/2) %>% 
  select(Name, def_over) %>%
  mutate(def_over.scaled = (def_over - min(def_over))/ (max(def_over) - min(def_over)),
         def_over_rank.scaled = (rank(def_over)/max(rank(def_over))))
```

 
```{r}
poss_descr <- read_csv("data/poss_descr.csv")
epl_possesion <- read_csv("data/epl_possesion.csv", skip = 1) %>%
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_possesion_90 <- read_csv("data/epl_possesion_90.csv", skip = 1) %>%
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
epl_miscellaneous <- read_csv("data/epl_miscellaneous.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_miscellaneous_90 <- read_csv("data/epl_miscellaneous_90.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
poss_extra <- epl_miscellaneous %>% select(c(Recov, `AD Won`, `AD Won%`))
poss_extra2 <- epl_passing %>% select(c(9:13))
epl_poss_comb <- bind_cols(epl_possesion, poss_extra, poss_extra2) %>%
  mutate(TotDist = TotDist + `TotDist Carried`,
         PrgDist = PrgDist + `PrgDist Carried`)

epl_poss_main <- epl_poss_comb %>% 
  select(c(1:14, 27, 29:40))

epl_poss_main_max <- epl_poss_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_poss_main_min <- epl_poss_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_poss_player <- epl_poss_main %>% filter(Name == "Joao Cancelo")

epl_poss_main_max_min <- bind_rows(epl_poss_main_max, epl_poss_main_min)

epl_poss_full <-bind_rows(epl_poss_main_max_min, epl_poss_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born))

epl_poss_full_scaled <- epl_poss_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_poss_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(Miscontrol = 1 - Miscontrol) %>%
  rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
         `Touches in Attacking 3rd` = `Touches Att 3rd`,
         `Touches in Middle 3rd` = `Touches Mid 3rd`,
         `Touches in Defensive 3rd` = `Touches Def 3rd`,
         `Touches in Defensive Penalty Area` = `Touches Def Pen`,
         Receptions = Rec,
         Targets = Targ,
         `Reception %` = `Rec%`,
         `Progressive Receptions` = `Prog Rec`,
         `% of Aerial Duels Won` = `AD Won%`,
         `Aerial Duels Won` = `AD Won`,
         `Recoveries` = Recov,
         `Progressive Distance` = PrgDist,
         `Total Distance` = TotDist,
         `Completion %` = `Cmp% Total`,
         `Attempts` = `Att Total`,
         `Completions` = `Cmp Total`)%>%
  pivot_longer(c(1:ncol(epl_poss_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Touches",
                            "Touches in Attacking Penalty Area",
                            "Touches in Attacking 3rd",
                            "Touches in Middle 3rd",
                            "Touches in Defensive 3rd",
                            "Touches in Defensive Penalty Area",
                            "Receptions",
                            "Targets",
                            "Reception %",
                            "Progressive Receptions",
                            "% of Aerial Duels Won",
                            "Aerial Duels Won",
                            "Recoveries",
                            "Miscontrol",
                            "Progressive Distance",
                            "Total Distance",
                            "Completion %",
                            "Attempts",
                            "Completions"
                            )))
  
  

poss_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_poss_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_poss_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_poss_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_poss_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_poss_player$Squad,
              align = "center")
```

```{r}
epl_poss_rank <- epl_poss_main %>%
  mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 

epl_poss_over_scl <- epl_poss_main %>% select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% 
  select(-c(3:7)) %>%
 pivot_longer(c(2:15), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  select(-c(value)) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  mutate(Miscontrol = 1- Miscontrol,
         Touches = Touches * 2,
         Recov = Recov * 2) %>%
  pivot_longer(c(2:15), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(poss_over_scl = mean(value.scaled, na.rm = TRUE))

epl_poss_over_rnk <- epl_poss_rank %>%  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% select(-c(2:20)) %>%
  select(-c(3:7)) %>%
pivot_longer(cols = c(2:15), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  select(-c(rankVal)) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  mutate(rank_Miscontrol = 1 - rank_Miscontrol,
         rank_Touches = rank_Touches * 2,
         rank_Recov = rank_Recov * 2)  %>%
  pivot_longer(c(2:15), names_to = "rankVar", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(poss_over_rnk = mean(rank.scaled, na.rm = TRUE))


epl_poss_over <- left_join(epl_poss_over_scl, epl_poss_over_rnk) %>% 
  mutate(poss_over = (poss_over_scl + poss_over_rnk)/2) %>% 
  select(Name, poss_over) %>%
  mutate(poss_over.scaled = (poss_over - min(poss_over))/ (max(poss_over) - min(poss_over)),
         poss_over_rank.scaled = (rank(poss_over)/max(rank(poss_over))))
```


```{r}
epl_poss_table <- epl_poss_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_poss_table, digits = 3, title = "Possesion")
```


```{r}
poss_90_extra <- epl_miscellaneous_90 %>% select(c(Recov, `AD Won`, `AD Won%`))
poss_90_extra2 <- epl_passing_90 %>% select(c(9:13))
epl_poss_90_comb <- bind_cols(epl_possesion_90, poss_90_extra, poss_90_extra2) %>%
  mutate(TotDist = TotDist + `TotDist Carried`,
         PrgDist = PrgDist + `PrgDist Carried`)

epl_poss_90_main <- epl_poss_90_comb %>% 
  select(c(1:14, 27, 29:40))

epl_poss_90_main_max <- epl_poss_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_poss_90_main_min <- epl_poss_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_poss_90_player <- epl_poss_90_main %>% filter(Name == "Trent Alexander-Arnold")

epl_poss_90_main_max_min <- bind_rows(epl_poss_90_main_max, epl_poss_90_main_min)

epl_poss_90_full <-bind_rows(epl_poss_90_main_max_min, epl_poss_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))

epl_poss_90_full_scaled <- epl_poss_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_poss_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(Miscontrol = 1 - Miscontrol) %>%
  rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
         `Touches in Attacking 3rd` = `Touches Att 3rd`,
         `Touches in Middle 3rd` = `Touches Mid 3rd`,
         `Touches in Defensive 3rd` = `Touches Def 3rd`,
         `Touches in Defensive Penalty Area` = `Touches Def Pen`,
         Receptions = Rec,
         Targets = Targ,
         `Reception %` = `Rec%`,
         `Progressive Receptions` = `Prog Rec`,
         `% of Aerial Duels Won` = `AD Won%`,
         `Aerial Duels Won` = `AD Won`,
         `Recoveries` = Recov,
         `Progressive Distance` = PrgDist,
         `Total Distance` = TotDist,
         `Completion %` = `Cmp% Total`,
         `Attempts` = `Att Total`,
         `Completions` = `Cmp Total`)%>%
  pivot_longer(c(1:ncol(epl_poss_90_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Touches",
                            "Touches in Attacking Penalty Area",
                            "Touches in Attacking 3rd",
                            "Touches in Middle 3rd",
                            "Touches in Defensive 3rd",
                            "Touches in Defensive Penalty Area",
                            "Receptions",
                            "Targets",
                            "Reception %",
                            "Progressive Receptions",
                            "% of Aerial Duels Won",
                            "Aerial Duels Won",
                            "Recoveries",
                            "Miscontrol",
                            "Progressive Distance",
                            "Total Distance",
                            "Completion %",
                            "Attempts",
                            "Completions"
                            )))
  
  

poss_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_poss_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_poss_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_poss_90_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_poss_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_poss_90_player$Squad,
              align = "center")

```

```{r}
epl_poss_90_table <- epl_poss_90_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_poss_90_table, digits = 3, title = "Possesion per 90 Minutes")
```


```{r}
drib_descr <- read_csv("data/drib_descr.csv")
drib_extra <- epl_miscellaneous %>% select(c(Fld))
drib_extra2 <- epl_goalandshotcreation %>% select(c(SCA_Drib))
epl_drib_comb <- bind_cols(epl_possesion, drib_extra, drib_extra2)

epl_drib_main <- epl_drib_comb %>% 
  select(c(1:8, 16:28, 33:34))

epl_drib_main_max <- epl_drib_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_drib_main_min <- epl_drib_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_drib_player <- epl_drib_main %>% filter(Name == "Joao Cancelo")

epl_drib_main_max_min <- bind_rows(epl_drib_main_max, epl_drib_main_min)

epl_drib_full <-bind_rows(epl_drib_main_max_min, epl_drib_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))

epl_drib_full_scaled <- epl_drib_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_drib_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1- Dispossessed) %>%
  rename(`Successful Dribbles` = `Succ Drib`,
         `Attempted Dribbles` = `Att Drib`,
         `Successful Dribble %` = `Succ% Drib`,
         `Dribbled Past` = `Drib Past`,
         `Shot Creating Dribbles` = `SCA_Drib`,
         `Fouled` = Fld,
         Nutmegs = Megs,
         `Carries into Penalty Area` = `Carries into PA`,
         `Carries into Attacking 3rd` = `Carries into Att 3rd`,
         `Total Distance Carried` = `TotDist Carried`,
         `Progressive Distance Carried` = `PrgDist Carried`,
         `Progressive Carries` = `Prog Carries`,
         `Carries` = Carries) %>%
  pivot_longer(c(1:ncol(epl_drib_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Successful Dribbles",
                            "Attempted Dribbles",
                            "Successful Dribble %",
                            "Dribbled Past",
                            "Shot Creating Dribbles",
                            "Fouled",
                            "Nutmegs",
                            "Dispossessed",
                            "Miscontrol",
                            "Carries into Penalty Area",
                            "Carries into Attacking 3rd",
                            "Total Distance Carried",
                            "Progressive Distance Carried",
                            "Progressive Carries",
                            "Carries"
                            )))
  

drib_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_drib_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_drib_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_drib_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_drib_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_drib_player$Squad,
              align = "center")
```
 
```{r}
epl_drib_rank <- epl_drib_main %>%
  mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 

epl_drib_over_scl <- epl_drib_main %>% select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% 
 pivot_longer(c(2:16), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  select(-c(value)) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1 - Dispossessed, 
         `Succ Drib` = `Succ Drib` * 2,
         `Drib Past` = `Drib Past` * 2,
         `PrgDist Carried` = `PrgDist Carried` * 2) %>%
  pivot_longer(c(2:16), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(drib_over_scl = mean(value.scaled, na.rm = TRUE))

epl_drib_over_rnk <- epl_drib_rank %>%  select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>% select(-c(2:16)) %>%
pivot_longer(cols = c(2:16), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  select(-c(rankVal)) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  mutate(rank_Miscontrol = 1 - rank_Miscontrol,
         rank_Dispossessed = 1 - rank_Dispossessed, 
         `rank_Succ Drib` = `rank_Succ Drib` * 2,
         `rank_Drib Past` = `rank_Drib Past` * 2,
         `rank_PrgDist Carried` = `rank_PrgDist Carried` * 2) %>%
  pivot_longer(c(2:16), names_to = "rankVar", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) %>%
  ungroup() %>%
  group_by(Name) %>%
  summarise(drib_over_rnk = mean(rank.scaled, na.rm = TRUE))


epl_drib_over <- left_join(epl_drib_over_scl, epl_drib_over_rnk) %>% 
  mutate(drib_over = (drib_over_scl + drib_over_rnk)/2) %>% 
  select(Name, drib_over) %>%
  mutate(drib_over.scaled = (drib_over - min(drib_over))/ (max(drib_over) - min(drib_over)),
         drib_over_rank.scaled = (rank(drib_over)/max(rank(drib_over))))
```
 
 
```{r}
epl_drib_table <- epl_drib_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_drib_table, digits = 3, title = "Dribbling")
```


```{r}
drib_90_extra <- epl_miscellaneous_90 %>% select(c(Fld))
drib_90_extra2 <- epl_goalandshotcreation_90 %>% select(c(SCA_Drib))
epl_drib_90_comb <- bind_cols(epl_possesion_90, drib_90_extra, drib_90_extra2)

epl_drib_90_main <- epl_drib_90_comb %>% 
  select(c(1:8, 16:28, 33:34))

epl_drib_90_main_max <- epl_drib_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>% 
  summarise_if(is.numeric, max)
epl_drib_90_main_min <- epl_drib_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4,
         Pos != "GK") %>%
  summarise_if(is.numeric, min)

epl_drib_90_player <- epl_drib_90_main %>% filter(Name == "Joao Cancelo")

epl_drib_90_main_max_min <- bind_rows(epl_drib_90_main_max, epl_drib_90_main_min)

epl_drib_90_full <-bind_rows(epl_drib_90_main_max_min, epl_drib_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))

epl_drib_90_full_scaled <- epl_drib_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_drib_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1- Dispossessed) %>%
   rename(`Successful Dribbles` = `Succ Drib`,
         `Attempted Dribbles` = `Att Drib`,
         `Successful Dribble %` = `Succ% Drib`,
         `Dribbled Past` = `Drib Past`,
         `Shot Creating Dribbles` = `SCA_Drib`,
         `Fouled` = Fld,
         Nutmegs = Megs,
         `Carries into Penalty Area` = `Carries into PA`,
         `Carries into Attacking 3rd` = `Carries into Att 3rd`,
         `Total Distance Carried` = `TotDist Carried`,
         `Progressive Distance Carried` = `PrgDist Carried`,
         `Progressive Carries` = `Prog Carries`,
         `Carries` = Carries) %>%
  pivot_longer(c(1:ncol(epl_drib_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Successful Dribbles",
                            "Attempted Dribbles",
                            "Successful Dribble %",
                            "Dribbled Past",
                            "Shot Creating Dribbles",
                            "Fouled",
                            "Nutmegs",
                            "Dispossessed",
                            "Miscontrol",
                            "Carries into Penalty Area",
                            "Carries into Attacking 3rd",
                            "Total Distance Carried",
                            "Progressive Distance Carried",
                            "Progressive Carries",
                            "Carries"
                            )))
  
  

drib_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_drib_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_drib_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_drib_90_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_drib_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_drib_90_player$Squad,
              align = "center")
```

```{r}
epl_drib_90_table <- epl_drib_90_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_drib_90_table, digits = 3, title = "Dribbling per 90 Minutes")
```


```{r}
epl_goalkeeper <- read_csv("data/epl_goalkeeper.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))

epl_goalkeeper_90 <- read_csv("data/epl_goalkeeper_90.csv", skip = 1) %>% 
  select(-c(Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
epl_goalkeeperadvanced <- read_csv("data/epl_goalkeeperadvanced.csv", skip = 1) %>% 
  select(-c(3, Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
epl_goalkeeperadvanced

epl_goalkeeperadvanced_90 <- read_csv("data/epl_goalkeeperadvanced_90.csv", skip = 1) %>% 
  select(-c(Matches)) %>%
  separate(Nation, into = c("irrel", "Nation"), sep = " ") %>%
  select(-c(irrel))
```

```{r}
epl_gk_comb <- left_join(epl_goalkeeper, epl_goalkeeperadvanced) %>% 
  rename(`Save%` = `Save%...17`,
         `PK Save%` = `Save%...27`)
epl_gk_90_comb <- left_join(epl_goalkeeper_90, epl_goalkeeperadvanced_90)  %>% 
  rename(`Save%` = `Save%...16`,
         `PK Save%` = `Save%...26`)
```

```{r}
epl_gk_dist_main <- epl_gk_comb %>% 
  select(c(1:11, 34:43, 47, 49))

epl_gk_dist_main_max <- epl_gk_dist_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>% 
  summarise_if(is.numeric, max)
epl_gk_dist_main_min <- epl_gk_dist_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>%
  summarise_if(is.numeric, min)

epl_gk_dist_player <- epl_gk_dist_main %>% filter(Name == "Nick Pope")

epl_gk_dist_main_max_min <- bind_rows(epl_gk_dist_main_max, epl_gk_dist_main_min)

epl_gk_dist_full <-bind_rows(epl_gk_dist_main_max_min, epl_gk_dist_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, Starts, Min, MP))

epl_gk_dist_full_scaled <- epl_gk_dist_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_gk_dist_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  pivot_longer(c(1:ncol(epl_gk_dist_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Pass Att",
                            "Pass AvgLen",
                            "Launched Cmp",
                            "Launched Att",
                            "Launched Cmp%",
                            "Launch%",
                            "GK Launch%",
                            "Gk AvgLen",
                            "GK Att",
                            "AvgDist",
                            "#OPA/90",
                            "#OPA",
                            "Throws")))

gk_dist_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_gk_dist_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_gk_dist_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_gk_dist_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_gk_dist_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_gk_dist_player$Squad,
              align = "center")
```

```{r}
epl_gk_dist_table <- epl_gk_dist_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_gk_dist_table, digits = 3, title = "Goalkeeping Distribution")
```


```{r}
epl_gk_dist_90_main <- epl_gk_90_comb %>% 
  select(c(1:11, 34:43, 47))

epl_gk_dist_90_main_max <- epl_gk_dist_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>% 
  summarise_if(is.numeric, max)
epl_gk_dist_90_main_min <- epl_gk_dist_90_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>%
  summarise_if(is.numeric, min)

epl_gk_dist_90_player <- epl_gk_dist_90_main %>% filter(Name == "Nick Pope")

epl_gk_dist_90_main_max_min <- bind_rows(epl_gk_dist_90_main_max, epl_gk_dist_90_main_min)

epl_gk_dist_90_full <-bind_rows(epl_gk_dist_90_main_max_min, epl_gk_dist_90_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, Starts, Min, MP))

epl_gk_dist_90_full_scaled <- epl_gk_dist_90_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_gk_dist_90_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  pivot_longer(c(1:ncol(epl_gk_dist_90_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Pass Att",
                            "Pass AvgLen",
                            "Launched Cmp",
                            "Launched Att",
                            "Launched Cmp%",
                            "Launch%",
                            "GK Launch%",
                            "Gk AvgLen",
                            "GK Att",
                            "#OPA",
                            "Throws")))

gk_dist_90_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_gk_dist_90_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_gk_dist_90_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_gk_dist_90_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_gk_dist_90_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_gk_dist_90_player$Squad,
              align = "center")
```

```{r}
epl_gk_dist_90_table <- epl_gk_dist_90_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_gk_dist_90_table, digits = 3, title = "Goalkeeping Distribution per 90 Minutes")
```

```{r}
epl_gk_base_main <- epl_gk_comb %>% 
  select(c(1:12, 14:16, 20, 21, 30:32, 44:46, 47, 49))

epl_gk_base_main_max <- epl_gk_base_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>% 
  summarise_if(is.numeric, max)
epl_gk_base_main_min <- epl_gk_base_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>%
  summarise_if(is.numeric, min)

epl_gk_base_player <- epl_gk_base_main %>% filter(Name == "Ederson")

epl_gk_base_main_max_min <- bind_rows(epl_gk_base_main_max, epl_gk_base_main_min)

epl_gk_base_full <-bind_rows(epl_gk_base_main_max_min, epl_gk_base_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, Starts, Min))

epl_gk_base_full_scaled <- epl_gk_base_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_gk_base_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(GA = 1 - GA) %>%
  pivot_longer(c(1:ncol(epl_gk_base_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("GA",
                            "SoTA",
                            "Saves", 
                            "Save%",
                            "PSxG",
                            "PSxG/SoT",
                            "PSxG+/-",
                            "Opp Cross",
                            "Stp Cross",
                            "Stp% Cross",
                            "#OPA",
                            "#OPA/90",
                            "AvgDist",
                            "CS%",
                            "CS",
                            "MP")))
  

gk_base_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_gk_base_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_gk_base_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_gk_base_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_gk_base_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_gk_base_player$Squad,
              align = "center")
```

```{r}
epl_gk_base_table <- epl_gk_base_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_gk_base_table, digits = 3, title = "Goalkeeping")
```


```{r}
epl_gk_90_base_main <- epl_gk_90_comb %>% 
  select(c(1:12, 14:16, 20, 21, 30:32, 44:46, 47))

epl_gk_90_base_main_max <- epl_gk_90_base_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>% 
  summarise_if(is.numeric, max)
epl_gk_90_base_main_min <- epl_gk_90_base_main %>% 
  drop_na() %>%
  filter(`90s` >= 4) %>%
  summarise_if(is.numeric, min)

epl_gk_90_base_player <- epl_gk_90_base_main %>% filter(Name == "Nick Pope")

epl_gk_90_base_main_max_min <- bind_rows(epl_gk_90_base_main_max, epl_gk_90_base_main_min)

epl_gk_90_base_full <-bind_rows(epl_gk_90_base_main_max_min, epl_gk_90_base_player) %>%
  select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, Starts, Min))

epl_gk_90_base_full_scaled <- epl_gk_90_base_full %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_gk_90_base_full)), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  mutate(GA = 1 - GA) %>%
  pivot_longer(c(1:ncol(epl_gk_90_base_full) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("GA",
                            "SoTA",
                            "Saves", 
                            "Save%",
                            "PSxG",
                            "PSxG/SoT",
                            "PSxG+/-",
                            "Opp Cross",
                            "Stp Cross",
                            "Stp% Cross",
                            "#OPA",
                            "#OPA/90",
                            "CS%",
                            "CS",
                            "MP")))
  

gk_90_base_plot <- highchart() %>%
  hc_chart(polar = TRUE, backgroundColor = "lightgrey") %>%
  hc_add_series(data = epl_gk_90_base_full_scaled,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(pointFormat = "{point.variable}"),
                color = "lightgrey",
                animation = FALSE,
                showInLegend = FALSE) %>%  
  hc_add_series(data = epl_gk_90_base_full_scaled, 
                mapping = hcaes(x = variable, y = value.scaled), 
                type = "column",
                color = rgb(0,255,100, maxColorValue = 255),
                tooltip = list(pointFormat = "{point.variable}: {point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "darkgrey",
                borderWidth = .2) %>%
  hc_xAxis(categories = epl_gk_90_base_full_scaled$variable) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_title(text = epl_gk_90_base_player$Name,
           align = "center") %>%
  hc_subtitle(text = epl_gk_90_base_player$Squad,
              align = "center")
```

```{r}
epl_gk_90_base_table <- epl_gk_90_base_full_scaled %>% select(variable, value, value.scaled) %>%
  rename(Stat = variable,
         Value = value,
         `Scaled Value` = value.scaled)
kable(epl_gk_90_base_table, digits = 3, title = "Goalkeeping per 90 Minutes")
```


```{r}
library(purrr)

epl_stand_rank <- epl_standard %>%
  mutate(across(c(8:13,17,18), min_rank, .names = "rank_{.col}")) 


epl_stand_over_rnk <- epl_stand_rank %>% select(-c(Age, Squad, Pos, Nation, Rk, Born)) %>% select(-c(8,9,10,13:17)) %>%
pivot_longer(cols = c(2:17), names_to = "rankVar", values_to = "rankVal") %>%
  group_by(rankVar) %>%
  mutate(rank.scaled = (rankVal/ (max(rankVal, na.rm = TRUE)))) %>%
  pivot_wider(names_from = rankVar, values_from = rank.scaled) %>%
  unchop(everything()) %>%
  pivot_longer(c(3:18), names_to = "variable", values_to = "rank.scaled") %>%
  filter(!is.na(rank.scaled)) 


epl_stand_over_scl <- epl_standard %>% 
  select(2, 8,9,10,11,12,13,17,18) %>% 
  pivot_longer(c(2:9), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value, na.rm = TRUE)) / (max(value, na.rm = TRUE) - min(value, na.rm = TRUE))) %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  unchop(everything()) %>%
  pivot_longer(c(3:10), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) 

epl_stand_over <- left_join(epl_stand_over_scl, epl_stand_over_rnk) %>% 
  group_by(Name, variable) %>%
  summarise(scaled = (value.scaled + rank.scaled)/2) 


  
epl_overalls <- reduce(list(
            epl_shoot_over,
            epl_pass_over,
            epl_def_over,
            epl_poss_over,
            epl_drib_over),
       left_join, by = "Name") 

  
  epl_overalls_plot <- epl_overalls %>%
  rename(Shooting = shoot_over,
         Passing = pass_over,
         Defending = def_over,
         Possession = poss_over,
         Dribbling = drib_over) %>%
  select(Name,  Defending, Possession, Dribbling, Passing, Shooting) %>%
  pivot_longer(c(2:6), names_to = "variable", values_to = "scaled") %>%
    arrange(match(variable,(c("Passing", "Dribbling", "Possession", "Defending", "Shooting"))))
  
shooter <- epl_shoot_over %>% mutate(rankValMax = n()) %>%
  mutate(Ranking = ranker(1 - shoot_over_rank.scaled, rankValMax)) %>% slice(1,2) %>%
  select(Name,2,6) %>% mutate(Category = "Shooting") %>% rename(Scaling = shoot_over) %>%
  select(Name,4,2,3)
passer <- epl_pass_over %>% mutate(rankValMax = n()) %>%
  mutate(Ranking = ranker(1 - pass_over_rank.scaled, rankValMax)) %>% slice(1,2) %>%
  select(Name,2,6) %>% mutate(Category = "Passing") %>% rename(Scaling = pass_over) %>%
  select(Name,4,2,3)
defender <- epl_def_over %>% mutate(rankValMax = n()) %>%
  mutate(Ranking = ranker(1 - def_over_rank.scaled, rankValMax)) %>% slice(1,2) %>%
  select(Name, 2,6) %>% mutate(Category = "Defending") %>% rename(Scaling = def_over) %>%
  select(Name,4,2,3)
dribbler <- epl_drib_over %>% mutate(rankValMax = n()) %>%
  mutate(Ranking = ranker(1 - drib_over_rank.scaled, rankValMax)) %>% slice(1,2) %>%
  select(Name, 2,6) %>% mutate(Category = "Dribbling") %>% rename(Scaling = drib_over) %>%
  select(Name,4,2,3)
possesser <- epl_poss_over %>% mutate(rankValMax = n()) %>%
  mutate(Ranking = ranker(1 - poss_over_rank.scaled, rankValMax)) %>% slice(1,2) %>%
  select(Name, 2,6) %>% mutate(Category = "Possession") %>% rename(Scaling = poss_over) %>%
  select(Name,4,2,3)


overall_table <- reduce(list(shooter, passer, defender, dribbler, possesser), bind_rows) %>%
   group_by(Category) %>%
        mutate(maxes = max(Scaling)) %>%
        group_by(Name, Category) %>%
        mutate(row.color = if(Scaling == maxes){"#488f31"} else{"#de425b"}) %>%
  select(-c(maxes)) %>%
  pivot_wider(names_from = Name, values_from = c(Ranking, Scaling, row.color), values_fn = list, names_sep = " ") %>%
  unchop(everything()) %>%
  select(6,2,4,1,5,3,7)

datatable(overall_table, options = list(pageLength = 25,
                               initComplete =JS(
      "function(settings, json) {",
      "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
      "}"),
      columnDefs = list(list(className = 'dt-center', targets = "_all"),
                      list(targets = c(1,7), visible = F)))) %>% 
  formatStyle(c(2,3),1,
                    backgroundColor = styleEqual(sort(unique(overall_table[[1]])),
                                                 sort(unique(overall_table[[1]])))) %>%
        formatStyle(c(5,6),7,
                    backgroundColor = styleEqual(sort(unique(overall_table[[7]])),
                                                 sort(unique(overall_table[[7]])))) %>%
  formatStyle(columns = c(1:NCOL(overall_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
  formatRound(c(3,5), digits = 3)


mutate(oppRank = ranker(1 - rank.scaled, rankValMax))

overall_vars <- list("Passing", "Dribbling", "Possession", "Defending", "Shooting")

highchart() %>%
  hc_chart(polar = TRUE,
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(
      data = epl_overalls_plot %>% filter(Name == "Joao Cancelo"),
      mapping = hcaes(x = variable, y = scaled),
                type = "area",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.rank}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "black",
                borderWidth = .15,
                color = "#FFCC00",
                ) %>%
  # hc_add_series(data = shooting_descr,
  #               mapping = hcaes(x = variable, y = 1),
  #               type = "point",
  #               tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
  #               animation = FALSE,
  #               showInLegend = FALSE,
  #               color = "white"
  #               ) %>%
  hc_xAxis(categories = overall_vars[1:5],
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_subtitle(text = "OVERALL",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  
```



```{r}

library(cowplot)
ggplot() + theme_void() +
  theme(panel.background = element_rect("#003366")) +
draw_image(paste(epl_comb %>% slice(1) %>% select(player_face_url)), scale = .7, x = -.29, y = -.2) +
  draw_image(paste(epl_comb %>% slice(2) %>% select(player_face_url)), scale = .7, x = 0.30, y = -.2) +
  draw_image(paste(epl_comb %>% slice(1) %>% select(nation_flag_url)), scale = .19, x = -.40, y = .24) +
  draw_image(paste(epl_comb %>% slice(1) %>% select(club_logo_url)), scale = .21, x = -.19, y = .23) +
  draw_image(paste(epl_comb %>% slice(2) %>% select(nation_flag_url)), scale = .2, x = .29, y = .45) +
  draw_image(paste(epl_comb %>% slice(2) %>% select(club_logo_url)), scale = .23, x = .29, y = .23)
```



```{r}
player_table <- left_join(epl_players %>% filter(Name == "Max Aarons") %>%
  select(1,12,15,2,8,10,11,16,6,7,13) %>% mutate(value_eur = as.character(value_eur)),
epl_standard %>% select(2, MP, Starts, Min, `90s`, Gls, Ast)) %>%
  select(1,2,3,11,4:8, MP, Starts, Min, `90s`, Gls, Ast, 9,10) %>%
  rename(`Club` = club_name,
         `Jersey Number` = club_jersey_number,
         Nationality = nationality_name,
         Positions = player_positions,
         Age = age,
         `Height(cm)` = height_cm,
         `Weight(kg)` = weight_kg,
         `Preferred Foot` = preferred_foot,
         `Matches Played` = MP,
         `Minutes` = Min,
         Goals = Gls,
         Assists = Ast,
         `Value(euros)` = value_eur,
         `Wage(euros)` = wage_eur) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(everything(), names_to = "Stat", values_to = "Value") 
player_table2 <- left_join(epl_players %>% filter(Name == "Harry Kane") %>%
  select(1,12,15,2,8,10,11,16,6,7,13) %>% mutate(value_eur = as.character(value_eur)),
epl_standard %>% select(2, MP, Starts, Min, `90s`, Gls, Ast)) %>%
  select(1,2,3,11,4:8, MP, Starts, Min, `90s`, Gls, Ast, 9,10) %>%
  rename(`Club` = club_name,
         `Jersey Number` = club_jersey_number,
         Nationality = nationality_name,
         Positions = player_positions,
         Age = age,
         `Height(cm)` = height_cm,
         `Weight(kg)` = weight_kg,
         `Preferred Foot` = preferred_foot,
         `Matches Played` = MP,
         `Minutes` = Min,
         Goals = Gls,
         Assists = Ast,
         `Value(euros)` = value_eur,
         `Wage(euros)` = wage_eur) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(everything(), names_to = "Stat", values_to = "Value")

library(janitor)
full_join(player_table, player_table2, by = c("Stat" = "Stat")) %>%
  row_to_names(1) %>%
  select(2,1,3)

datatable(player_table,  options = list(dom = 't', pageLength = 25), rownames = FALSE)
```



```{r}
library(shiny)
library(shinyWidgets)
library(shinypanel)
library(shinyjs)
library(DT)

ui <- fluidPage(
  setBackgroundColor(
    color = c("#FFFFFF", "#FFCC00"),
    gradient = "radial",
    direction = c("top", "right")
  ),
  sidebarLayout(
    sidebarPanel(
      setBackgroundColor(
    color = c("#FFCC00")
  ),
     selectizeInput("playerchoice",
                     label = "Choose a Player",
                     choices = levels(factor(epl_standard$Name))),
     useShinyjs(),
     checkboxInput("check2nd", "Add second player:", FALSE),
     selectizeInput("playerchoice2",
                             label = "Choose a Player",
                             choices = levels(factor(epl_standard$Name))),
     plotOutput("playerImage"),
     DT::dataTableOutput("playerTable")
  ),
  mainPanel(
    titlePanel(h1("English Premier League Player Advanced Statistics Visualizer",align = "center")),
    # submitButton("Update", icon("refresh"), width = 1175),
    prettyCheckbox("check90", "per 90 min", FALSE, inline = TRUE, bigger = TRUE, thick = TRUE),
    prettyCheckbox("checkPOS", "position", FALSE, inline = TRUE, bigger = TRUE, thick  = TRUE),
    prettyCheckbox("checkTouch", "per 100 touches", FALSE, inline = TRUE, bigger = TRUE, thick = TRUE),
    prettyCheckbox("checkRank", "rank", FALSE, inline = TRUE, bigger = TRUE, thic = TRUE),
    prettyCheckbox("checkColAr", "area", TRUE, inline = TRUE, bigger = TRUE, thick = TRUE),
    sliderInput("value90s", "Compared to minimum 90s played:", min = 0, max = 25, value = 4, width = 1175),
    tabsetPanel(
      tabPanel("Overall",
               highchartOutput("overallPlot", height = "80vh"),
               DT::dataTableOutput("overallTable")),
      tabPanel("Shooting", 
               highchartOutput("shootPlot", height = "80vh"),
               DT::dataTableOutput("shootTable")),
      tabPanel("Passing",
               highchartOutput("passPlot", height = "80vh"),
               DT::dataTableOutput("passTable")),
      tabPanel("Dribbling",
               highchartOutput("dribPlot", height = "80vh"),
               DT::dataTableOutput("dribTable")),
      tabPanel("Defending",
               highchartOutput("defPlot", height = "80vh"),
               DT::dataTableOutput("defTable")),
      tabPanel("Possession",
               highchartOutput("possPlot", height = "80vh"),
               DT::dataTableOutput("possTable"))
    ))
  ) 
)

server <- function(input, output, session) {
  
  output$playerImage <- renderPlot({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check2nd == FALSE) {
      ggplot() + theme_void() +
      theme(panel.background = element_rect("#003366")) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(player_face_url)), scale = .9, x = 0.16, y = -.1) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(nation_flag_url)), scale = .35, x = -.3, y = .35) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(club_logo_url)), scale = .45, x = -.3, y = -.12)
    }
    else {
      ggplot() + theme_void() +
      theme(panel.background = element_rect("#003366")) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(player_face_url)), scale = .7, x = -.29, y = -.22) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice2) %>% select(player_face_url)), scale = .7, x = 0.30, y = -.22) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(nation_flag_url)), scale = .18, x = -.31, y = .43) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice) %>% select(club_logo_url)), scale = .21, x = -.31, y = .21) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice2) %>% select(nation_flag_url)), scale = .18, x = .29, y = .43) +
      draw_image(paste(epl_comb %>% filter(Name == input$playerchoice2) %>% select(club_logo_url)), scale = .21, x = .29, y = .21)
    }
  })
  
  output$playerTable <- DT::renderDataTable({
    if (input$check2nd == FALSE) {
    player_table <- left_join(epl_players %>% filter(Name == input$playerchoice) %>%
      select(1,12,15,2,8,10,11,16,6,7,13) %>% mutate(value_eur = as.character(value_eur)),
    epl_standard %>% select(2, MP, Starts, Min, `90s`, Gls, Ast)) %>%
      select(1,2,3,11,4:8, MP, Starts, Min, `90s`, Gls, Ast, 9,10) %>%
      rename(`Club` = club_name,
             `Jersey Number` = club_jersey_number,
             Nationality = nationality_name,
             Positions = player_positions,
             Age = age,
             `Height(cm)` = height_cm,
             `Weight(kg)` = weight_kg,
             `Preferred Foot` = preferred_foot,
             `Matches Played` = MP,
             `Minutes` = Min,
             Goals = Gls,
             Assists = Ast,
             `Value(euros)` = value_eur,
             `Wage(euros)` = wage_eur) %>%
      mutate(across(everything(), as.character)) %>%
      pivot_longer(everything(), names_to = "Stat", values_to = "Value") %>%
      row_to_names(1)
    
    datatable(player_table,  options = list(dom = 't', pageLength = 25), rownames = FALSE)
    }
    else {
      player_table1 <- left_join(epl_players %>% filter(Name == input$playerchoice) %>%
        select(1,12,15,2,8,10,11,16,6,7,13) %>% mutate(value_eur = as.character(value_eur)),
      epl_standard %>% select(2, MP, Starts, Min, `90s`, Gls, Ast)) %>%
        select(1,2,3,11,4:8, MP, Starts, Min, `90s`, Gls, Ast, 9,10) %>%
        rename(`Club` = club_name,
               `Jersey Number` = club_jersey_number,
               Nationality = nationality_name,
               Positions = player_positions,
               Age = age,
               `Height(cm)` = height_cm,
               `Weight(kg)` = weight_kg,
               `Preferred Foot` = preferred_foot,
               `Matches Played` = MP,
               `Minutes` = Min,
               Goals = Gls,
               Assists = Ast,
               `Value(euros)` = value_eur,
               `Wage(euros)` = wage_eur) %>%
        mutate(across(everything(), as.character)) %>%
        pivot_longer(everything(), names_to = "Stat", values_to = "Value") 
      player_table2 <- left_join(epl_players %>% filter(Name == input$playerchoice2) %>%
        select(1,12,15,2,8,10,11,16,6,7,13) %>% mutate(value_eur = as.character(value_eur)),
        epl_standard %>% select(2, MP, Starts, Min, `90s`, Gls, Ast)) %>%
        select(1,2,3,11,4:8, MP, Starts, Min, `90s`, Gls, Ast, 9,10) %>%
        rename(`Club` = club_name,
               `Jersey Number` = club_jersey_number,
               Nationality = nationality_name,
               Positions = player_positions,
               Age = age,
               `Height(cm)` = height_cm,
               `Weight(kg)` = weight_kg,
               `Preferred Foot` = preferred_foot,
               `Matches Played` = MP,
               `Minutes` = Min,
               Goals = Gls,
               Assists = Ast,
               `Value(euros)` = value_eur,
               `Wage(euros)` = wage_eur) %>%
        mutate(across(everything(), as.character)) %>%
        pivot_longer(everything(), names_to = "Stat", values_to = "Value") 
      playertable <- full_join(player_table1, player_table2, by = c("Stat" = "Stat")) %>%
        row_to_names(1) %>%
        select(2,1,3)
    datatable(playertable,  options = list(dom = 't', pageLength = 25), rownames = FALSE)
    }
  })
  
  ranker = function(x, den) {paste0(round(x*den) + 1, "/", den)}
  
  observeEvent(input$check2nd, {
    if (input$check2nd == TRUE) {
      enable("playerchoice2")
    } else {disable("playerchoice2")}
  })
  
  
  ## OVERALL
  epl_overalls_plot <- reactive({
    epl_overalls %>%
    rename(Shooting = shoot_over,
           Passing = pass_over,
           Defending = def_over,
           Possession = poss_over,
           Dribbling = drib_over) %>%
    select(Name,  Defending, Possession, Dribbling, Passing, Shooting) %>%
    pivot_longer(c(2:6), names_to = "variable", values_to = "scaled") %>%
      arrange(match(variable,(c("Passing", "Dribbling", "Possession", "Defending", "Shooting"))))
  })
  overall_table <- reactive ({
    if (input$check2nd == FALSE) {
      shooter <- epl_shoot_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - shoot_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice) %>%
        select(2,6) %>% mutate(Category = "Shooting") %>% rename(Scaling = shoot_over) %>%
        select(3,1,2)
      passer <- epl_pass_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - pass_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice) %>%
        select(2,6) %>% mutate(Category = "Passing") %>% rename(Scaling = pass_over) %>%
        select(3,1,2)
      defender <- epl_def_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - def_over_rank.scaled, rankValMax)) %>% filter(Name== input$playerchoice) %>%
        select(2,6) %>% mutate(Category = "Defending") %>% rename(Scaling = def_over) %>%
        select(3,1,2)
      dribbler <- epl_drib_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - drib_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice) %>%
        select(2,6) %>% mutate(Category = "Dribbling") %>% rename(Scaling = drib_over) %>%
        select(3,1,2)
      possesser <- epl_poss_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - poss_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice) %>%
        select(2,6) %>% mutate(Category = "Possession") %>% rename(Scaling = poss_over) %>%
        select(3,1,2)
      
      reduce(list(shooter, passer, defender, dribbler, possesser), bind_rows) %>%
        mutate(row.color = case_when(Scaling <= 0.1 ~ "#de425b",
                                     Scaling <= 0.2 & Scaling > 0.1 ~ "#ea6e79",
                                     Scaling <= 0.3 & Scaling > 0.2 ~ "#f49399",
                                     Scaling <= 0.4 & Scaling > 0.3 ~ "#f49399",
                                     Scaling <= 0.5 & Scaling > 0.4 ~ "#ffdbdc",
                                     Scaling <= 0.6 & Scaling > 0.5 ~ "#d4e7e0",
                                     Scaling <= 0.7 & Scaling > 0.6 ~ "#a8cfc2",
                                     Scaling <= 0.8 & Scaling > 0.7 ~ "#7db7a4",
                                     Scaling <= 0.9 & Scaling > 0.8 ~ "#4e9f88",
                                     Scaling > 0.9 ~ "#488f31"))
    }
    else {
      shooter <- epl_shoot_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - shoot_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        select(Name,2,6) %>% mutate(Category = "Shooting") %>% rename(Scaling = shoot_over) %>%
        select(Name,4,2,3)
      passer <- epl_pass_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - pass_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        select(Name,2,6) %>% mutate(Category = "Passing") %>% rename(Scaling = pass_over) %>%
        select(Name,4,2,3)
      defender <- epl_def_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - def_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        select(Name, 2,6) %>% mutate(Category = "Defending") %>% rename(Scaling = def_over) %>%
        select(Name,4,2,3)
      dribbler <- epl_drib_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - drib_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        select(Name, 2,6) %>% mutate(Category = "Dribbling") %>% rename(Scaling = drib_over) %>%
        select(Name,4,2,3)
      possesser <- epl_poss_over %>% mutate(rankValMax = n()) %>%
        mutate(Ranking = ranker(1 - poss_over_rank.scaled, rankValMax)) %>% filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        select(Name, 2,6) %>% mutate(Category = "Possession") %>% rename(Scaling = poss_over) %>%
        select(Name,4,2,3)
      
      
      reduce(list(shooter, passer, defender, dribbler, possesser), bind_rows) %>%
         group_by(Category) %>%
              mutate(maxes = max(Scaling)) %>%
              group_by(Name, Category) %>%
              mutate(row.color = if(Scaling == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes)) %>%
        pivot_wider(names_from = Name, values_from = c(Ranking, Scaling, row.color), values_fn = list, names_sep = " ") %>%
        unchop(everything()) %>%
        select(6,2,4,1,5,3,7)
    }
 })

  output$overallTable <- DT::renderDataTable({ 
    if (input$check2nd == FALSE) {
      datatable(overall_table(), options = list(dom = 't',pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = 4, visible = F)))) %>% 
        formatStyle(c("Category","Scaling","Ranking"), "row.color", backgroundColor = styleEqual(sort(unique(overall_table()$row.color)),
                                                                                                 sort(unique(overall_table()$row.color)))) %>%
        formatStyle(columns = c(1:NCOL(overall_table())),'font-size' = '25px',fontWeight = 'Bold') %>%
        formatRound(c("Scaling"), digits = 3)
    }
    else {
      datatable(overall_table(), options = list(dom = 't',pageLength = 25,
                               initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,7), visible = F)))) %>% 
        formatStyle(c(2,3),1,
                          backgroundColor = styleEqual(sort(unique(overall_table()[[1]])),
                                                       sort(unique(overall_table()[[1]])))) %>%
              formatStyle(c(5,6),7,
                          backgroundColor = styleEqual(sort(unique(overall_table()[[7]])),
                                                       sort(unique(overall_table()[[7]])))) %>%
        formatStyle(columns = c(1:NCOL(overall_table())),'font-size' = '25px',fontWeight = 'Bold') %>%
        formatRound(c(3,5), digits = 3)
    }
  })
  
  
  
  overall_plot <- reactive({
    if(input$check2nd == FALSE) {
    highchart() %>%
    hc_chart(polar = TRUE,
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(
        data = epl_overalls_plot() %>% filter(Name == input$playerchoice),
        mapping = hcaes(x = variable, y = scaled),
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.rank}"),
                  showInLegend = FALSE,
                  pointWidth = 0.5,
                  borderColor = "black",
                  borderWidth = .15,
                  color = "#FFCC00",
                  ) %>%
    # hc_add_series(data = shooting_descr,
    #               mapping = hcaes(x = variable, y = 1),
    #               type = "point",
    #               tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
    #               animation = FALSE,
    #               showInLegend = FALSE,
    #               color = "white"
    #               ) %>%
    hc_xAxis(categories = overall_vars[1:5],
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_subtitle(text = "OVERALL",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
    }
    else {
      highchart() %>%
      hc_chart(polar = TRUE,
               backgroundColor = "#003366",
               gridWidth = 2,
               gridLineColor = "white",
               style = list(fontSize = 30)
               ) %>%
      hc_add_theme(hc_theme_smpl()) %>%
        hc_colors(c('#FFFFFF','#FFCC00')) %>%
      hc_add_series(
          data = epl_overalls_plot() %>% filter(Name == input$playerchoice | Name == input$playerchoice2),
          mapping = hcaes(x = variable, y = scaled, group = Name),
                    type = if(input$checkColAr == FALSE){"column"} else{"area"},
                    tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.rank}"),
                    showInLegend = TRUE,
                    pointWidth = 0.5,
                    borderColor = "black",
                    borderWidth = .15
                    ) %>%
      # hc_add_series(data = shooting_descr,
      #               mapping = hcaes(x = variable, y = 1),
      #               type = "point",
      #               tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
      #               animation = FALSE,
      #               showInLegend = FALSE,
      #               color = "white"
      #               ) %>%
      hc_xAxis(categories = overall_vars[1:5],
               labels = list(style = list(color = "white", fontSize = 12))) %>%
      hc_yAxis(visible = FALSE,
               max = 1,
               tickPixelInterval = 0.05
               ) %>%
      hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
      hc_subtitle(text = "OVERALL",
                  align = "center",
                  style = list(color = "white"),
                  margin = 50) 
    }
  })
  output$overallPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    overall_plot()
  })
  

  ##SHOOTING
  epl_shooting <- reactive({
    if (input$checkTouch == FALSE) {
      epl_shooting2
    }
    else {
      shooting_touches
    }
  })
  
  epl_shooting_90 <- reactive({
    if (input$checkTouch == FALSE) {
      epl_shooting_902
    }
    else {
      shooting_touches_90
    }
  })
  
  epl_shooting_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_shooting() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_shooting() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_shooting_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_shooting() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_shooting() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_shooting_max_min <- reactive({
    bind_rows(epl_shooting_max(), epl_shooting_min())
    })
  epl_shoot_player <- reactive({
      epl_shooting() %>% filter(Name == input$playerchoice)
    })
  epl_shoot_full <- reactive({
    bind_rows(epl_shooting_max_min(), epl_shoot_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'))
    })
  epl_shoot_full_scaled <- reactive({ 
    epl_shoot_full() %>% 
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_shoot_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    #mutate(`G-xG` = 1 - `G-xG`,
    #       `np:G-xG` = 1- `np:G-xG`) %>% 
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(1:ncol(epl_shoot_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals")))
  })
  shooting_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_shoot_full_scaled()
    }
    else {
      data = epl_shooting_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "black",
                borderWidth = .15,
                color = "#FFCC00",
                ) %>%
  hc_add_series(data = shooting_descr %>% filter(variable != 'Goals - xGoals' & variable != 'Non Penalty: Goals - xGoals'),
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_shoot_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_subtitle(text = "SHOOTING",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  epl_shoot_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_shooting_rank_max_long <- epl_shooting_rank_max() %>% select(19:28) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    shoot_table <- left_join(epl_shoot_full_scaled(), epl_shooting_rank_final()) %>%
      bind_cols(epl_shooting_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(shoot_table, options = list(dom = 't',pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(shoot_table$row.color)), 
                                               sort(unique(shoot_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(shoot_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    }
    else {
      epl_shooting_2_rank_max_long <- epl_shooting_2_rank_max() %>% 
        select(19:28) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:12), 2)) %>%
        arrange(rankVarMax)
      epl_shoot_2_table <- epl_shoot_2_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_shooting_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_shooting_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
          arrange(match(Stat, c("Goals",
                                    "Shots",
                                    "Goals/Shot",
                                    "Shots on Target",
                                    "Shots on Target%",
                                    "Goals/Shot on Target",
                                    "xGoals",
                                    "Non Penalty xGoals",
                                    #"Goals - xGoals",
                                    #"Non Penalty: Goals - xGoals",
                                    "Non Penalty: xGoals/Shot",
                                    "Distance"
                                    ))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_shoot_2_table, options = list(dom = 't',pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_shoot_2_table[[1]])),
                                                 sort(unique(epl_shoot_2_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_shoot_2_table[[9]])),
                                                 sort(unique(epl_shoot_2_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_shoot_2_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
  
  ## Shooting 90
  epl_shooting_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_shooting_90() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_shooting_90() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_shooting_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_shooting_90() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_shooting_90() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_shooting_90_max_min <- reactive({
    bind_rows(epl_shooting_90_max(), epl_shooting_90_min())
    })
  epl_shoot_90_player <- reactive({
    epl_shooting_90() %>% filter(Name == input$playerchoice)
  })
  epl_shoot_90_full <- reactive({
    bind_rows(epl_shooting_90_max_min(), epl_shoot_90_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK))
  })
  epl_shoot_90_full_scaled <- reactive({
  epl_shoot_90_full() %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_shoot_90_full())), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  #mutate(`G-xG` = 1 - `G-xG`,
  #       `np:G-xG` = 1- `np:G-xG`) %>%
  rename(Goals = Gls,
         Shots = Sh,
         `Shots on Target` = SoT,
         `Shots on Target%` = `SoT%`,
         `Goals/Shot` = `G/Sh`,
         `Goals/Shot on Target` = `G/SoT`,
         Distance = Dist,
         `Non Penalty: xGoals/Shot` = `npxG/Sh`,
         #`Non Penalty: Goals - xGoals` = `np:G-xG`,
         #`Goals - xGoals` = `G-xG`,
         `Non Penalty xGoals` = npxG,
         `xGoals` = xG) %>%
  pivot_longer(c(1:ncol(epl_shoot_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              #"Non Penalty: Goals - xGoals",
                              #"Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals"))) 
  })
  shooting_90_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE, 
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(data = shooting_descr %>% filter(variable != 'Goals - xGoals' & variable != 'Non Penalty: Goals - xGoals'),
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                color = "white",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%   
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_shoot_90_full_scaled()
    }
    else {
      data = epl_shooting_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                color = "#FFCC00",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "black",
                borderWidth = .15) %>%
  hc_xAxis(categories = epl_shoot_full_scaled()$variable,
           labels = list(style = list(color = "White", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_subtitle(text = "SHOOTING PER 90 MINUTES",
              style = list(color = "white"),
              margin = 50,
              align = "center")
  })
  
  epl_shoot_90_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_shooting_90_rank_max_long <- epl_shooting_rank_max() %>% select(19:28) %>% pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    shoot_90_table <- left_join(epl_shoot_90_full_scaled(), epl_shooting_rank_final()) %>% 
      bind_cols(epl_shooting_90_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(shoot_90_table, options = list(dom = 't',pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(shoot_90_table$row.color)), 
                                               sort(unique(shoot_90_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(data)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    } else {
      epl_shooting_2_rank_max_long <- epl_shooting_2_rank_max() %>% 
        select(19:28) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:10), 2)) %>%
        arrange(rankVarMax)
      epl_shoot_2_90_table <- epl_shoot_2_90_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_shooting_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_shooting_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
          arrange(match(Stat, c("Goals",
                                    "Shots",
                                    "Goals/Shot",
                                    "Shots on Target",
                                    "Shots on Target%",
                                    "Goals/Shot on Target",
                                    "xGoals",
                                    "Non Penalty xGoals",
                                    #"Goals - xGoals",
                                    #"Non Penalty: Goals - xGoals",
                                    "Non Penalty: xGoals/Shot",
                                    "Distance"
                                    ))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_shoot_2_90_table, options = list(dom = 't',pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_shoot_2_90_table[[1]])),
                                                 sort(unique(epl_shoot_2_90_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_shoot_2_90_table[[9]])),
                                                 sort(unique(epl_shoot_2_90_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_shoot_2_90_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
    
  ##SHOOTING RANK
  epl_shooting_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_shooting() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_shoot_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
      } else {epl_shooting_90() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_shoot_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_shooting() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_shoot_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
      }else{
        semi_join(epl_shooting_90() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_shoot_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
        }
    }
  })
  epl_shooting_rank_max <- reactive({
    epl_shooting_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_shooting_rank_min <- reactive({
    epl_shooting_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_shooting_rank_player <- reactive({
    epl_shooting_rank() %>% filter(Name == input$playerchoice)
  })
  epl_shooting_rank_max_min <- reactive({
    bind_rows(epl_shooting_rank_max(), epl_shooting_rank_min())
  })
  epl_shooting_rank_full <- reactive({
    bind_rows(epl_shooting_rank_max_min(), epl_shooting_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG'))
  })
  epl_shooting_var_vals <- reactive({ 
    epl_shooting_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, 'G-xG', 'np:G-xG')) %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    slice(c(1:10))
  })
  epl_shooting_var_ranks <- reactive({
    epl_shooting_rank_full() %>% 
    select(-c(1:10)) %>%
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(cols = c(1:10), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player")
  })
  epl_shooting_rank_final <- reactive({
    bind_cols(epl_shooting_var_vals(), epl_shooting_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           #`Non Penalty: Goals - xGoals` = `np:G-xG`,
           #`Goals - xGoals` = `G-xG`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(5:14), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
   arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              #"Non Penalty: Goals - xGoals",
                              #"Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals")))
  })
  
  ## SHOOTING 2nd PLAYER
  epl_shooting_2_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_shooting() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_shooting() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_shooting_2_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_shooting() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_shooting() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_shooting_2_max_min <- reactive({
    bind_rows(epl_shooting_2_max(), epl_shooting_2_min())
    })
  epl_shoot_2_player <- reactive({
      epl_shooting() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_shoot_2_full <- reactive({
    bind_rows(epl_shooting_2_max_min(), epl_shoot_2_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK, `np:G-xG`,`G-xG`))
    })
  epl_shoot_2_full_scaled <- reactive({ 
    epl_shoot_2_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_shoot_2_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    #mutate(`G-xG` = 1 - `G-xG`,
    #       `np:G-xG` = 1- `np:G-xG`) %>% 
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           #`Non Penalty: Goals - xGoals` = `np:G-xG`,
           #`Goals - xGoals` = `G-xG`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(2:ncol(epl_shoot_2_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              #"Non Penalty: Goals - xGoals",
                              #"Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals")))
  })
  shooting_2_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           gridWidth = 2,
           gridLineColor = "white",
           backgroundColor = "#003366",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_colors(c('#FFFFFF','#FFCC00')) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_shoot_2_full_scaled()
    }
    else {
      data = epl_shooting_2_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled, group = Name)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled, group = Name)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = TRUE,
                pointWidth = 0.25,
                borderColor = "black",
                borderWidth = .15) %>%
  hc_add_series(data = shooting_descr %>% filter(variable != 'Goals - xGoals' & variable != 'Non Penalty: Goals - xGoals'),
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                gridLineColor = "white",
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_shoot_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
  hc_subtitle(text = "SHOOTING",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  ## SHOOTING 2nd PLAYER 90
  epl_shooting_2_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_shooting_90() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_shooting_90() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_shooting_2_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_shooting_90() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_shooting_90() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_shooting_2_90_max_min <- reactive({
    bind_rows(epl_shooting_2_90_max(), epl_shooting_2_90_min())
    })
  epl_shoot_2_90_player <- reactive({
      epl_shooting_90() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_shoot_2_90_full <- reactive({
    bind_rows(epl_shooting_2_90_max_min(), epl_shoot_2_90_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`, `np:G-xG`))
    })
  epl_shoot_2_90_full_scaled <- reactive({ 
    epl_shoot_2_90_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_shoot_2_90_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    #mutate(`G-xG` = 1 - `G-xG`,
    #       `np:G-xG` = 1- `np:G-xG`) %>% 
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           #`Non Penalty: Goals - xGoals` = `np:G-xG`,
           #`Goals - xGoals` = `G-xG`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(2:ncol(epl_shoot_2_90_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              #"Non Penalty: Goals - xGoals",
                              #"Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals")))
  })
  shooting_2_90_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           gridWidth = 2,
           gridLineColor = "white",
           backgroundColor = "#003366",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_colors(c('#FFFFFF','#FFCC00')) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_shoot_2_90_full_scaled()
    }
    else {
      data = epl_shooting_2_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled, group = Name)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled, group = Name)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = TRUE,
                pointWidth = 0.25,
                borderColor = "black",
                borderWidth = .15
                ) %>%
  hc_add_series(data = shooting_descr %>% filter(variable != 'Goals - xGoals' & variable != 'Non Penalty: Goals - xGoals'),
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                gridLineColor = "white",
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_shoot_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
  hc_subtitle(text = "SHOOTING PER 90 MINUTES",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  ##SHOOTING 2nd PLAYER RANK
  epl_shooting_2_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_shooting() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_shoot_2_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`, `np:G-xG`), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
      } else {epl_shooting_90() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_shoot_2_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK,`G-xG`, `np:G-xG`), min_rank, .names = "rank_{.col}")) #%>%
      #mutate(`rank_G-xG` = rank(-`G-xG`),
      #       `rank_np:G-xG` = rank(-`np:G-xG`))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_shooting() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_shoot_2_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`,`np:G-xG`), min_rank, .names = "rank_{.col}")) #%>%
        #mutate(`rank_G-xG` = rank(-`G-xG`),
        #       `rank_np:G-xG` = rank(-`np:G-xG`))
      }else{
        semi_join(epl_shooting_90() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_shoot_2_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`,`np:G-xG`), min_rank, .names = "rank_{.col}")) #%>%
        #mutate(`rank_G-xG` = rank(-`G-xG`),
        #        `rank_np:G-xG` = rank(-`np:G-xG`))
        }
    }
  })
  epl_shooting_2_rank_max <- reactive({
    epl_shooting_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_shooting_2_rank_min <- reactive({
    epl_shooting_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_shooting_2_rank_player <- reactive({
    epl_shooting_2_rank() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
  })
  epl_shooting_2_rank_max_min <- reactive({
    bind_rows(epl_shooting_2_rank_max(), epl_shooting_2_rank_min())
  })
  epl_shooting_2_rank_full <- reactive({
    bind_rows(epl_shooting_2_rank_max_min(), epl_shooting_2_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`, `np:G-xG`))
  })
  epl_shooting_2_var_vals <- reactive({ 
    epl_shooting_2_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`, FK, PKatt, PK, `G-xG`, `np:G-xG`)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    slice(c(1:10), c(21:30))
  })
  epl_shooting_2_var_ranks <- reactive({
    epl_shooting_2_rank_full() %>% 
    select(-c(1:10)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:10), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
      select(-c(Name))
  })
  epl_shooting_2_rank_final <- reactive({
    bind_cols(epl_shooting_2_var_vals(), epl_shooting_2_var_ranks()) %>%
      filter(variable != 'G-xG' & variable != 'np:G-xG') %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Goals = Gls,
           Shots = Sh,
           `Shots on Target` = SoT,
           `Shots on Target%` = `SoT%`,
           `Goals/Shot` = `G/Sh`,
           `Goals/Shot on Target` = `G/SoT`,
           Distance = Dist,
           `Non Penalty: xGoals/Shot` = `npxG/Sh`,
           #`Non Penalty: Goals - xGoals` = `np:G-xG`,
           #`Goals - xGoals` = `G-xG`,
           `Non Penalty xGoals` = npxG,
           `xGoals` = xG) %>%
    pivot_longer(c(6:15), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Goals",
                              "Shots",
                              "Goals/Shot",
                              "Shots on Target",
                              "Shots on Target%",
                              "Goals/Shot on Target",
                              "Distance",
                              #"Non Penalty: Goals - xGoals",
                              #"Goals - xGoals",
                              "Non Penalty: xGoals/Shot",
                              "Non Penalty xGoals",
                              "xGoals")))
  })
  
  ## SHOOTING OUTPUT
  output$shootPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == TRUE) {
      if (input$check2nd == TRUE) {
        shooting_2_90_plot()}
      else{shooting_90_plot()}
    } 
    else if(input$check2nd == TRUE) {
      shooting_2_plot()
    }
    else {shooting_plot()}
  })
  output$shootTable <- DT::renderDataTable({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == FALSE) {
      epl_shoot_table()
    }
    else {
      epl_shoot_90_table()
      }
  })
  
  
  ## PASSING
  epl_passing_main <- reactive({
    if (input$checkTouch == FALSE) {
      epl_passing_main2
    }
    else {
      passing_touches
    }
  })
  
  epl_passing_90_main <- reactive({
    if (input$checkTouch == FALSE) {
      epl_passing_90_main2
    }
    else {
      passing_touches_90
    }
  })
  
  epl_passing_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_passing_main() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_passing_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_passing_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_passing_main() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_passing_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_passing_max_min <- reactive({
    bind_rows(epl_passing_max(), epl_passing_min())
    })
  epl_pass_player <- reactive({
      epl_passing_main() %>% filter(Name == input$playerchoice)
    })
  epl_pass_full <- reactive({
    bind_rows(epl_passing_max_min(), epl_pass_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
    })
  epl_pass_full_scaled <- reactive({ 
    epl_pass_full() %>% 
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_pass_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(3:23), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  passing_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_pass_full_scaled()
    }
    else {
      data = epl_passing_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "black",
                borderWidth = .15,
                color = "#FFCC00",
                ) %>%
  hc_add_series(data = passing_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_pass_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_subtitle(text = "PASSING",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  epl_pass_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_passing_rank_max_long <- epl_passing_rank_max() %>% select(25:45) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    pass_table <- left_join(epl_pass_full_scaled(), epl_passing_rank_final()) %>%
      bind_cols(epl_passing_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(pass_table, options = list(dom = 't',pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(pass_table$row.color)), 
                                               sort(unique(pass_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(pass_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    }
    else {
      epl_passing_2_rank_max_long <- epl_passing_2_rank_max() %>% 
        select(25:45) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:21), 2)) %>%
        arrange(rankVarMax)
      epl_pass_2_table <- epl_pass_2_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_passing_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_passing_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists"))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_pass_2_table, options = list(dom = 't',pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_pass_2_table[[1]])),
                                                 sort(unique(epl_pass_2_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_pass_2_table[[9]])),
                                                 sort(unique(epl_pass_2_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_pass_2_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
  
  ## PASSING 90
  epl_passing_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_passing_90_main() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_passing_90_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_passing_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_passing_90_main() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_passing_90_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_passing_90_max_min <- reactive({
    bind_rows(epl_passing_90_max(), epl_passing_90_min())
    })
  epl_pass_90_player <- reactive({
    epl_passing_90_main() %>% filter(Name == input$playerchoice)
  })
  epl_pass_90_full <- reactive({
    bind_rows(epl_passing_90_max_min(), epl_pass_90_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_pass_90_full_scaled <- reactive({
  epl_pass_90_full() %>% mutate(type = c("max", "min","player")) %>%
  pivot_longer(c(1:ncol(epl_pass_90_full())), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
  filter(type == "player") %>%
  pivot_wider(names_from = variable, values_from = value.scaled) %>%
  rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(3:23), names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  passing_90_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE, 
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(data = passing_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                color = "white",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE) %>%   
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_pass_90_full_scaled()
    }
    else {
      data = epl_passing_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                color = "#FFCC00",
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.25,
                borderColor = "black",
                borderWidth = .15) %>%
  hc_xAxis(categories = epl_pass_full_scaled()$variable,
           labels = list(style = list(color = "White", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.01) %>%
  hc_subtitle(text = "PASSING PER 90 MINUTES",
              style = list(color = "white"),
              margin = 50,
              align = "center")
  })
  
  epl_pass_90_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_passing_90_rank_max_long <- epl_passing_rank_max() %>% select(25:45) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    pass_90_table <- left_join(epl_pass_90_full_scaled(), epl_passing_rank_final()) %>% 
      bind_cols(epl_passing_90_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(pass_90_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(pass_90_table$row.color)), 
                                               sort(unique(pass_90_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(pass_90_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    } else {
      epl_passing_2_rank_max_long <- epl_passing_2_rank_max() %>% 
        select(25:45) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:21), 2)) %>%
        arrange(rankVarMax)
      epl_pass_2_90_table <- epl_pass_2_90_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_passing_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_passing_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists"))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_pass_2_90_table, options = list(dom = 't', pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_pass_2_90_table[[1]])),
                                                 sort(unique(epl_pass_2_90_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_pass_2_90_table[[9]])),
                                                 sort(unique(epl_pass_2_90_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_pass_2_90_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
    
  ## PASSING RANK
  epl_passing_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_passing_main() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_pass_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } else {epl_passing_90_main() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_pass_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}"))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_passing_main() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_pass_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}"))
      }else{
        semi_join(epl_passing_90_main() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_pass_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}"))
        }
    }
  })
  epl_passing_rank_max <- reactive({
    epl_passing_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_passing_rank_min <- reactive({
    epl_passing_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_passing_rank_player <- reactive({
    epl_passing_rank() %>% filter(Name == input$playerchoice)
  })
  epl_passing_rank_max_min <- reactive({
    bind_rows(epl_passing_rank_max(), epl_passing_rank_min())
  })
  epl_passing_rank_full <- reactive({
    bind_rows(epl_passing_rank_max_min(), epl_passing_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_passing_var_vals <- reactive({ 
    epl_passing_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    slice(c(1:21))
  })
  epl_passing_var_ranks <- reactive({
    epl_passing_rank_full() %>% 
    select(-c(1:21)) %>%
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(cols = c(1:21), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player")
  })
  epl_passing_rank_final <- reactive({
    bind_cols(epl_passing_var_vals(), epl_passing_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(Completions,Attempts,`Completion %`, `Short Completions`, `Medium Completions`, `Short Completion %`, 
                 `Medium Completion %`, `Long Completions`, `Long Completion %`, `Progressive Completions`, Switches, `Pressure`, `Through Balls`, `Completions into Final 3rd`, `Completions into Penalty Area`, Crosses, 
                 `Key Passes`, `Shot Creating Passes`, `Goal Creating Passes`, xAssists, Assists),
               names_to = "variable", values_to = "value") %>%
  filter(!is.na(value)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  
  ## PASSING 2nd PLAYER
  epl_passing_2_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_passing_main() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_passing_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_passing_2_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_passing_main() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_passing_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_passing_2_max_min <- reactive({
    bind_rows(epl_passing_2_max(), epl_passing_2_min())
    })
  epl_pass_2_player <- reactive({
      epl_passing_main() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_pass_2_full <- reactive({
    bind_rows(epl_passing_2_max_min(), epl_pass_2_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_pass_2_full_scaled <- reactive({ 
    epl_pass_2_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_pass_2_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(Completions,Attempts,`Completion %`, `Short Completions`, `Medium Completions`, `Short Completion %`, 
                 `Medium Completion %`, `Long Completions`, `Long Completion %`, `Progressive Completions`, Switches, 
                 Switches, `Pressure`, `Through Balls`, `Completions into Final 3rd`, `Completions into Penalty Area`, Crosses, 
                 `Key Passes`, `Shot Creating Passes`, `Goal Creating Passes`, xAssists, Assists),
               names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  passing_2_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           gridWidth = 2,
           gridLineColor = "white",
           backgroundColor = "#003366",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_colors(c('#FFFFFF','#FFCC00')) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_pass_2_full_scaled()
    }
    else {
      data = epl_passing_2_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled, group = Name)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled, group = Name)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = TRUE,
                pointWidth = 0.06,
                borderColor = "black",
                borderWidth = .15) %>%
  hc_add_series(data = passing_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                gridLineColor = "white",
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_pass_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
  hc_subtitle(text = "PASSING",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  ## PASSING 2nd PLAYER 90
  epl_passing_2_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_passing_90_main() %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_passing_90_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_passing_2_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_passing_90_main() %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_passing_90_main() %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_passing_2_90_max_min <- reactive({
    bind_rows(epl_passing_2_90_max(), epl_passing_2_90_min())
    })
  epl_pass_2_90_player <- reactive({
      epl_passing_90_main() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_pass_2_90_full <- reactive({
    bind_rows(epl_passing_2_90_max_min(), epl_pass_2_90_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_pass_2_90_full_scaled <- reactive({ 
    epl_pass_2_90_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_pass_2_90_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
  pivot_longer(c(Completions,Attempts,`Completion %`, `Short Completions`, `Medium Completions`, `Short Completion %`, 
                 `Medium Completion %`, `Long Completions`, `Long Completion %`, `Progressive Completions`, Switches, 
                 Switches, `Pressure`, `Through Balls`, `Completions into Final 3rd`, `Completions into Penalty Area`, Crosses, 
                 `Key Passes`, `Shot Creating Passes`, `Goal Creating Passes`, xAssists, Assists),
               names_to = "variable", values_to = "value.scaled") %>%
  filter(!is.na(value.scaled)) %>%
  arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  passing_2_90_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           gridWidth = 2,
           gridLineColor = "white",
           backgroundColor = "#003366",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_colors(c('#FFFFFF','#FFCC00')) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_pass_2_90_full_scaled()
    }
    else {
      data = epl_passing_2_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled, group = Name)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled, group = Name)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = TRUE,
                pointWidth = 0.06,
                borderColor = "black",
                borderWidth = .15
                ) %>%
  hc_add_series(data = passing_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                gridLineColor = "white",
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_pass_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
  hc_subtitle(text = "PASSING PER 90 MINUTES",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  ##PASSING 2nd PLAYER RANK
  epl_passing_2_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_passing_main() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_pass_2_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } else {epl_passing_90_main() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_pass_2_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_passing_main() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_pass_2_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}"))
      }else{
        semi_join(epl_passing_90_main() %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_pass_2_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}"))
        }
    }
  })
  epl_passing_2_rank_max <- reactive({
    epl_passing_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_passing_2_rank_min <- reactive({
    epl_passing_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_passing_2_rank_player <- reactive({
    epl_passing_2_rank() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
  })
  epl_passing_2_rank_max_min <- reactive({
    bind_rows(epl_passing_2_rank_max(), epl_passing_2_rank_min())
  })
  epl_passing_2_rank_full <- reactive({
    bind_rows(epl_passing_2_rank_max_min(), epl_passing_2_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
  })
  epl_passing_2_var_vals <- reactive({ 
    epl_passing_2_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    slice(c(1:21), c(43:63))
  })
  epl_passing_2_var_ranks <- reactive({
    epl_passing_2_rank_full() %>% 
    select(-c(1:21)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:21), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
      select(-c(Name))
  })
  epl_passing_2_rank_final <- reactive({
    bind_cols(epl_passing_2_var_vals(), epl_passing_2_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Completions = `Cmp Total`,
         Attempts = `Att Total`,
         `Completion %` = `Cmp% Total`,
         `Short Completions` = `Cmp Short`,
         `Short Completion %` = `Cmp% Short`,
         `Medium Completions` = `Cmp Medium`, 
         `Medium Completion %` = `Cmp% Medium`,
         `Long Completions` = `Cmp Long`,
         `Long Completion %` = `Cmp% Long`,
         `Progressive Completions` = Prog,
         Switches = Sw,
         `Pressure` = Press,
         `Through Balls` = TB,
         `Completions into Final 3rd` = `1/3`,
         `Completions into Penalty Area` = PPA,
         Crosses = Crs,
         `Key Passes` = KP,
         `Shot Creating Passes` = SCA_passes,
         `Goal Creating Passes` = GCA_passes,
         xAssists = xA,
         Assists = Ast) %>%
    pivot_longer(c(Completions,Attempts,`Completion %`, `Short Completions`, `Medium Completions`, `Short Completion %`, 
                 `Medium Completion %`, `Long Completions`, `Long Completion %`, `Progressive Completions`,  
                 Switches, `Pressure`, `Through Balls`, `Completions into Final 3rd`, `Completions into Penalty Area`, Crosses, 
                 `Key Passes`, `Shot Creating Passes`, `Goal Creating Passes`, xAssists, Assists), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Completions", 
                            "Attempts",
                            "Completion %",
                            "Short Completions",
                            "Short Completion %",
                            "Medium Completions",
                            "Medium Completion %",
                            "Long Completions",
                            "Long Completion %",
                            "Progressive Completions",
                            "Switches",
                            "Pressure",
                            "Through Balls",
                            "Completions into Final 3rd",
                            "Completions into Penalty Area",
                            "Crosses",
                            "Key Passes",
                            "Shot Creating Passes",
                            "Goal Creating Passes",
                            "xAssists",
                            "Assists")))
  })
  
  ## PASSING OUTPUT
  output$passPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == TRUE) {
      if (input$check2nd == TRUE) {
        passing_2_90_plot()}
      else{passing_90_plot()}
    } 
    else if(input$check2nd == TRUE) {
      passing_2_plot()
    }
    else {passing_plot()}
  })
  output$passTable <- DT::renderDataTable({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == FALSE) {
      epl_pass_table()
    }
    else {
      epl_pass_90_table()
      }
  })
  
  
  ## DRIBBLING
  epl_drib_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_drib_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_drib_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_drib_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_drib_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_drib_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_drib_max_min <- reactive({
    bind_rows(epl_drib_max(), epl_drib_min())
    })
  epl_drib_player <- reactive({
      epl_drib_main %>% filter(Name == input$playerchoice)
    })
  epl_drib_full <- reactive({
    bind_rows(epl_drib_max_min(), epl_drib_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
    })
  epl_drib_full_scaled <- reactive({ 
    epl_drib_full() %>% 
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_drib_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1 - Dispossessed) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries, Miscontrol, Dispossessed), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  DRIBBLING_plot <- reactive({
  highchart() %>%
  hc_chart(polar = TRUE,
           backgroundColor = "#003366",
           gridWidth = 2,
           gridLineColor = "white",
           style = list(fontSize = 30)
           ) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_add_series(
    if(input$checkRank == FALSE) {
      data = epl_drib_full_scaled()
    }
    else {
      data = epl_drib_rank_final()
    },
    if(input$checkRank == FALSE) {
      mapping = hcaes(x = variable, y = value.scaled)
    }
    else{
      mapping = hcaes(x = variable, y = rank.scaled)
  }, 
                type = if(input$checkColAr == FALSE){"column"} else{"area"},
                tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                showInLegend = FALSE,
                pointWidth = 0.5,
                borderColor = "black",
                borderWidth = .15,
                color = "#FFCC00",
                ) %>%
  hc_add_series(data = drib_descr,
                mapping = hcaes(x = variable, y = 1),
                type = "point",
                tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                animation = FALSE,
                showInLegend = FALSE,
                color = "white"
                ) %>%
  hc_xAxis(categories = epl_drib_full_scaled()$variable,
           labels = list(style = list(color = "white", fontSize = 12))) %>%
  hc_yAxis(visible = FALSE,
           max = 1,
           tickPixelInterval = 0.05
           ) %>%
  hc_subtitle(text = "DRIBBLING",
              align = "center",
              style = list(color = "white"),
              margin = 50) 
  })
  
  epl_drib_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_drib_rank_max_long <- epl_drib_rank_max() %>% 
      select(c('rank_Succ Drib' , 'rank_Att Drib', 'rank_Succ% Drib' ,'rank_Drib Past' ,'rank_SCA_Drib','rank_Fld','rank_Megs',
               'rank_Carries into PA','rank_Carries into Att 3rd','rank_TotDist Carried','rank_PrgDist Carried', 'rank_Prog Carries',
               'rank_Carries', 'rank_Dispossessed', 'rank_Miscontrol')) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    drib_table <- left_join(epl_drib_full_scaled(), epl_drib_rank_final()) %>%
      bind_cols(epl_drib_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(drib_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(drib_table$row.color)), 
                                               sort(unique(drib_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(drib_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    }
    else {
      epl_drib_2_rank_max_long <- epl_drib_2_rank_max() %>% 
        select(c('rank_Succ Drib' , 'rank_Att Drib', 'rank_Succ% Drib' ,'rank_Drib Past' ,'rank_SCA_Drib','rank_Fld','rank_Megs',
                 'rank_Carries into PA','rank_Carries into Att 3rd','rank_TotDist Carried','rank_PrgDist Carried', 'rank_Prog Carries',
                 'rank_Carries', 'rank_Miscontrol', 'rank_Dispossessed')) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:15), 2)) %>%
        arrange(rankVarMax)
      epl_drib_2_table <- epl_drib_2_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_drib_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_drib_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              ))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_drib_2_table, options = list(dom = 't', pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_drib_2_table[[1]])),
                                                 sort(unique(epl_drib_2_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_drib_2_table[[9]])),
                                                 sort(unique(epl_drib_2_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_drib_2_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
  
  ## DRIBBLING 90
  epl_drib_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_drib_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_drib_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_drib_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_drib_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_drib_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_drib_90_max_min <- reactive({
    bind_rows(epl_drib_90_max(), epl_drib_90_min())
    })
  epl_drib_90_player <- reactive({
    epl_drib_90_main %>% filter(Name == input$playerchoice)
  })
  epl_drib_90_full <- reactive({
    bind_rows(epl_drib_90_max_min(), epl_drib_90_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_drib_90_full_scaled <- reactive({
    epl_drib_90_full() %>% mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_drib_90_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1- Dispossessed) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries, Miscontrol, Dispossessed), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  DRIBBLING_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE, 
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(data = drib_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  color = "white",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE) %>%   
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_drib_90_full_scaled()
      }
      else {
        data = epl_drib_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  color = "#FFCC00",
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = FALSE,
                  pointWidth = 0.25,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_xAxis(categories = epl_drib_full_scaled()$variable,
             labels = list(style = list(color = "White", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.01) %>%
    hc_subtitle(text = "DRIBBLING PER 90 MINUTES",
                style = list(color = "white"),
                margin = 50,
                align = "center")
  })
  
  epl_drib_90_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_drib_90_rank_max_long <- epl_drib_rank_max() %>% 
      select(c('rank_Succ Drib' , 'rank_Att Drib', 'rank_Succ% Drib' ,'rank_Drib Past' ,'rank_SCA_Drib','rank_Fld','rank_Megs',
               'rank_Carries into PA','rank_Carries into Att 3rd','rank_TotDist Carried','rank_PrgDist Carried', 'rank_Prog Carries',
               'rank_Carries', 'rank_Miscontrol', 'rank_Dispossessed')) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    drib_90_table <- left_join(epl_drib_90_full_scaled(), epl_drib_rank_final()) %>% 
      bind_cols(epl_drib_90_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(drib_90_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(drib_90_table$row.color)), 
                                               sort(unique(drib_90_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(drib_90_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    } else {
      epl_drib_2_rank_max_long <- epl_drib_2_rank_max() %>% 
        select(c('rank_Succ Drib' , 'rank_Att Drib', 'rank_Succ% Drib' ,'rank_Drib Past' ,'rank_SCA_Drib','rank_Fld','rank_Megs',
               'rank_Carries into PA','rank_Carries into Att 3rd','rank_TotDist Carried','rank_PrgDist Carried', 'rank_Prog Carries',
               'rank_Carries', 'rank_Miscontrol', 'rank_Dispossessed')) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:15), 2)) %>%
        arrange(rankVarMax)
      epl_drib_2_90_table <- epl_drib_2_90_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_drib_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_drib_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              ))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_drib_2_90_table, options = list(dom = 't', pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_drib_2_90_table[[1]])),
                                                 sort(unique(epl_drib_2_90_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_drib_2_90_table[[9]])),
                                                 sort(unique(epl_drib_2_90_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_drib_2_90_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
    
  ## DRIBBLING RANK
  epl_drib_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_drib_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_drib_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
      mutate(rank_Miscontrol = rank(- Miscontrol),
         rank_Dispossessed = rank(-Dispossessed))
      } else {epl_drib_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_drib_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
      mutate(rank_Miscontrol = rank(-Miscontrol),
         rank_Dispossessed = rank(-Dispossessed))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_drib_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_drib_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
        mutate(rank_Miscontrol = rank(-Miscontrol),
          rank_Dispossessed = rank(-Dispossessed))
      }else{
        semi_join(epl_drib_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_drib_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
        mutate(rank_Miscontrol = rank(-Miscontrol),
          rank_Dispossessed = rank(-Dispossessed))
        }
    }
  })
  epl_drib_rank_max <- reactive({
    epl_drib_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_drib_rank_min <- reactive({
    epl_drib_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_drib_rank_player <- reactive({
    epl_drib_rank() %>% filter(Name == input$playerchoice)
  })
  epl_drib_rank_max_min <- reactive({
    bind_rows(epl_drib_rank_max(), epl_drib_rank_min())
  })
  epl_drib_rank_full <- reactive({
    bind_rows(epl_drib_rank_max_min(), epl_drib_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_drib_var_vals <- reactive({ 
    epl_drib_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    slice(c(1:15))
  })
  epl_drib_var_ranks <- reactive({
    epl_drib_rank_full() %>% 
    select(-c(1:15)) %>%
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(cols = c(1:15), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player")
  })
  epl_drib_rank_final <- reactive({
    bind_cols(epl_drib_var_vals(), epl_drib_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries, Miscontrol, Dispossessed), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  
  ## DRIBBLING 2nd PLAYER
  epl_drib_2_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_drib_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_drib_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  }) 
  epl_drib_2_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_drib_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_drib_main%>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_drib_2_max_min <- reactive({
    bind_rows(epl_drib_2_max(), epl_drib_2_min())
    })
  epl_drib_2_player <- reactive({
      epl_drib_main%>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_drib_2_full <- reactive({
    bind_rows(epl_drib_2_max_min(), epl_drib_2_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_drib_2_full_scaled <- reactive({ 
    epl_drib_2_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_drib_2_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1- Dispossessed) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries, Dispossessed, Miscontrol), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  DRIBBLING_2_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_drib_2_full_scaled()
      }
      else {
        data = epl_drib_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_add_series(data = drib_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_drib_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "DRIBBLING",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ## DRIBBLING 2nd PLAYER 90
  epl_drib_2_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_drib_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_drib_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_drib_2_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_drib_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_drib_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_drib_2_90_max_min <- reactive({
    bind_rows(epl_drib_2_90_max(), epl_drib_2_90_min())
    })
  epl_drib_2_90_player <- reactive({
      epl_drib_90_main %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_drib_2_90_full <- reactive({
    bind_rows(epl_drib_2_90_max_min(), epl_drib_2_90_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_drib_2_90_full_scaled <- reactive({ 
    epl_drib_2_90_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_drib_2_90_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol,
         Dispossessed = 1- Dispossessed) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  DRIBBLING_2_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_drib_2_90_full_scaled()
      }
      else {
        data = epl_drib_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15
                  ) %>%
    hc_add_series(data = drib_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_drib_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "DRIBBLING PER 90 MINUTES",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ##DRIBBLING 2nd PLAYER RANK
  epl_drib_2_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_drib_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_drib_2_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
      mutate(rank_Miscontrol = rank(-Miscontrol),
         rank_Dispossessed = rank(-Dispossessed))
      } else {epl_drib_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_drib_2_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
      mutate(rank_Miscontrol = rank(-Miscontrol),
         rank_Dispossessed = rank(-Dispossessed))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_drib_main%>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_drib_2_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
        mutate(rank_Miscontrol = rank(-Miscontrol),
         rank_Dispossessed = rank(-Dispossessed))
      }else{
        semi_join(epl_drib_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_drib_2_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
        mutate(rank_Miscontrol = rank(-Miscontrol),
          rank_Dispossessed = rank(-Dispossessed))
        }
    }
  })
  epl_drib_2_rank_max <- reactive({
    epl_drib_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_drib_2_rank_min <- reactive({
    epl_drib_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_drib_2_rank_player <- reactive({
    epl_drib_2_rank() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
  })
  epl_drib_2_rank_max_min <- reactive({
    bind_rows(epl_drib_2_rank_max(), epl_drib_2_rank_min())
  })
  epl_drib_2_rank_full <- reactive({
    bind_rows(epl_drib_2_rank_max_min(), epl_drib_2_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
  })
  epl_drib_2_var_vals <- reactive({ 
    epl_drib_2_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    filter(variable == "Succ Drib" | variable == "Att Drib" | variable == "Succ% Drib" | variable == "Drib Past" | variable == "SCA_Drib" |
             variable == "Fld" | variable == "Megs" | variable == "Carries into PA" | variable == "Carries into Att 3rd" | 
             variable == "TotDist Carried" | variable == "PrgDist Carried" | variable == "Prog Carries" | variable == "Carries" |
             variable == "Miscontrol" | variable == "Dispossessed")
  })
  epl_drib_2_var_ranks <- reactive({
    epl_drib_2_rank_full() %>% 
    select(-c(1:15)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:15), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
      select(-c(Name))
  })
  
  epl_drib_2_rank_final <- reactive({
    bind_cols(epl_drib_2_var_vals(), epl_drib_2_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(`Successful Dribbles` = `Succ Drib`,
           `Attempted Dribbles` = `Att Drib`,
           `Successful Dribble %` = `Succ% Drib`,
           `Dribbled Past` = `Drib Past`,
           `Shot Creating Dribbles` = `SCA_Drib`,
           `Fouled` = Fld,
           Nutmegs = Megs,
           `Carries into Penalty Area` = `Carries into PA`,
           `Carries into Attacking 3rd` = `Carries into Att 3rd`,
           `Total Distance Carried` = `TotDist Carried`,
           `Progressive Distance Carried` = `PrgDist Carried`,
           `Progressive Carries` = `Prog Carries`,
           `Carries` = Carries) %>%
    pivot_longer(c(`Successful Dribbles`, `Attempted Dribbles`, `Successful Dribble %`, `Dribbled Past`, `Shot Creating Dribbles`,
                   `Fouled`, Nutmegs, `Carries into Penalty Area`, `Carries into Attacking 3rd`, `Total Distance Carried`,
                   `Progressive Distance Carried`, `Progressive Carries`, Carries, Miscontrol, Dispossessed), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Successful Dribbles",
                              "Attempted Dribbles",
                              "Successful Dribble %",
                              "Dribbled Past",
                              "Shot Creating Dribbles",
                              "Fouled",
                              "Nutmegs",
                              "Dispossessed",
                              "Miscontrol",
                              "Carries into Penalty Area",
                              "Carries into Attacking 3rd",
                              "Total Distance Carried",
                              "Progressive Distance Carried",
                              "Progressive Carries",
                              "Carries"
                              )))
  })
  
  ## DRIBBLING OUTPUT
  output$dribPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == TRUE) {
      if (input$check2nd == TRUE) {
        DRIBBLING_2_90_plot()}
      else{DRIBBLING_90_plot()}
    } 
    else if(input$check2nd == TRUE) {
      DRIBBLING_2_plot()
    }
    else {DRIBBLING_plot()}
  })
  output$dribTable <- DT::renderDataTable({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == FALSE) {
      epl_drib_table()
    }
    else {
      epl_drib_90_table()
      }
  })
  
  
    ## DEFENDING
  epl_def_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_def_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_def_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_def_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_def_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_def_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_def_max_min <- reactive({
    bind_rows(epl_def_max(), epl_def_min())
    })
  epl_def_player <- reactive({
      epl_def_main %>% filter(Name == input$playerchoice)
    })
  epl_def_full <- reactive({
    bind_rows(epl_def_max_min(), epl_def_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
    })
  epl_def_full_scaled <- reactive({ 
    epl_def_full() %>% 
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_def_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value.scaled') %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  DEFENDING_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_def_full_scaled()
      }
      else {
        data = epl_def_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = FALSE,
                  pointWidth = 0.5,
                  borderColor = "black",
                  borderWidth = .15,
                  color = "#FFCC00",
                  ) %>%
    hc_add_series(data = def_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_def_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_subtitle(text = "DEFENDING",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  epl_def_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_def_rank_max_long <- epl_def_rank_max() %>% 
      select(c("rank_Tkls" , "rank_TklsW" , "rank_TklsW%" , "rank_Tkls vs Drib" , "rank_Tkl% vs Drib" , "rank_Tkls Att 3rd" , "rank_Tkls Mid 3rd" ,
                 "rank_TKls Def 3rd" ,"rank_Press" , "rank_Succ Press" ,"rank_Press%" , "rank_Press Att 3rd" , "rank_Press Mid 3rd" , 
                 "rank_Press Def 3rd" ,"rank_Clr" ,"rank_Blocked Sh" , "rank_Blocked Pass" , "rank_Int")) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    def_table <- left_join(epl_def_full_scaled(), epl_def_rank_final()) %>%
      bind_cols(epl_def_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(def_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(def_table$row.color)), 
                                               sort(unique(def_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(def_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    }
    else {
      epl_def_2_rank_max_long <- epl_def_2_rank_max() %>% 
        select(c("rank_Tkls" , "rank_TklsW" , "rank_TklsW%" , "rank_Tkls vs Drib" , "rank_Tkl% vs Drib" , "rank_Tkls Att 3rd" , "rank_Tkls Mid 3rd" ,
                 "rank_TKls Def 3rd" ,"rank_Press" , "rank_Succ Press" ,"rank_Press%" , "rank_Press Att 3rd" , "rank_Press Mid 3rd" , 
                 "rank_Press Def 3rd" ,"rank_Clr" ,"rank_Blocked Sh" , "rank_Blocked Pass" , "rank_Int")) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:18), 2)) %>%
        arrange(rankVarMax)
      epl_def_2_table <- epl_def_2_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_def_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_def_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions")))  %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_def_2_table, options = list(dom = 't', pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_def_2_table[[1]])),
                                                 sort(unique(epl_def_2_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_def_2_table[[9]])),
                                                 sort(unique(epl_def_2_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_def_2_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
  
  ## DEFENDING 90
  epl_def_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_def_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_def_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_def_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_def_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_def_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_def_90_max_min <- reactive({
    bind_rows(epl_def_90_max(), epl_def_90_min())
    })
  epl_def_90_player <- reactive({
    epl_def_90_main %>% filter(Name == input$playerchoice)
  })
  epl_def_90_full <- reactive({
    bind_rows(epl_def_90_max_min(), epl_def_90_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_def_90_full_scaled <- reactive({
    epl_def_90_full() %>% mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_def_90_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value.scaled') %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  DEFENDING_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE, 
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(data = def_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  color = "white",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE) %>%   
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_def_90_full_scaled()
      }
      else {
        data = epl_def_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  color = "#FFCC00",
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = FALSE,
                  pointWidth = 0.25,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_xAxis(categories = epl_def_full_scaled()$variable,
             labels = list(style = list(color = "White", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.01) %>%
    hc_subtitle(text = "DEFENDING PER 90 MINUTES",
                style = list(color = "white"),
                margin = 50,
                align = "center")
  })
  
  epl_def_90_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_def_90_rank_max_long <- epl_def_rank_max() %>% 
      select(c("rank_Tkls" , "rank_TklsW" , "rank_TklsW%" , "rank_Tkls vs Drib" , "rank_Tkl% vs Drib" , "rank_Tkls Att 3rd" , "rank_Tkls Mid 3rd" ,
                 "rank_TKls Def 3rd" ,"rank_Press" , "rank_Succ Press" ,"rank_Press%" , "rank_Press Att 3rd" , "rank_Press Mid 3rd" , 
                 "rank_Press Def 3rd" ,"rank_Clr" ,"rank_Blocked Sh" , "rank_Blocked Pass" , "rank_Int")) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    def_90_table <- left_join(epl_def_90_full_scaled(), epl_def_rank_final()) %>% 
      bind_cols(epl_def_90_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(def_90_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(def_90_table$row.color)), 
                                               sort(unique(def_90_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(def_90_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    } else {
      epl_def_2_rank_max_long <- epl_def_2_rank_max() %>% 
        select(c("rank_Tkls" , "rank_TklsW" , "rank_TklsW%" , "rank_Tkls vs Drib" , "rank_Tkl% vs Drib" , "rank_Tkls Att 3rd" , "rank_Tkls Mid 3rd" ,
                 "rank_TKls Def 3rd" ,"rank_Press" , "rank_Succ Press" ,"rank_Press%" , "rank_Press Att 3rd" , "rank_Press Mid 3rd" , 
                 "rank_Press Def 3rd" ,"rank_Clr" ,"rank_Blocked Sh" , "rank_Blocked Pass" , "rank_Int")) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:18), 2)) %>%
        arrange(rankVarMax)
      epl_def_2_90_table <- epl_def_2_90_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_def_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_def_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_def_2_90_table, options = list(dom = 't', pageLength = 25,
                                     initComplete =JS(
            "function(settings, json) {",
            "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
            "}"),
            columnDefs = list(list(className = 'dt-center', targets = "_all"),
                            list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_def_2_90_table[[1]])),
                                                 sort(unique(epl_def_2_90_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_def_2_90_table[[9]])),
                                                 sort(unique(epl_def_2_90_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_def_2_90_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
    
  ## DEFENDING RANK
  epl_def_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_def_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_def_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } else {epl_def_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_def_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_def_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_def_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      }else{
        semi_join(epl_def_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_def_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
        }
    }
  })
  epl_def_rank_max <- reactive({
    epl_def_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_def_rank_min <- reactive({
    epl_def_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_def_rank_player <- reactive({
    epl_def_rank() %>% filter(Name == input$playerchoice)
  })
  epl_def_rank_max_min <- reactive({
    bind_rows(epl_def_rank_max(), epl_def_rank_min())
  })
  epl_def_rank_full <- reactive({
    bind_rows(epl_def_rank_max_min(), epl_def_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_def_var_vals <- reactive({ 
    epl_def_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    slice(c(1:18))
  })
  epl_def_var_ranks <- reactive({
    epl_def_rank_full() %>% 
    select(-c(1:18)) %>%
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(cols = c(1:18), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player")
  })
  epl_def_rank_final <- reactive({
    bind_cols(epl_def_var_vals(), epl_def_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value') %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  
  ## DEFENDING 2nd PLAYER
  epl_def_2_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_def_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_def_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_def_2_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_def_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_def_main%>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_def_2_max_min <- reactive({
    bind_rows(epl_def_2_max(), epl_def_2_min())
    })
  epl_def_2_player <- reactive({
      epl_def_main%>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_def_2_full <- reactive({
    bind_rows(epl_def_2_max_min(), epl_def_2_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_def_2_full_scaled <- reactive({ 
    epl_def_2_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_def_2_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value.scaled') %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  DEFENDING_2_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_def_2_full_scaled()
      }
      else {
        data = epl_def_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_add_series(data = def_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_def_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "DEFENDING",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ## DEFENDING 2nd PLAYER 90
  epl_def_2_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_def_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_def_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_def_2_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_def_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_def_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_def_2_90_max_min <- reactive({
    bind_rows(epl_def_2_90_max(), epl_def_2_90_min())
    })
  epl_def_2_90_player <- reactive({
      epl_def_90_main %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_def_2_90_full <- reactive({
    bind_rows(epl_def_2_90_max_min(), epl_def_2_90_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_def_2_90_full_scaled <- reactive({ 
    epl_def_2_90_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_def_2_90_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value.scaled') %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  DEFENDING_2_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_def_2_90_full_scaled()
      }
      else {
        data = epl_def_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15
                  ) %>%
    hc_add_series(data = def_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_def_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "DEFENDING PER 90 MINUTES",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ##DEFENDING 2nd PLAYER RANK
  epl_def_2_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_def_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_def_2_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } else {epl_def_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_def_2_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_def_main%>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_def_2_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
      }else{
        semi_join(epl_def_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_def_2_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) 
        }
    }
  })
  epl_def_2_rank_max <- reactive({
    epl_def_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_def_2_rank_min <- reactive({
    epl_def_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_def_2_rank_player <- reactive({
    epl_def_2_rank() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
  })
  epl_def_2_rank_max_min <- reactive({
    bind_rows(epl_def_2_rank_max(), epl_def_2_rank_min())
  })
  epl_def_2_rank_full <- reactive({
    bind_rows(epl_def_2_rank_max_min(), epl_def_2_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
  })
  epl_def_2_var_vals <- reactive({ 
    epl_def_2_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    filter(variable == "Tkls" | variable == "TklsW" | variable == "TklsW%" | variable == "Tkls vs Drib" | variable == "Tkl% vs Drib" |
             variable == "Tkls Att 3rd" | variable == "Tkls Mid 3rd" | variable == "TKls Def 3rd" | variable == "Press" | variable == "Succ Press" | 
             variable == "Press%" | variable == "Press Att 3rd" | variable == "Press Mid 3rd" | variable == "Press Def 3rd" |
             variable == "Clr" | variable == "Blocked Sh" | variable == "Blocked Pass" | variable == "Int")
  })
  epl_def_2_var_ranks <- reactive({
    epl_def_2_rank_full() %>% 
    select(-c(1:18)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:18), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
      select(-c(Name))
  })
  epl_def_2_rank_final <- reactive({
    bind_cols(epl_def_2_var_vals(), epl_def_2_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(Tackles = Tkls,
         `Tackles Won` = TklsW,
         `% of Tackles Won` = `TklsW%`,
         `Tackles vs Dribbles` = `Tkls vs Drib`,
         `% of Dribbles Tackled` = `Tkl% vs Drib`,
         `Tackles in Attacking 3rd` = `Tkls Att 3rd`,
         `Tackles in Middle 3rd` = `Tkls Mid 3rd`,
         `Tackles in Defensive 3rd` = `TKls Def 3rd`,
         `Pressures` = Press,
         `Succesful Pressures` = `Succ Press`,
         `Succesful Pressures %` = `Press%`,
         `Pressures in Attacking 3rd` = `Press Att 3rd`,
         `Pressures in Middle 3rd` = `Press Mid 3rd`,
         `Pressures in Defensive 3rd` = `Press Def 3rd`,
         `Clearances` = Clr,
         `Blocked Shots` = `Blocked Sh`,
         `Blocked Passes` = `Blocked Pass`,
         Interceptions = Int) %>%
    pivot_longer(c('Tackles','Tackles Won','% of Tackles Won','Tackles vs Dribbles','% of Dribbles Tackled','Tackles in Attacking 3rd',
                   'Tackles in Middle 3rd','Tackles in Defensive 3rd','Pressures','Succesful Pressures','Succesful Pressures %',
                   'Pressures in Attacking 3rd','Pressures in Middle 3rd','Pressures in Defensive 3rd','Clearances','Blocked Shots',
                   'Blocked Passes','Interceptions'), 
                 names_to = 'variable', values_to = 'value') %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Tackles",
                              "Tackles Won",
                              "% of Tackles Won",
                              "Tackles vs Dribbles",
                              "% of Dribbles Tackled",
                              "Tackles in Attacking 3rd",
                              "Tackles in Middle 3rd",
                              "Tackles in Defensive 3rd",
                              "Pressures",
                              "Succesful Pressures",
                              "Succesful Pressures %",
                              "Pressures in Attacking 3rd",
                              "Pressures in Middle 3rd",
                              "Pressures in Defensive 3rd",
                              "Clearances",
                              "Blocked Shots",
                              "Blocked Passes",
                              "Interceptions"))) 
  })
  
  ## DEFENDING OUTPUT
  output$defPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == TRUE) {
      if (input$check2nd == TRUE) {
        DEFENDING_2_90_plot()}
      else{DEFENDING_90_plot()}
    } 
    else if(input$check2nd == TRUE) {
      DEFENDING_2_plot()
    }
    else {DEFENDING_plot()}
  })
  output$defTable <- DT::renderDataTable({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == FALSE) {
      epl_def_table()
    }
    else {
      epl_def_90_table()
      }
  })
  
  
  
  
  ## POSSESSION
  epl_poss_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_poss_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_poss_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_poss_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_poss_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_poss_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_poss_max_min <- reactive({
    bind_rows(epl_poss_max(), epl_poss_min())
    })
  epl_poss_player <- reactive({
      epl_poss_main %>% filter(Name == input$playerchoice)
    })
  epl_poss_full <- reactive({
    bind_rows(epl_poss_max_min(), epl_poss_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
    })
  epl_poss_full_scaled <- reactive({ 
    epl_poss_full() %>% 
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_poss_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`)%>%
    pivot_longer(c(1:ncol(epl_poss_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              )))
  })
  POSSESSION_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_poss_full_scaled()
      }
      else {
        data = epl_poss_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = FALSE,
                  pointWidth = 0.5,
                  borderColor = "black",
                  borderWidth = .15,
                  color = "#FFCC00",
                  ) %>%
    hc_add_series(data = poss_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_poss_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_subtitle(text = "POSSESSION",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  epl_poss_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_poss_rank_max_long <- epl_poss_rank_max() %>% 
      select(c("rank_Touches" , "rank_Touches Att Pen" , "rank_Touches Att 3rd" , "rank_Touches Mid 3rd" , "rank_Touches Def 3rd" , 
               "rank_Touches Def Pen" , "rank_Rec" ,"rank_Targ" ,"rank_Rec%" , "rank_Prog Rec" ,"rank_AD Won%" , "rank_AD Won" , 
               "rank_Recov" , "rank_PrgDist" ,"rank_TotDist" ,"rank_Cmp% Total" , "rank_Att Total" , "Cmp Total", "rank_Miscontrol")) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    poss_table <- left_join(epl_poss_full_scaled(), epl_poss_rank_final()) %>%
      bind_cols(epl_poss_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(poss_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(poss_table$row.color)), 
                                               sort(unique(poss_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(poss_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    }
    else {
      epl_poss_2_rank_max_long <- epl_poss_2_rank_max() %>% 
        select(c("rank_Touches" , "rank_Touches Att Pen" , "rank_Touches Att 3rd" , "rank_Touches Mid 3rd" , "rank_Touches Def 3rd" , 
               "rank_Touches Def Pen" , "rank_Rec" ,"rank_Targ" ,"rank_Rec%" , "rank_Prog Rec" ,"rank_AD Won%" , "rank_AD Won" , 
               "rank_Recov" , "rank_PrgDist" ,"rank_TotDist" ,"rank_Cmp% Total" , "rank_Att Total" , "Cmp Total", "rank_Miscontrol")) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:19), 2)) %>%
        arrange(rankVarMax)
      epl_poss_2_table <- epl_poss_2_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value==maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_poss_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_poss_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Completions",
                              "Attempts",
                              "Completion %",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Recoveries",
                              "Progressive Distance",
                              "Total Distance",
                              "Miscontrol",
                              "Aerial Duels Won",
                              "% of Aerial Duels Won"
                              )))  %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_poss_2_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_poss_2_table[[1]])),
                                                 sort(unique(epl_poss_2_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_poss_2_table[[9]])),
                                                 sort(unique(epl_poss_2_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_poss_2_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
  
  ## POSSESSION 90
  epl_poss_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_poss_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_poss_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_poss_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_poss_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_poss_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_poss_90_max_min <- reactive({
    bind_rows(epl_poss_90_max(), epl_poss_90_min())
    })
  epl_poss_90_player <- reactive({
    epl_poss_90_main %>% filter(Name == input$playerchoice)
  })
  epl_poss_90_full <- reactive({
    bind_rows(epl_poss_90_max_min(), epl_poss_90_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_poss_90_full_scaled <- reactive({
    epl_poss_90_full() %>% mutate(type = c("max", "min","player")) %>%
    pivot_longer(c(1:ncol(epl_poss_90_full())), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`)%>%
    pivot_longer(c(1:ncol(epl_poss_90_full()) + 2), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              ))) 
  })
  POSSESSION_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE, 
             backgroundColor = "#003366",
             gridWidth = 2,
             gridLineColor = "white",
             style = list(fontSize = 30)) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_add_series(data = poss_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  color = "white",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE) %>%   
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_poss_90_full_scaled()
      }
      else {
        data = epl_poss_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  color = "#FFCC00",
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = FALSE,
                  pointWidth = 0.25,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_xAxis(categories = epl_poss_full_scaled()$variable,
             labels = list(style = list(color = "White", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.01) %>%
    hc_subtitle(text = "POSSESSION PER 90 MINUTES",
                style = list(color = "white"),
                margin = 50,
                align = "center")
  })
  
  epl_poss_90_table <- reactive({
    if (input$check2nd == FALSE) {
    epl_poss_90_rank_max_long <- epl_poss_rank_max() %>% 
      select(c("rank_Touches" , "rank_Touches Att Pen" , "rank_Touches Att 3rd" , "rank_Touches Mid 3rd" , "rank_Touches Def 3rd" , 
               "rank_Touches Def Pen" , "rank_Rec" ,"rank_Targ" ,"rank_Rec%" , "rank_Prog Rec" ,"rank_AD Won%" , "rank_AD Won" , 
               "rank_Recov" , "rank_PrgDist" ,"rank_TotDist" ,"rank_Cmp% Total" , "rank_Att Total" , "Cmp Total", "rank_Miscontrol")) %>% 
      pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax")
    poss_90_table <- left_join(epl_poss_90_full_scaled(), epl_poss_rank_final()) %>% 
      bind_cols(epl_poss_90_rank_max_long) %>%
      mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
      select(variable, value, value.scaled, oppRank, rank.scaled) %>%
      rename(Stat = variable,
             Value = value,
            `Scaled Value` = value.scaled,
            Ranking = oppRank) %>%
      mutate(row.color = if (input$checkRank == FALSE) {
        case_when(`Scaled Value` <= 0.1 ~ "#de425b",
                  `Scaled Value` <= 0.2 & `Scaled Value` > 0.1 ~ "#ea6e79",
                  `Scaled Value` <= 0.3 & `Scaled Value` > 0.2 ~ "#f49399",
                  `Scaled Value` <= 0.4 & `Scaled Value` > 0.3 ~ "#f49399",
                  `Scaled Value` <= 0.5 & `Scaled Value` > 0.4 ~ "#ffdbdc",
                  `Scaled Value` <= 0.6 & `Scaled Value` > 0.5 ~ "#d4e7e0",
                  `Scaled Value` <= 0.7 & `Scaled Value` > 0.6 ~ "#a8cfc2",
                  `Scaled Value` <= 0.8 & `Scaled Value` > 0.7 ~ "#7db7a4",
                  `Scaled Value` <= 0.9 & `Scaled Value` > 0.8 ~ "#4e9f88",
                  `Scaled Value` > 0.9 ~ "#488f31")
        } else {
          case_when(rank.scaled <= 0.1 ~ "#de425b",
                  rank.scaled <= 0.2 & rank.scaled > 0.1 ~ "#ea6e79",
                  rank.scaled <= 0.3 & rank.scaled > 0.2 ~ "#f49399",
                  rank.scaled <= 0.4 & rank.scaled > 0.3 ~ "#f49399",
                  rank.scaled <= 0.5 & rank.scaled > 0.4 ~ "#ffdbdc",
                  rank.scaled <= 0.6 & rank.scaled > 0.5 ~ "#d4e7e0",
                  rank.scaled <= 0.7 & rank.scaled > 0.6 ~ "#a8cfc2",
                  rank.scaled <= 0.8 & rank.scaled > 0.7 ~ "#7db7a4",
                  rank.scaled <= 0.9 & rank.scaled > 0.8 ~ "#4e9f88",
                  rank.scaled > 0.9 ~ "#488f31")
        }) %>%
      select(-c(rank.scaled))
    datatable(poss_90_table, options = list(dom = 't', pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = 5, visible = F)))) %>% 
      formatStyle(c("Stat", "Value", "Scaled Value", "Ranking"), "row.color", 
                  backgroundColor = styleEqual(sort(unique(poss_90_table$row.color)), 
                                               sort(unique(poss_90_table$row.color)))) %>%
      formatStyle(columns = c(1:NCOL(poss_90_table)),'font-size' = '25px',fontWeight = 'Bold') %>%
      formatRound(c("Scaled Value"), digits = 2)
    } else {
      epl_poss_2_rank_max_long <- epl_poss_2_rank_max() %>% 
        select(c("rank_Touches" , "rank_Touches Att Pen" , "rank_Touches Att 3rd" , "rank_Touches Mid 3rd" , "rank_Touches Def 3rd" , 
               "rank_Touches Def Pen" , "rank_Rec" ,"rank_Targ" ,"rank_Rec%" , "rank_Prog Rec" ,"rank_AD Won%" , "rank_AD Won" , 
               "rank_Recov" , "rank_PrgDist" ,"rank_TotDist" ,"rank_Cmp% Total" , "rank_Att Total" , "Cmp Total", "rank_Miscontrol")) %>% 
        pivot_longer(everything(), names_to = "rankVarMax", values_to = "rankValMax") %>%
        slice(rep(c(1:19), 2)) %>%
        arrange(rankVarMax)
      epl_poss_2_90_table <- epl_poss_2_90_full_scaled() %>% select(-c(type)) %>% 
        group_by(variable) %>%
        mutate(maxes = max(value)) %>%
        group_by(Name, variable) %>%
        mutate(row.color = if(value == maxes){"#488f31"} else{"#de425b"}) %>%
        select(-c(maxes), Name, variable, value, value.scaled, row.color) %>%
        bind_cols(epl_poss_2_rank_final() %>% select(rankVar, rank.scaled)) %>%
        arrange(rankVar) %>%
        bind_cols(epl_poss_2_rank_max_long) %>%
        mutate(oppRank = ranker(1 - rank.scaled, rankValMax)) %>%
        select(variable, value, value.scaled, oppRank, row.color) %>%
        rename(Stat = variable,
               Value = value,
               `Scaled Value` = value.scaled,
               Ranking = oppRank) %>%
        arrange(match(Stat, c("Completions",
                              "Attempts",
                              "Completion %",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Recoveries",
                              "Progressive Distance",
                              "Total Distance",
                              "Miscontrol",
                              "Aerial Duels Won",
                              "% of Aerial Duels Won"
                              )))  %>%
        ungroup() %>%
        mutate_all(as.character) %>%
        pivot_longer(c(3:6), names_to = "word", values_to = "numbers") %>%
        pivot_wider(names_from = "Name", values_from = "numbers") %>%
        pivot_wider(names_from = "word", values_from = c(3:4), names_sep = " ") %>%
        mutate(across(c(3,7), as.numeric)) %>%
        select(c(9,8,7,6,1,2,3,4,5))
      
        
      datatable(epl_poss_2_90_table, options = list(dom = 't',pageLength = 25,
                                   initComplete =JS(
          "function(settings, json) {",
          "$(this.api().table().header()).css({'font-size': '20px', 'background-color': '#000', 'color': '#fff'});",
          "}"),
          columnDefs = list(list(className = 'dt-center', targets = "_all"),
                          list(targets = c(1,9), visible = F)))) %>% 
        formatStyle(c(2,3,4),1,
                    backgroundColor = styleEqual(sort(unique(epl_poss_2_90_table[[1]])),
                                                 sort(unique(epl_poss_2_90_table[[1]])))) %>%
        formatStyle(c(6,7,8),9,
                    backgroundColor = styleEqual(sort(unique(epl_poss_2_90_table[[9]])),
                                                 sort(unique(epl_poss_2_90_table[[9]])))) %>%
        formatStyle(columns = c(1:NCOL(epl_poss_2_90_table)),'font-size' = '18px',fontWeight = 'Bold') %>%
        formatRound(c(3,7), digits = 2)
    }
  })
    
  ## POSSESSION RANK
  epl_poss_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_poss_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_poss_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      } else {epl_poss_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice) %>%
      bind_rows(epl_poss_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_poss_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_poss_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      }else{
        semi_join(epl_poss_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice) %>%
        bind_rows(epl_poss_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
        }
    }
  })
  epl_poss_rank_max <- reactive({
    epl_poss_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_poss_rank_min <- reactive({
    epl_poss_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_poss_rank_player <- reactive({
    epl_poss_rank() %>% filter(Name == input$playerchoice)
  })
  epl_poss_rank_max_min <- reactive({
    bind_rows(epl_poss_rank_max(), epl_poss_rank_min())
  })
  epl_poss_rank_full <- reactive({
    bind_rows(epl_poss_rank_max_min(), epl_poss_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`))
  })
  epl_poss_var_vals <- reactive({ 
    epl_poss_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`)) %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    slice(c(1:19))
  })
  epl_poss_var_ranks <- reactive({
    epl_poss_rank_full() %>% 
    select(-c(1:19)) %>%
    mutate(type = c("max", "min","player")) %>%
    pivot_longer(cols = c(1:19), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player")
  })
  epl_poss_rank_final <- reactive({
    bind_cols(epl_poss_var_vals(), epl_poss_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`) %>%
    pivot_longer(c(Touches, `Touches in Attacking Penalty Area`, `Touches in Attacking 3rd`, `Touches in Middle 3rd`, `Touches in Defensive 3rd`,
                   `Touches in Defensive Penalty Area`, Receptions, Targets, `Reception %`, `Progressive Receptions`, `% of Aerial Duels Won`,
                   `Aerial Duels Won`, Recoveries, Miscontrol, `Progressive Distance`, `Total Distance`, `Completion %`,
                   Attempts, Completions), names_to = "variable", values_to = "value") %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              )))
  })
  
  ## POSSESSION 2nd PLAYER
  epl_poss_2_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_poss_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_poss_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_poss_2_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_poss_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_poss_main%>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_poss_2_max_min <- reactive({
    bind_rows(epl_poss_2_max(), epl_poss_2_min())
    })
  epl_poss_2_player <- reactive({
      epl_poss_main%>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_poss_2_full <- reactive({
    bind_rows(epl_poss_2_max_min(), epl_poss_2_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_poss_2_full_scaled <- reactive({ 
    epl_poss_2_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_poss_2_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`)%>%
    pivot_longer(c(Touches, `Touches in Attacking Penalty Area`, `Touches in Attacking 3rd`, `Touches in Middle 3rd`, `Touches in Defensive 3rd`,
                   `Touches in Defensive Penalty Area`, Receptions, Targets, `Reception %`, `Progressive Receptions`, `% of Aerial Duels Won`,
                   `Aerial Duels Won`, Recoveries, Miscontrol, `Progressive Distance`, `Total Distance`, `Completion %`,
                   Attempts, Completions), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              )))
  })
  POSSESSION_2_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_poss_2_full_scaled()
      }
      else {
        data = epl_poss_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15) %>%
    hc_add_series(data = poss_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_poss_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "POSSESSION",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ## POSSESSION 2nd PLAYER 90
  epl_poss_2_90_max <- reactive({
    if (input$checkPOS == FALSE) {
      epl_poss_90_main %>%
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>% 
      summarise_if(is.numeric, max)
  }
    else {
      pos_max <- left_join(epl_poss_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") 
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_max, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, max)
    }
  })
  epl_poss_2_90_min <- reactive({ 
    if (input$checkPOS == FALSE) {
      epl_poss_90_main %>% 
      drop_na() %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      summarise_if(is.numeric, min)
    }
    else {
      pos_min <- left_join(epl_poss_90_main %>% drop_na(), epl_positions) %>%
        filter(`90s` >= input$value90s,
               Pos != "GK") %>% 
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position")
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))
      semi_join(pos_min, player_pos, by = c("position" = "position")) %>%
      pivot_wider(names_from = "type", values_from = "position") %>%
      summarise_if(is.numeric, min)
    }
    })
  epl_poss_2_90_max_min <- reactive({
    bind_rows(epl_poss_2_90_max(), epl_poss_2_90_min())
    })
  epl_poss_2_90_player <- reactive({
      epl_poss_90_main %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
    })
  epl_poss_2_90_full <- reactive({
    bind_rows(epl_poss_2_90_max_min(), epl_poss_2_90_player()) %>%
      select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
    })
  epl_poss_2_90_full_scaled <- reactive({ 
    epl_poss_2_90_full() %>% 
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(c(1:ncol(epl_poss_2_90_full())-1), names_to = "variable", values_to = "value") %>%
    group_by(variable) %>%
    mutate(value.scaled = (value - min(value)) / (max(value) - min(value))) %>%
    filter(type == "player" | type == "player2") %>%
    pivot_wider(names_from = variable, values_from = value.scaled) %>%
    mutate(Miscontrol = 1 - Miscontrol) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`)%>%
    pivot_longer(c(Touches, `Touches in Attacking Penalty Area`, `Touches in Attacking 3rd`, `Touches in Middle 3rd`, `Touches in Defensive 3rd`,
                   `Touches in Defensive Penalty Area`, Receptions, Targets, `Reception %`, `Progressive Receptions`, `% of Aerial Duels Won`,
                   `Aerial Duels Won`, Recoveries, Miscontrol, `Progressive Distance`, `Total Distance`, `Completion %`,
                   Attempts, Completions), names_to = "variable", values_to = "value.scaled") %>%
    filter(!is.na(value.scaled)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              )))
  })
  POSSESSION_2_90_plot <- reactive({
    highchart() %>%
    hc_chart(polar = TRUE,
             gridWidth = 2,
             gridLineColor = "white",
             backgroundColor = "#003366",
             style = list(fontSize = 30)
             ) %>%
    hc_add_theme(hc_theme_smpl()) %>%
    hc_colors(c('#FFFFFF','#FFCC00')) %>%
    hc_add_series(
      if(input$checkRank == FALSE) {
        data = epl_poss_2_90_full_scaled()
      }
      else {
        data = epl_poss_2_rank_final()
      },
      if(input$checkRank == FALSE) {
        mapping = hcaes(x = variable, y = value.scaled, group = Name)
      }
      else{
        mapping = hcaes(x = variable, y = rank.scaled, group = Name)
    }, 
                  type = if(input$checkColAr == FALSE){"column"} else{"area"},
                  tooltip = list(headFormat = "{point.variable}", pointFormat = "{point.value}"),
                  showInLegend = TRUE,
                  pointWidth = 0.2,
                  borderColor = "black",
                  borderWidth = .15
                  ) %>%
    hc_add_series(data = poss_descr,
                  mapping = hcaes(x = variable, y = 1),
                  type = "point",
                  tooltip = list(headerFormat = "", pointFormat = "{point.description}"),
                  animation = FALSE,
                  showInLegend = FALSE,
                  gridLineColor = "white",
                  color = "white"
                  ) %>%
    hc_xAxis(categories = epl_poss_full_scaled()$variable,
             labels = list(style = list(color = "white", fontSize = 12))) %>%
    hc_yAxis(visible = FALSE,
             max = 1,
             tickPixelInterval = 0.05
             ) %>%
    hc_legend(itemStyle = list(color = "white", fontSize = 24)) %>%
    hc_subtitle(text = "POSSESSION PER 90 MINUTES",
                align = "center",
                style = list(color = "white"),
                margin = 50) 
  })
  
  ##POSSESSION 2nd PLAYER RANK
  epl_poss_2_rank <- reactive({
    if (input$checkPOS == FALSE) {
      if(input$check90 == FALSE){epl_poss_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_poss_2_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      } else {epl_poss_90_main %>%
      filter(`90s` >= input$value90s,
             Pos != "GK") %>%
      drop_na() %>%
      filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
      bind_rows(epl_poss_2_90_player()) %>%
      mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      } 
    }
    else {
      player_pos <- left_join(epl_standard, epl_positions) %>% 
        filter(Name == input$playerchoice | Name == input$playerchoice2) %>%
        pivot_longer(cols = c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position") %>%
        filter(!is.na(position))  
      if(input$check90 == FALSE){
        semi_join(epl_poss_main%>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_poss_2_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
      }else{
        semi_join(epl_poss_90_main %>% left_join(epl_positions) %>%
        pivot_longer(c(Pos1, Pos2, Pos3), names_to = "type", values_to = "position"), player_pos, by = c("position" = "position")) %>%
        pivot_wider(names_from = "type", values_from = "position") %>%
        filter(`90s` >= input$value90s) %>%
        select(-c(Pos1,Pos2, Pos3)) %>%
        drop_na() %>%
        filter(Name != input$playerchoice & Name != input$playerchoice2) %>%
        bind_rows(epl_poss_2_90_player()) %>%
        mutate(across(-c(Age, Squad, Pos, Nation, Name, Rk, Born, `90s`), min_rank, .names = "rank_{.col}")) %>%
          mutate(rank_Miscontrol = rank(-Miscontrol))
        }
    }
  })
  epl_poss_2_rank_max <- reactive({
    epl_poss_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, max)
  })
  epl_poss_2_rank_min <- reactive({
    epl_poss_2_rank() %>%
    drop_na() %>%
    filter(`90s` >= input$value90s,
           Pos != "GK") %>% 
    summarise_if(is.numeric, min)
  })
  epl_poss_2_rank_player <- reactive({
    epl_poss_2_rank() %>% filter(Name == input$playerchoice | Name == input$playerchoice2)
  })
  epl_poss_2_rank_max_min <- reactive({
    bind_rows(epl_poss_2_rank_max(), epl_poss_2_rank_min())
  })
  epl_poss_2_rank_full <- reactive({
    bind_rows(epl_poss_2_rank_max_min(), epl_poss_2_rank_player()) %>%
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`))
  })
  epl_poss_2_var_vals <- reactive({ 
    epl_poss_2_rank_player() %>% 
    select(-c(Age, Squad, Pos, Nation, Rk, Born, `90s`)) %>%
    pivot_longer(-c(Name), names_to = "variable", values_to = "value") %>%
    filter(variable == "Touches" | variable == "Touches Att Pen" | variable == "Touches Att 3rd" | variable == "Touches Mid 3rd" | 
             variable == "Touches Def 3rd" | variable == "Touches Def Pen" | variable == "Rec" | variable == "Targ" | variable == "Rec%" |
             variable == "Prog Rec" | variable == "AD Won%" | variable == "AD Won" | variable == "Recov" | variable == "PrgDist" | 
             variable == "TotDist" | variable == "Cmp% Total" | variable == "Att Total" | variable == "Cmp Total" | variable == "Miscontrol")
  })
  epl_poss_2_var_ranks <- reactive({
    epl_poss_2_rank_full() %>% 
    select(-c(1:19)) %>%
    mutate(type = c("max", "min","player", "player2")) %>%
    pivot_longer(cols = c(1:19), names_to = "rankVar", values_to = "rankVal") %>%
    group_by(rankVar) %>%
    mutate(rank.scaled = (rankVal/ (max(rankVal)))) %>%
    filter(type == "player" | type == "player2") %>%
      select(-c(Name))
  })
  epl_poss_2_rank_final <- reactive({
    bind_cols(epl_poss_2_var_vals(), epl_poss_2_var_ranks()) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    rename(`Touches in Attacking Penalty Area` = `Touches Att Pen`,
           `Touches in Attacking 3rd` = `Touches Att 3rd`,
           `Touches in Middle 3rd` = `Touches Mid 3rd`,
           `Touches in Defensive 3rd` = `Touches Def 3rd`,
           `Touches in Defensive Penalty Area` = `Touches Def Pen`,
           Receptions = Rec,
           Targets = Targ,
           `Reception %` = `Rec%`,
           `Progressive Receptions` = `Prog Rec`,
           `% of Aerial Duels Won` = `AD Won%`,
           `Aerial Duels Won` = `AD Won`,
           `Recoveries` = Recov,
           `Progressive Distance` = PrgDist,
           `Total Distance` = TotDist,
           `Completion %` = `Cmp% Total`,
           `Attempts` = `Att Total`,
           `Completions` = `Cmp Total`) %>%
    pivot_longer(c(Touches, `Touches in Attacking Penalty Area`, `Touches in Attacking 3rd`, `Touches in Middle 3rd`, `Touches in Defensive 3rd`,
                   `Touches in Defensive Penalty Area`, Receptions, Targets, `Reception %`, `Progressive Receptions`, `% of Aerial Duels Won`,
                   `Aerial Duels Won`, Recoveries, Miscontrol, `Progressive Distance`, `Total Distance`, `Completion %`,
                   Attempts, Completions), 
                 names_to = 'variable', values_to = 'value') %>%
    filter(!is.na(value)) %>%
    arrange(match(variable, c("Touches",
                              "Touches in Attacking Penalty Area",
                              "Touches in Attacking 3rd",
                              "Touches in Middle 3rd",
                              "Touches in Defensive 3rd",
                              "Touches in Defensive Penalty Area",
                              "Receptions",
                              "Targets",
                              "Reception %",
                              "Progressive Receptions",
                              "% of Aerial Duels Won",
                              "Aerial Duels Won",
                              "Recoveries",
                              "Miscontrol",
                              "Progressive Distance",
                              "Total Distance",
                              "Completion %",
                              "Attempts",
                              "Completions"
                              ))) 
  })
  
  ## POSSESSION OUTPUT
  output$possPlot <- renderHighchart({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == TRUE) {
      if (input$check2nd == TRUE) {
        POSSESSION_2_90_plot()}
      else{POSSESSION_90_plot()}
    } 
    else if(input$check2nd == TRUE) {
      POSSESSION_2_plot()
    }
    else {POSSESSION_plot()}
  })
  output$possTable <- DT::renderDataTable({
    validate(
      if (input$check2nd == TRUE) {
        need(input$playerchoice2 != '' & input$playerchoice != '', 'Enter 2 player names')
      }
      else {
        need(input$playerchoice != '', 'Enter a players name')
      }
    )
    if (input$check90 == FALSE) {
      epl_poss_table()
    }
    else {
      epl_poss_90_table()
      }
  })  
}

shinyApp(ui, server)
```

