---
title: "Untitled"
author: "Shane Hauck"
date: '2022-05-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

```{r}
ccw <- function(x1,y1,x2,y2,x3,y3) {
  if((y3-y1)*(x2-x1) > (y2-y1)*(x3-x1)) {
    return (TRUE)
  }
  else{
    return (FALSE)
  }
}
intersect <- function(x1,y1,x2,y2,x3,y3,x4,y4) {
  if ((ccw(x1,y1,x3,y3,x4,y4) != ccw(x2,y2,x3,y3,x4,y4))&& (ccw(x1,y1,x2,y2,x3,y3) != ccw(x1,y1,x2,y2,x4,y4))) {
    return (TRUE)
  }
  else {
    return(FALSE)
  }
}
```


```{r}
pp_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/pp_info.csv")
play_by_play <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/pxp_womens_oly_2022_v2.csv")
```

```{r}
pp_pbp <- play_by_play %>% filter(situation_type == "5 on 4" | situation_type == "4 on 5")

goals <- pp_pbp %>% filter(event == "Shot" & event_successful == TRUE)
shots <- pp_pbp %>% filter(event == "Shot") 
pp_pbp %>% group_by(event) %>% summarise(n())
pp_pbp %>% group_by(game_date, team_name, opp_team_name) %>% summarise(n())
play_by_play %>% filter(event == "Shot") %>% group_by(event_type) %>% summarise()
shots %>% group_by(event_type) %>% summarise()
```

```{r}
pp_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/pp_info.csv")
```


__2022-02-08 Canada at USA__
```{r}
CAN_US_game_events <- play_by_play %>% filter(game_date == "8/2/2022" & (team_name == 'Olympic (Women) - Canada' |
                                         team_name == 'Olympic (Women) - United States')) %>% 
  mutate(team_name = fct_recode(team_name, Canada = "Olympic (Women) - Canada", USA = "Olympic (Women) - United States"),
         opp_team_name = fct_recode(opp_team_name, USA = "Olympic (Women) - United States", Canada = "Olympic (Women) - Canada"))
CAN_US_roster <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA roster.csv") %>%
  mutate(team = if_else(team == "home", "USA", "Canada"))
```

# PowerPlay 1
```{r}
CAN_US_pp1_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA P1 PP1.csv") %>% mutate(clock_seconds = 0) 
CAN_US_pp1_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/videoShotsInfo_2022-02-08 Canada at USA P1 PP1.csv")
pp_info

CAN_US_pp1_events <- CAN_US_game_events %>% filter(period == 1 & (clock_seconds <= 376 & clock_seconds >= 350)) %>%
  filter(team_name == "Canada" & x_coord >= 125 | team_name == "USA" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")


CAN_US_pp1_keyTimes <- CAN_US_pp1_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp1_passTimes <- CAN_US_pp1_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
CAN_US_pp1_shotTimes <- CAN_US_pp1_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
CAN_US_pp1_astTimes <- vector()

CAN_US_pp1_events <- CAN_US_pp1_events %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(CAN_US_pp1_passTimes)) {
  CAN_US_pp1_astTimes[i] = -1
  for (j in 1:length(CAN_US_pp1_shotTimes)) {
    if (CAN_US_pp1_passTimes[i] >= CAN_US_pp1_shotTimes[j] & CAN_US_pp1_passTimes[i] - CAN_US_pp1_shotTimes[j] <= 3) {
      CAN_US_pp1_astTimes[i] = CAN_US_pp1_passTimes[i]
      if (CAN_US_pp1_astTimes[i - 1] - CAN_US_pp1_astTimes[i] <= 3 & CAN_US_pp1_astTimes[i] > 0) {
        CAN_US_pp1_astTimes[i - 1] = -1
      }
    }
  }
}

for (i in 1:length(CAN_US_pp1_passTimes)) {
  CAN_US_pp1_events <- CAN_US_pp1_events %>%
    mutate(assist = if_else(clock_seconds == CAN_US_pp1_astTimes[i] |
                              CAN_US_pp1_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  CAN_US_pp1_events %>% filter(clock_seconds == CAN_US_pp1_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}



CAN_US_pp1_numPass <- vector()
CAN_US_pp1_totSecs <- vector()
max_secs <- max(CAN_US_pp1_events$clock_seconds)

for (i in 1:length(CAN_US_pp1_keyTimes)) {
  counter = 0
  for (j in 1:length(CAN_US_pp1_passTimes)) {
    if (CAN_US_pp1_passTimes[j] > CAN_US_pp1_keyTimes[i]) {
      counter = counter + 1
    }
  }
  if (counter > 0) {
    for (k in 1:counter) {
      CAN_US_pp1_passTimes <- CAN_US_pp1_passTimes[-1]
    }
  }
  CAN_US_pp1_numPass[i] = counter
  if (i == 1) {
    CAN_US_pp1_totSecs[i] = max_secs - CAN_US_pp1_keyTimes[i]
  }
  else {
    CAN_US_pp1_totSecs[i] = CAN_US_pp1_keyTimes[i - 1] - CAN_US_pp1_keyTimes[i]
  }
}
CAN_US_pp1_numPass
CAN_US_pp1_totSecs

CAN_US_pp1_events_updated <- CAN_US_pp1_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(CAN_US_pp1_keyTimes)) {
  CAN_US_pp1_events_updated <- CAN_US_pp1_events_updated %>%
    mutate(numPass = if_else(clock_seconds == CAN_US_pp1_keyTimes[i] & event != "Play",
                             CAN_US_pp1_numPass[i], numPass),
           totSecs = if_else(clock_seconds == CAN_US_pp1_keyTimes[i] & event != "Play",
                             CAN_US_pp1_totSecs[i], totSecs))
}

max_frame <- max(CAN_US_pp1_tracking$frame_id)
min_frame <- min(CAN_US_pp1_tracking$frame_id)
max_secs <- max(CAN_US_pp1_events_updated$clock_seconds)
min_secs <- min(CAN_US_pp1_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    CAN_US_pp1_tracking <- CAN_US_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    CAN_US_pp1_tracking <- CAN_US_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

CAN_US_pp1_trackRost <- left_join(CAN_US_pp1_tracking, CAN_US_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
CAN_US_pp1_eventTrack <- left_join(CAN_US_pp1_events_updated, CAN_US_pp1_trackRost, by = c("clock_seconds" = "clock_seconds"))

CAN_US_pp1_assistTrack <- CAN_US_pp1_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(USA, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(USA, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(USA, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_centroid))

# dist_moved <- CAN_US_pp1_eventTrack %>% filter((event == "Play" | event == "Shot") & assist == TRUE) %>%
#   filter(team_name.y == "USA") %>%
#   group_by(clock_seconds, event, frame_id) %>% 
#   mutate(frame_total = n()) %>%
#   ungroup() %>%
#   select(clock_seconds, event, frame_id, track_id,x_ft, y_ft) %>%
#   group_by(track_id, event) %>%
#   filter(event == "Shot" & frame_id == max(frame_id) | event == "Play" & frame_id == min(frame_id)) %>%
#   select(-c(frame_id)) %>%
#   ungroup() %>%
#   pivot_wider(names_from = event, values_from = c(x_ft,y_ft)) %>%
#   mutate(distance_moved = sqrt((x_ft_Shot - x_ft_Play)^2 + (y_ft_Shot - y_ft_Play)^2)) %>%
#   group_by(clock_seconds) %>%
#   summarise(def_distance_moved = mean(distance_moved))

# astsftts <- CAN_US_pp1_eventTrack %>% filter(assist == TRUE) %>%
#   filter(team_name.y == "USA") %>%
#   group_by(frame_id) %>%
#   mutate(centroid_x = sum(x_ft)/n(),
#          centroid_y = sum(y_ft)/n()) %>%
#   ungroup() %>%
#   group_by(clock_seconds) %>%
#   filter(event == "Play" & frame_id == min(frame_id) | event == "Shot" & frame_id == max(frame_id)) %>%
#   ungroup() %>%
#   mutate(nearest_frame = if_else(event == "Shot",
#                                  frame_id - min(frame_id[event == "Shot"] - frame_id[event == "Play"]),
#                                  frame_id + min(frame_id[event == "Shot"] - frame_id[event == "Play"]))) %>%
#   pivot_wider(names_from = event, values_from = c(centroid_x, centroid_y)) %>%
#   mutate(centroid_x_Shot = min(centroid_x_Shot[frame_id == nearest_frame], na.rm = TRUE))
#   mutate(centroid_dist_move = centroid_x - min(centroid_x[frame_id == nearest_frame]))

CAN_US_pp1_shots <- CAN_US_pp1_eventTrack %>% filter(event == "Shot") %>%  
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(USA, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "USA"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(USA, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(USA, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(USA, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(USA, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

CAN_US_pp1_shotTimes <- CAN_US_pp1_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp1_rebounds <- vector()
for (i in 1:length(CAN_US_pp1_shotTimes)) {
  if (i == 1) {
    CAN_US_pp1_rebounds[i] = 0
  }
  else {
    if (CAN_US_pp1_shotTimes[i] - CAN_US_pp1_shotTimes[i - 1] < 2) {
      CAN_US_pp1_rebounds[i] = 1
    }
    else {
      CAN_US_pp1_rebounds[i] = 0
    }
  }
}
for (i in 1:length(CAN_US_pp1_shotTimes)) {
  CAN_US_pp1_shots <- CAN_US_pp1_shots %>%
    mutate(rebound = if_else(clock_seconds == CAN_US_pp1_shotTimes[i],
                             CAN_US_pp1_rebounds[i], rebound))
}

CAN_US_pp1_shotProb <- CAN_US_pp1_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

CAN_US_pp1_full <- CAN_US_pp1_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))


CAN_US_pp1_shotProb_goals <- CAN_US_pp1_full %>% filter(event_successful == TRUE) 
```

# PowerPlay 2
```{r}
CAN_US_pp2_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA P1 PP2.csv") %>% mutate(clock_seconds = 0) 
CAN_US_pp2_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/videoShotsInfo_2022-02-08 Canada at USA P1 PP2.csv")
pp_info

CAN_US_pp2_events <- CAN_US_game_events %>% filter(period == 1 & ((clock_seconds <= 215 & clock_seconds >= 96)) ) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5") 


CAN_US_pp2_keyTimes <- CAN_US_pp2_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp2_passTimes <- CAN_US_pp2_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
CAN_US_pp2_shotTimes <- CAN_US_pp2_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
CAN_US_pp2_astTimes <- vector()

CAN_US_pp2_events <- CAN_US_pp2_events %>%
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(CAN_US_pp2_passTimes)) {
  CAN_US_pp2_astTimes[i] = -1
  for (j in 1:length(CAN_US_pp2_shotTimes)) {
    if (CAN_US_pp2_passTimes[i] >= CAN_US_pp2_shotTimes[j] & CAN_US_pp2_passTimes[i] - CAN_US_pp2_shotTimes[j] <= 3) {
      CAN_US_pp2_astTimes[i] = CAN_US_pp2_passTimes[i]
      if (CAN_US_pp2_astTimes[i - 1] - CAN_US_pp2_astTimes[i] <= 3) {
        CAN_US_pp2_astTimes[i - 1] = -1
      }
    }
  }
}

for (i in 1:length(CAN_US_pp2_passTimes)) {
  CAN_US_pp2_events <- CAN_US_pp2_events %>%
    mutate(assist = if_else(clock_seconds == CAN_US_pp2_astTimes[i] |
                              CAN_US_pp2_astTimes[i] - clock_seconds <= 3 & event == "Shot" & CAN_US_pp2_astTimes[i] > 0, 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  CAN_US_pp2_events %>% filter(clock_seconds == CAN_US_pp2_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}



CAN_US_pp2_numPass <- vector()
CAN_US_pp2_totSecs <- vector()
max_secs <- max(CAN_US_pp2_events$clock_seconds)

for (i in 1:length(CAN_US_pp2_keyTimes)) {
  counter = 0
  for (j in 1:length(CAN_US_pp2_passTimes)) {
    if (CAN_US_pp2_passTimes[j] > CAN_US_pp2_keyTimes[i]) {
      counter = counter + 1
    }
  }
  if (counter > 0) {
    for (k in 1:counter) {
      CAN_US_pp2_passTimes <- CAN_US_pp2_passTimes[-1]
    }
  }
  CAN_US_pp2_numPass[i] = counter
  if (i == 1) {
    CAN_US_pp2_totSecs[i] = max_secs - CAN_US_pp2_keyTimes[i]
  }
  else {
    CAN_US_pp2_totSecs[i] = CAN_US_pp2_keyTimes[i - 1] - CAN_US_pp2_keyTimes[i]
  }
}
CAN_US_pp2_numPass
CAN_US_pp2_totSecs

CAN_US_pp2_events_updated <- CAN_US_pp2_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(CAN_US_pp2_keyTimes)) {
  CAN_US_pp2_events_updated <- CAN_US_pp2_events_updated %>%
    mutate(numPass = if_else(clock_seconds == CAN_US_pp2_keyTimes[i] & event != "Play",
                             CAN_US_pp2_numPass[i], numPass),
           totSecs = if_else(clock_seconds == CAN_US_pp2_keyTimes[i] & event != "Play",
                             CAN_US_pp2_totSecs[i], totSecs))
}

CAN_US_pp2_events_updated <- CAN_US_pp2_events_updated %>% filter(period == 1 & ((clock_seconds <= 215 & clock_seconds >= 143)|(clock_seconds <= 136 & clock_seconds >= 110) | (clock_seconds <= 106 & clock_seconds >= 96)) ) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(CAN_US_pp2_tracking$frame_id)
min_frame <- min(CAN_US_pp2_tracking$frame_id)
max_secs <- max(CAN_US_pp2_events_updated$clock_seconds)
min_secs <- min(CAN_US_pp2_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    CAN_US_pp2_tracking <- CAN_US_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    CAN_US_pp2_tracking <- CAN_US_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

CAN_US_pp2_trackRost <- left_join(CAN_US_pp2_tracking, CAN_US_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
CAN_US_pp2_eventTrack <- left_join(CAN_US_pp2_events_updated, CAN_US_pp2_trackRost, by = c("clock_seconds" = "clock_seconds"))

CAN_US_pp2_assistTrack <- CAN_US_pp2_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_centroid))

CAN_US_pp2_shots <- CAN_US_pp2_eventTrack %>% filter(event == "Shot") %>%  
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "Canada"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid, na.rm = TRUE)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

CAN_US_pp2_shotTimes <- CAN_US_pp2_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp2_rebounds <- vector()
for (i in 1:length(CAN_US_pp2_shotTimes)) {
  if (i == 1) {
    CAN_US_pp2_rebounds[i] = 0
  }
  else {
    if (CAN_US_pp2_shotTimes[i] - CAN_US_pp2_shotTimes[i - 1] < 2) {
      CAN_US_pp2_rebounds[i] = 1
    }
    else {
      CAN_US_pp2_rebounds[i] = 0
    }
  }
}
for (i in 1:length(CAN_US_pp2_shotTimes)) {
  CAN_US_pp2_shots <- CAN_US_pp2_shots %>%
    mutate(rebound = if_else(clock_seconds == CAN_US_pp2_shotTimes[i],
                             CAN_US_pp2_rebounds[i], rebound))
}

CAN_US_pp2_shotProb <- CAN_US_pp2_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

dist_moved <- CAN_US_pp2_eventTrack %>% filter((event == "Play" | event == "Shot") & assist == TRUE) %>%
  filter(team_name.y == "Canada") %>%
  group_by(clock_seconds, event, frame_id) %>% 
  mutate(frame_total = n()) 
  ungroup() %>%

  group_by(track_id, event, clock_seconds) %>%
  filter(event == "Shot" & frame_id == max(frame_id[frame_total == max(frame_total)]) | event == "Play" & frame_id == min(frame_id[frame_total == max(frame_total)])) %>%
  select(clock_seconds, event, frame_id, track_id,x_ft, y_ft) %>%
  select(-c(frame_id))
  ungroup() %>%
  pivot_wider(names_from = event, values_from = c(x_ft,y_ft)) %>%
  mutate(distance_moved = sqrt((x_ft_Shot - x_ft_Play)^2 + (y_ft_Shot - y_ft_Play)^2)) %>%
  group_by(clock_seconds) %>%
  summarise(def_distance_moved = mean(distance_moved))

CAN_US_pp2_full <- CAN_US_pp2_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

CAN_US_pp2_shotProb_goals <- CAN_US_pp2_full %>% filter(event_successful == TRUE)
```

# PowerPlay 3
```{r}
CAN_US_pp3_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA P2 PP3.csv") %>% mutate(clock_seconds = 0) 
CAN_US_pp3_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/videoShotsInfo_2022-02-08 Canada at USA P2 PP3.csv")
pp_info

CAN_US_pp3_events <- CAN_US_game_events %>% filter(period == 2 & ((clock_seconds <= 990 & clock_seconds >= 871))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

CAN_US_pp3_keyTimes <- CAN_US_pp3_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp3_passTimes <- CAN_US_pp3_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
CAN_US_pp3_shotTimes <- CAN_US_pp3_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
CAN_US_pp3_astTimes <- vector()

CAN_US_pp3_events <- CAN_US_pp3_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))
  

for(i in 1:length(CAN_US_pp3_passTimes)) {
  CAN_US_pp3_astTimes[i] = -1
  for (j in 1:length(CAN_US_pp3_shotTimes)) {
    if (CAN_US_pp3_passTimes[i] >= CAN_US_pp3_shotTimes[j] & CAN_US_pp3_passTimes[i] - CAN_US_pp3_shotTimes[j] <= 3) {
      CAN_US_pp3_astTimes[i] = CAN_US_pp3_passTimes[i]
      if(length(CAN_US_pp3_astTimes) > 1) {
        if (CAN_US_pp3_astTimes[i - 1] - CAN_US_pp3_astTimes[i] <= 3 & CAN_US_pp3_astTimes[i] > 0) {
          CAN_US_pp3_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(CAN_US_pp3_passTimes)) {
  CAN_US_pp3_events <- CAN_US_pp3_events %>%
    mutate(assist = if_else(clock_seconds == CAN_US_pp3_astTimes[i] |
                              CAN_US_pp3_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  CAN_US_pp3_events %>% filter(clock_seconds == CAN_US_pp3_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

CAN_US_pp3_numPass <- vector()
CAN_US_pp3_totSecs <- vector()
max_secs <- max(CAN_US_pp3_events$clock_seconds)

for (i in 1:length(CAN_US_pp3_keyTimes)) {
  counter = 0
  for (j in 1:length(CAN_US_pp3_passTimes)) {
    if (CAN_US_pp3_passTimes[j] > CAN_US_pp3_keyTimes[i]) {
      counter = counter + 1
    }
  }
  if (counter > 0) {
    for (k in 1:counter) {
      CAN_US_pp3_passTimes <- CAN_US_pp3_passTimes[-1]
    }
  }
  CAN_US_pp3_numPass[i] = counter
  if (i == 1) {
    CAN_US_pp3_totSecs[i] = max_secs - CAN_US_pp3_keyTimes[i]
  }
  else {
    CAN_US_pp3_totSecs[i] = CAN_US_pp3_keyTimes[i - 1] - CAN_US_pp3_keyTimes[i]
  }
}
CAN_US_pp3_numPass
CAN_US_pp3_totSecs

CAN_US_pp3_events_updated <- CAN_US_pp3_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(CAN_US_pp3_keyTimes)) {
  CAN_US_pp3_events_updated <- CAN_US_pp3_events_updated %>%
    mutate(numPass = if_else(clock_seconds == CAN_US_pp3_keyTimes[i] & event != "Play",
                             CAN_US_pp3_numPass[i], numPass),
           totSecs = if_else(clock_seconds == CAN_US_pp3_keyTimes[i] & event != "Play",
                             CAN_US_pp3_totSecs[i], totSecs))
}

CAN_US_pp3_events_updated <- CAN_US_pp3_events_updated %>% filter(period == 2 & ((clock_seconds <= 990 & clock_seconds >= 917)|(clock_seconds <= 910 & clock_seconds >= 884) | (clock_seconds <= 880 & clock_seconds >= 871))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(CAN_US_pp3_tracking$frame_id)
min_frame <- min(CAN_US_pp3_tracking$frame_id)
max_secs <- max(CAN_US_pp3_events_updated$clock_seconds)
min_secs <- min(CAN_US_pp3_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    CAN_US_pp3_tracking <- CAN_US_pp3_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    CAN_US_pp3_tracking <- CAN_US_pp3_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}


CAN_US_pp3_trackRost <- left_join(CAN_US_pp3_tracking, CAN_US_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
CAN_US_pp3_eventTrack <- left_join(CAN_US_pp3_events_updated, CAN_US_pp3_trackRost, by = c("clock_seconds" = "clock_seconds"))

CAN_US_pp3_assistTrack <- CAN_US_pp3_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_centroid))

CAN_US_pp3_shots <- CAN_US_pp3_eventTrack %>% filter(event == "Shot") %>%  
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*((y_coord/(189 - x_coord)*(180/pi))))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "Canada"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid, na.rm = TRUE)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

CAN_US_pp3_shotTimes <- CAN_US_pp3_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp3_rebounds <- vector()
for (i in 1:length(CAN_US_pp3_shotTimes)) {
  if (i == 1) {
    CAN_US_pp3_rebounds[i] = 0
  }
  else {
    if (CAN_US_pp3_shotTimes[i] - CAN_US_pp3_shotTimes[i - 1] < 2) {
      CAN_US_pp3_rebounds[i] = 1
    }
    else {
      CAN_US_pp3_rebounds[i] = 0
    }
  }
}
for (i in 1:length(CAN_US_pp3_shotTimes)) {
  CAN_US_pp3_shots <- CAN_US_pp3_shots %>%
    mutate(rebound = if_else(clock_seconds == CAN_US_pp3_shotTimes[i],
                             CAN_US_pp3_rebounds[i], rebound))
}

CAN_US_pp3_shotProb <- CAN_US_pp3_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

CAN_US_pp3_full <- CAN_US_pp3_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

CAN_US_pp3_shotProb_goals <- CAN_US_pp3_full %>% filter(event_successful == TRUE)
```

# PowerPlay 5
```{r}
CAN_US_pp5_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA P2 pp5.csv") %>% mutate(clock_seconds = 0) 
CAN_US_pp5_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/videoShotsInfo_2022-02-08 Canada at USA P2 pp5.csv")
pp_info


CAN_US_pp5_events <- CAN_US_game_events %>% filter(period == 2 & ((clock_seconds <= 272 & clock_seconds >= 128))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

CAN_US_pp5_keyTimes <- CAN_US_pp5_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry" |
                                                      event == "Takeaway") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp5_passTimes <- CAN_US_pp5_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
CAN_US_pp5_shotTimes <- CAN_US_pp5_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
CAN_US_pp5_astTimes <- vector()

CAN_US_pp5_events <- CAN_US_pp5_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(CAN_US_pp5_passTimes)) {
  CAN_US_pp5_astTimes[i] = -1
  for (j in 1:length(CAN_US_pp5_shotTimes)) {
    if (CAN_US_pp5_passTimes[i] >= CAN_US_pp5_shotTimes[j] & CAN_US_pp5_passTimes[i] - CAN_US_pp5_shotTimes[j] <= 3) {
      CAN_US_pp5_astTimes[i] = CAN_US_pp5_passTimes[i]
      if (length(CAN_US_pp5_astTimes) > 1) {
        if (CAN_US_pp5_astTimes[i - 1] - CAN_US_pp5_astTimes[i] <= 3 & CAN_US_pp5_astTimes[i] > 0) {
          CAN_US_pp5_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(CAN_US_pp5_passTimes)) {
  CAN_US_pp5_events <- CAN_US_pp5_events %>%
    mutate(assist = if_else(clock_seconds == CAN_US_pp5_astTimes[i] |
                              CAN_US_pp5_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  CAN_US_pp5_events %>% filter(clock_seconds == CAN_US_pp5_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

CAN_US_pp5_numPass <- vector()
CAN_US_pp5_totSecs <- vector()
max_secs <- max(CAN_US_pp5_events$clock_seconds)

for (i in 1:length(CAN_US_pp5_keyTimes)) {
  if (length(CAN_US_pp5_passTimes) == 0) {
    CAN_US_pp5_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(CAN_US_pp5_passTimes)) {
      if (CAN_US_pp5_passTimes[j] > CAN_US_pp5_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        CAN_US_pp5_passTimes <- CAN_US_pp5_passTimes[-1]
      }
    }
    CAN_US_pp5_numPass[i] = counter
  }
  if (i == 1) {
    CAN_US_pp5_totSecs[i] = max_secs - CAN_US_pp5_keyTimes[i]
  }
  else {
    CAN_US_pp5_totSecs[i] = CAN_US_pp5_keyTimes[i - 1] - CAN_US_pp5_keyTimes[i]
  }
  
}
CAN_US_pp5_numPass
CAN_US_pp5_totSecs

CAN_US_pp5_events_updated <- CAN_US_pp5_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(CAN_US_pp5_keyTimes)) {
  CAN_US_pp5_events_updated <- CAN_US_pp5_events_updated %>%
    mutate(numPass = if_else(clock_seconds == CAN_US_pp5_keyTimes[i] & event != "Play",
                             CAN_US_pp5_numPass[i], numPass),
           totSecs = if_else(clock_seconds == CAN_US_pp5_keyTimes[i] & event != "Play",
                             CAN_US_pp5_totSecs[i], totSecs))
}

CAN_US_pp5_events_updated <- CAN_US_pp5_events_updated %>% filter(period == 2 & ((clock_seconds <= 272 & clock_seconds >= 250)|(clock_seconds <= 230 & clock_seconds >= 204) | (clock_seconds <= 196 & clock_seconds >= 188) | (clock_seconds <= 180 & clock_seconds >= 169) | (clock_seconds <= 167 & clock_seconds >= 128))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(CAN_US_pp5_tracking$frame_id)
min_frame <- min(CAN_US_pp5_tracking$frame_id)
max_secs <- max(CAN_US_pp5_events_updated$clock_seconds)
min_secs <- min(CAN_US_pp5_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    CAN_US_pp5_tracking <- CAN_US_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    CAN_US_pp5_tracking <- CAN_US_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

CAN_US_pp5_trackRost <- left_join(CAN_US_pp5_tracking, CAN_US_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
CAN_US_pp5_eventTrack <- left_join(CAN_US_pp5_events_updated, CAN_US_pp5_trackRost, by = c("clock_seconds" = "clock_seconds"))

CAN_US_pp5_assistTrack <- CAN_US_pp5_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_centroid))

CAN_US_pp5_shots <- CAN_US_pp5_eventTrack %>% filter(event == "Shot") %>%  
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "Canada"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid, na.rm = TRUE)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

CAN_US_pp5_shotTimes <- CAN_US_pp5_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp5_rebounds <- vector()
for (i in 1:length(CAN_US_pp5_shotTimes)) {
  if (i == 1) {
    CAN_US_pp5_rebounds[i] = 0
  }
  else {
    if (CAN_US_pp5_shotTimes[i] - CAN_US_pp5_shotTimes[i - 1] < 2) {
      CAN_US_pp5_rebounds[i] = 1
    }
    else {
      CAN_US_pp5_rebounds[i] = 0
    }
  }
}
for (i in 1:length(CAN_US_pp5_shotTimes)) {
  CAN_US_pp5_shots <- CAN_US_pp5_shots %>%
    mutate(rebound = if_else(clock_seconds == CAN_US_pp5_shotTimes[i],
                             CAN_US_pp5_rebounds[i], rebound))
}

CAN_US_pp5_shotProb <- CAN_US_pp5_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

CAN_US_pp5_full <- CAN_US_pp5_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

CAN_US_pp5_shotProb_goals <- CAN_US_pp5_full %>% filter(event_successful == TRUE)
```

# PowerPlay 6
```{r}
CAN_US_pp6_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA P3 pp6.csv") %>% mutate(clock_seconds = 0) 
CAN_US_pp6_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 Canada at USA/videoShotsInfo_2022-02-08 Canada at USA P3 pp6.csv")
pp_info


CAN_US_pp6_events <- CAN_US_game_events %>% filter(period == 3 & ((clock_seconds <= 545 & clock_seconds >= 481))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

CAN_US_pp6_keyTimes <- CAN_US_pp6_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry" |
                                                      event == "Takeaway") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp6_passTimes <- CAN_US_pp6_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
CAN_US_pp6_shotTimes <- CAN_US_pp6_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
CAN_US_pp6_astTimes <- vector()

CAN_US_pp6_events <- CAN_US_pp6_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(CAN_US_pp6_passTimes)) {
  CAN_US_pp6_astTimes[i] = -1
  for (j in 1:length(CAN_US_pp6_shotTimes)) {
    if (CAN_US_pp6_passTimes[i] >= CAN_US_pp6_shotTimes[j] & CAN_US_pp6_passTimes[i] - CAN_US_pp6_shotTimes[j] <= 3) {
      CAN_US_pp6_astTimes[i] = CAN_US_pp6_passTimes[i]
      if(length(CAN_US_pp6_astTimes) > 1) {
        if (CAN_US_pp6_astTimes[i - 1] - CAN_US_pp6_astTimes[i] <= 3 & CAN_US_pp6_astTimes[i] > 0) {
          CAN_US_pp6_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(CAN_US_pp6_passTimes)) {
  CAN_US_pp6_events <- CAN_US_pp6_events %>%
    mutate(assist = if_else(clock_seconds == CAN_US_pp6_astTimes[i] |
                              CAN_US_pp6_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  CAN_US_pp6_events %>% filter(clock_seconds == CAN_US_pp6_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

CAN_US_pp6_numPass <- vector()
CAN_US_pp6_totSecs <- vector()
max_secs <- max(CAN_US_pp6_events$clock_seconds)

for (i in 1:length(CAN_US_pp6_keyTimes)) {
  if (length(CAN_US_pp6_passTimes) == 0) {
    CAN_US_pp6_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(CAN_US_pp6_passTimes)) {
      if (CAN_US_pp6_passTimes[j] > CAN_US_pp6_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        CAN_US_pp6_passTimes <- CAN_US_pp6_passTimes[-1]
      }
    }
    CAN_US_pp6_numPass[i] = counter
  }
  if (i == 1) {
    CAN_US_pp6_totSecs[i] = max_secs - CAN_US_pp6_keyTimes[i]
  }
  else {
    CAN_US_pp6_totSecs[i] = CAN_US_pp6_keyTimes[i - 1] - CAN_US_pp6_keyTimes[i]
  }
  
}
CAN_US_pp6_numPass
CAN_US_pp6_totSecs

CAN_US_pp6_events_updated <- CAN_US_pp6_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(CAN_US_pp6_keyTimes)) {
  CAN_US_pp6_events_updated <- CAN_US_pp6_events_updated %>%
    mutate(numPass = if_else(clock_seconds == CAN_US_pp6_keyTimes[i] & event != "Play",
                             CAN_US_pp6_numPass[i], numPass),
           totSecs = if_else(clock_seconds == CAN_US_pp6_keyTimes[i] & event != "Play",
                             CAN_US_pp6_totSecs[i], totSecs))
}

CAN_US_pp6_events_updated <- CAN_US_pp6_events_updated %>% filter(period == 3 & ((clock_seconds <= 545 & clock_seconds >= 532)|(clock_seconds <= 487 & clock_seconds >= 481))) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "Canada" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(CAN_US_pp6_tracking$frame_id)
min_frame <- min(CAN_US_pp6_tracking$frame_id)
max_secs <- max(CAN_US_pp6_events_updated$clock_seconds)
min_secs <- min(CAN_US_pp6_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    CAN_US_pp6_tracking <- CAN_US_pp6_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    CAN_US_pp6_tracking <- CAN_US_pp6_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

CAN_US_pp6_trackRost <- left_join(CAN_US_pp6_tracking, CAN_US_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
CAN_US_pp6_eventTrack <- left_join(CAN_US_pp6_events_updated, CAN_US_pp6_trackRost, by = c("clock_seconds" = "clock_seconds"))

CAN_US_pp6_assistTrack <- CAN_US_pp6_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_centroid))

CAN_US_pp6_shots <- CAN_US_pp6_eventTrack %>% filter(event == "Shot") %>%  
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "Canada"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid, na.rm = TRUE)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(Canada, na.rm = TRUE)) %>%
  pivot_longer(c(USA, Canada), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(Canada, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, Canada, USA, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

CAN_US_pp6_shotTimes <- CAN_US_pp6_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

CAN_US_pp6_rebounds <- vector()
for (i in 1:length(CAN_US_pp6_shotTimes)) {
  if (i == 1) {
    CAN_US_pp6_rebounds[i] = 0
  }
  else {
    if (CAN_US_pp6_shotTimes[i] - CAN_US_pp6_shotTimes[i - 1] < 2) {
      CAN_US_pp6_rebounds[i] = 1
    }
    else {
      CAN_US_pp6_rebounds[i] = 0
    }
  }
}
for (i in 1:length(CAN_US_pp6_shotTimes)) {
  CAN_US_pp6_shots <- CAN_US_pp6_shots %>%
    mutate(rebound = if_else(clock_seconds == CAN_US_pp6_shotTimes[i],
                             CAN_US_pp6_rebounds[i], rebound))
}

CAN_US_pp6_shotProb <- CAN_US_pp6_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

CAN_US_pp6_full <- CAN_US_pp6_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

CAN_US_pp6_shotProb_goals <- CAN_US_pp6_full %>% filter(event_successful == TRUE)
```

# Combined

```{r}
CAN_US_pp_combined <- bind_rows(CAN_US_pp1_full,
                                CAN_US_pp2_full,
                                CAN_US_pp3_full,
                                CAN_US_pp5_full,
                                CAN_US_pp6_full)
CAN_US_ast_combined <- bind_rows(CAN_US_pp1_assistTrack,
                                 CAN_US_pp2_assistTrack,
                                 CAN_US_pp3_assistTrack,
                                 CAN_US_pp5_assistTrack,
                                 CAN_US_pp6_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```

__2022-02-08 ROC at Finland__
```{r}
ROC_FIN_game_events <- play_by_play %>% filter(game_date == "8/2/2022" & (team_name == 'Olympic (Women) - Olympic Athletes from Russia' |
                                         team_name == 'Olympic (Women) - Finland')) %>% 
  mutate(team_name = fct_recode(team_name, ROC = "Olympic (Women) - Olympic Athletes from Russia", FIN = "Olympic (Women) - Finland"),
         opp_team_name = fct_recode(opp_team_name, FIN = "Olympic (Women) - Finland", ROC = "Olympic (Women) - Olympic Athletes from Russia"))
ROC_FIN_roster <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland roster.csv") %>%
  mutate(team = if_else(team == "home", "FIN", "ROC"))
```

# PowerPlay 1
```{r}
ROC_FIN_pp1_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland P1 PP1.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", team_name))
ROC_FIN_pp1_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/videoShotsInfo_2022-02-08 ROC at Finland P1 PP1.csv")
pp_info

ROC_FIN_pp1_events <- ROC_FIN_game_events %>% filter(period == 1 & (clock_seconds <= 189 & clock_seconds >= 124)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

ROC_FIN_pp1_keyTimes <- ROC_FIN_pp1_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp1_passTimes <- ROC_FIN_pp1_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
ROC_FIN_pp1_shotTimes <- ROC_FIN_pp1_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
ROC_FIN_pp1_astTimes <- vector()

ROC_FIN_pp1_events <- ROC_FIN_pp1_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(ROC_FIN_pp1_passTimes)) {
  ROC_FIN_pp1_astTimes[i] = -1
  for (j in 1:length(ROC_FIN_pp1_shotTimes)) {
    if (ROC_FIN_pp1_passTimes[i] >= ROC_FIN_pp1_shotTimes[j] & ROC_FIN_pp1_passTimes[i] - ROC_FIN_pp1_shotTimes[j] <= 3) {
      ROC_FIN_pp1_astTimes[i] = ROC_FIN_pp1_passTimes[i]
      if (length(ROC_FIN_pp1_astTimes) > 1) {
        if (ROC_FIN_pp1_astTimes[i - 1] - ROC_FIN_pp1_astTimes[i] <= 3 & ROC_FIN_pp1_astTimes[i] > 0) {
          ROC_FIN_pp1_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(ROC_FIN_pp1_passTimes)) {
  ROC_FIN_pp1_events <- ROC_FIN_pp1_events %>%
    mutate(assist = if_else(clock_seconds == ROC_FIN_pp1_astTimes[i] |
                              ROC_FIN_pp1_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  ROC_FIN_pp1_events %>% filter(clock_seconds == ROC_FIN_pp1_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

ROC_FIN_pp1_numPass <- vector()
ROC_FIN_pp1_totSecs <- vector()
max_secs <- max(ROC_FIN_pp1_events$clock_seconds)

for (i in 1:length(ROC_FIN_pp1_keyTimes)) {
  counter = 0
  for (j in 1:length(ROC_FIN_pp1_passTimes)) {
    if (ROC_FIN_pp1_passTimes[j] > ROC_FIN_pp1_keyTimes[i]) {
      counter = counter + 1
    }
  }
  if (counter > 0) {
    for (k in 1:counter) {
      ROC_FIN_pp1_passTimes <- ROC_FIN_pp1_passTimes[-1]
    }
  }
  ROC_FIN_pp1_numPass[i] = counter
  if (i == 1) {
    ROC_FIN_pp1_totSecs[i] = max_secs - ROC_FIN_pp1_keyTimes[i]
  }
  else {
    ROC_FIN_pp1_totSecs[i] = ROC_FIN_pp1_keyTimes[i - 1] - ROC_FIN_pp1_keyTimes[i]
  }
}
ROC_FIN_pp1_numPass
ROC_FIN_pp1_totSecs

ROC_FIN_pp1_events_updated <- ROC_FIN_pp1_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(ROC_FIN_pp1_keyTimes)) {
  ROC_FIN_pp1_events_updated <- ROC_FIN_pp1_events_updated %>%
    mutate(numPass = if_else(clock_seconds == ROC_FIN_pp1_keyTimes[i] & event != "Play",
                             ROC_FIN_pp1_numPass[i], numPass),
           totSecs = if_else(clock_seconds == ROC_FIN_pp1_keyTimes[i] & event != "Play",
                             ROC_FIN_pp1_totSecs[i], totSecs))
}



max_frame <- max(ROC_FIN_pp1_tracking$frame_id)
min_frame <- min(ROC_FIN_pp1_tracking$frame_id)
max_secs <- max(ROC_FIN_pp1_events_updated$clock_seconds)
min_secs <- min(ROC_FIN_pp1_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    ROC_FIN_pp1_tracking <- ROC_FIN_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    ROC_FIN_pp1_tracking <- ROC_FIN_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

ROC_FIN_pp1_trackRost <- left_join(ROC_FIN_pp1_tracking, ROC_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
ROC_FIN_pp1_eventTrack <- left_join(ROC_FIN_pp1_events_updated, ROC_FIN_pp1_trackRost, by = c("clock_seconds" = "clock_seconds"))

ROC_FIN_pp1_assistTrack <- ROC_FIN_pp1_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, ROC ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( ROC, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, ROC ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( ROC, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC ,  FIN, gk_pos, team_mean_distance_from_centroid))


ROC_FIN_pp1_shots <- ROC_FIN_pp1_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "ROC"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(ROC, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

ROC_FIN_pp1_shotTimes <- ROC_FIN_pp1_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp1_rebounds <- vector()
for (i in 1:length(ROC_FIN_pp1_shotTimes)) {
  if (i == 1) {
    ROC_FIN_pp1_rebounds[i] = 0
  }
  else {
    if (ROC_FIN_pp1_shotTimes[i] - ROC_FIN_pp1_shotTimes[i - 1] < 2) {
      ROC_FIN_pp1_rebounds[i] = 1
    }
    else {
      ROC_FIN_pp1_rebounds[i] = 0
    }
  }
}
for (i in 1:length(ROC_FIN_pp1_shotTimes)) {
  ROC_FIN_pp1_shots <- ROC_FIN_pp1_shots %>%
    mutate(rebound = if_else(clock_seconds == ROC_FIN_pp1_shotTimes[i],
                             ROC_FIN_pp1_rebounds[i], rebound))
}

ROC_FIN_pp1_shotProb <- ROC_FIN_pp1_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

ROC_FIN_pp1_full <- ROC_FIN_pp1_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

ROC_FIN_pp1_shotProb_goals <- ROC_FIN_pp1_full %>% filter(event_successful == TRUE) 
```

# PowerPlay 4 
## Shots not tracked
```{r}
ROC_FIN_pp4_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland P2 pp4.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", team_name))
ROC_FIN_pp4_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/videoShotsInfo_2022-02-08 ROC at Finland P2 pp4.csv")
pp_info

ROC_FIN_pp4_events <- ROC_FIN_game_events %>% filter(period == 2 & (clock_seconds <= 597 & clock_seconds >= 563)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

ROC_FIN_pp4_keyTimes <- ROC_FIN_pp4_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp4_passTimes <- ROC_FIN_pp4_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
ROC_FIN_pp4_shotTimes <- ROC_FIN_pp4_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
ROC_FIN_pp4_astTimes <- vector()

ROC_FIN_pp4_events <- ROC_FIN_pp4_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(ROC_FIN_pp4_passTimes)) {
  ROC_FIN_pp4_astTimes[i] = -1
  for (j in 1:length(ROC_FIN_pp4_shotTimes)) {
    if (ROC_FIN_pp4_passTimes[i] >= ROC_FIN_pp4_shotTimes[j] & ROC_FIN_pp4_passTimes[i] - ROC_FIN_pp4_shotTimes[j] <= 3) {
      ROC_FIN_pp4_astTimes[i] = ROC_FIN_pp4_passTimes[i]
      if (length(ROC_FIN_pp4_astTimes) > 1) {
        if (ROC_FIN_pp4_astTimes[i - 1] - ROC_FIN_pp4_astTimes[i] <= 3 & ROC_FIN_pp4_astTimes[i] > 0) {
          ROC_FIN_pp4_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(ROC_FIN_pp4_passTimes)) {
  ROC_FIN_pp4_events <- ROC_FIN_pp4_events %>%
    mutate(assist = if_else(clock_seconds == ROC_FIN_pp4_astTimes[i] |
                              ROC_FIN_pp4_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  ROC_FIN_pp4_events %>% filter(clock_seconds == ROC_FIN_pp4_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

ROC_FIN_pp4_numPass <- vector()
ROC_FIN_pp4_totSecs <- vector()
max_secs <- max(ROC_FIN_pp4_events$clock_seconds)

for (i in 1:length(ROC_FIN_pp4_keyTimes)) {
  counter = 0
  for (j in 1:length(ROC_FIN_pp4_passTimes)) {
    if (ROC_FIN_pp4_passTimes[j] > ROC_FIN_pp4_keyTimes[i]) {
      counter = counter + 1
    }
  }
  if (counter > 0) {
    for (k in 1:counter) {
      ROC_FIN_pp4_passTimes <- ROC_FIN_pp4_passTimes[-1]
    }
  }
  ROC_FIN_pp4_numPass[i] = counter
  if (i == 1) {
    ROC_FIN_pp4_totSecs[i] = max_secs - ROC_FIN_pp4_keyTimes[i]
  }
  else {
    ROC_FIN_pp4_totSecs[i] = ROC_FIN_pp4_keyTimes[i - 1] - ROC_FIN_pp4_keyTimes[i]
  }
}
ROC_FIN_pp4_numPass
ROC_FIN_pp4_totSecs

ROC_FIN_pp4_events_updated <- ROC_FIN_pp4_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(ROC_FIN_pp4_keyTimes)) {
  ROC_FIN_pp4_events_updated <- ROC_FIN_pp4_events_updated %>%
    mutate(numPass = if_else(clock_seconds == ROC_FIN_pp4_keyTimes[i] & event != "Play",
                             ROC_FIN_pp4_numPass[i], numPass),
           totSecs = if_else(clock_seconds == ROC_FIN_pp4_keyTimes[i] & event != "Play",
                             ROC_FIN_pp4_totSecs[i], totSecs))
}

ROC_FIN_pp4_events <- ROC_FIN_game_events %>% filter(period == 2 & (clock_seconds <= 595 & clock_seconds >= 582)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(ROC_FIN_pp4_tracking$frame_id)
min_frame <- min(ROC_FIN_pp4_tracking$frame_id)
max_secs <- max(ROC_FIN_pp4_events_updated$clock_seconds)
min_secs <- min(ROC_FIN_pp4_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    ROC_FIN_pp4_tracking <- ROC_FIN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    ROC_FIN_pp4_tracking <- ROC_FIN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

ROC_FIN_pp4_trackRost <- left_join(ROC_FIN_pp4_tracking, ROC_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
ROC_FIN_pp4_eventTrack <- left_join(ROC_FIN_pp4_events_updated, ROC_FIN_pp4_trackRost, by = c("clock_seconds" = "clock_seconds"))


ROC_FIN_pp4_shots <- ROC_FIN_pp4_eventTrack %>% filter(event == "Shot") %>%
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(rebound = -1)
  # mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  # mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
  #        distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  # pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  # group_by(clock_seconds) %>%
  # mutate(gk_pos = min(ROC, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(FIN, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  # filter(is.na(distance_from_goal) == FALSE) %>%
  # filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  # ungroup() %>%
  # group_by(clock_seconds) %>%
  # mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "ROC"], na.rm = TRUE)) %>%
  # ungroup() %>%
  # group_by(clock_seconds, team_name.y) %>%
  # mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
  #        team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  # ungroup() %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  # group_by(clock_seconds) %>%
  # mutate(def_mean_distance_from_y_middle = min(ROC, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  # mutate(def_mean_distance_from_goal = max(ROC, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  # ungroup() %>%
  # group_by(clock_seconds, team_name.y) %>%
  # mutate(centroid_x = sum(x_ft)/n(),
  #        centroid_y = sum(y_ft)/n(),
  #        distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
  #        team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  # mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  # ungroup() %>%
  # group_by(clock_seconds) %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  # mutate(def_mean_distance_from_centroid = max(ROC, na.rm = TRUE)) %>%
  # pivot_longer(c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  # pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  # mutate(def_centroid_distance_from_goal = max(ROC, na.rm = TRUE),
  #        shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
  #                                       TRUE, FALSE)) %>%
  # ungroup() %>%
  # group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  # ungroup() %>%
  # group_by(clock_seconds, track_id) %>% 
  # slice(max(frame_total)) %>%
  # select(-c(frame_total, ROC, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  # mutate(rebound = -1)

ROC_FIN_pp4_shotTimes <- ROC_FIN_pp4_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp4_rebounds <- vector()
for (i in 1:length(ROC_FIN_pp4_shotTimes)) {
  if (i == 1) {
    ROC_FIN_pp4_rebounds[i] = 0
  }
  else {
    if (ROC_FIN_pp4_shotTimes[i] - ROC_FIN_pp4_shotTimes[i - 1] < 2) {
      ROC_FIN_pp4_rebounds[i] = 1
    }
    else {
      ROC_FIN_pp4_rebounds[i] = 0
    }
  }
}
for (i in 1:length(ROC_FIN_pp4_shotTimes)) {
  ROC_FIN_pp4_shots <- ROC_FIN_pp4_shots %>%
    mutate(rebound = if_else(clock_seconds == ROC_FIN_pp4_shotTimes[i],
                             ROC_FIN_pp4_rebounds[i], rebound))
}

ROC_FIN_pp4_shotProb <- ROC_FIN_pp4_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

ROC_FIN_pp4_full <- ROC_FIN_pp4_shotProb %>% select(c(3,4,6,7,12:16,20:24,35:39))

ROC_FIN_pp4_shotProb_goals <- ROC_FIN_pp4_full %>% filter(event_successful == TRUE) 
```

# PowerPlay 5 
## NOT ENOUGH FRAMES (pp_info says there should be 3590 frames but there is only 1590)
```{r}
ROC_FIN_pp5_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland P2 PP5.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", team_name))
ROC_FIN_pp5_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/videoShotsInfo_2022-02-08 ROC at Finland P2 pp5.csv")
pp_info

ROC_FIN_pp5_events <- ROC_FIN_game_events %>% filter(period == 2 & (clock_seconds <= 458 & clock_seconds >= 338)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

ROC_FIN_pp5_keyTimes <- ROC_FIN_pp5_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp5_passTimes <- ROC_FIN_pp5_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
ROC_FIN_pp5_shotTimes <- ROC_FIN_pp5_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
ROC_FIN_pp5_astTimes <- vector()

ROC_FIN_pp5_events <- ROC_FIN_pp5_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(ROC_FIN_pp5_passTimes)) {
  ROC_FIN_pp5_astTimes[i] = -1
  for (j in 1:length(ROC_FIN_pp5_shotTimes)) {
    if (ROC_FIN_pp5_passTimes[i] >= ROC_FIN_pp5_shotTimes[j] & ROC_FIN_pp5_passTimes[i] - ROC_FIN_pp5_shotTimes[j] <= 3) {
      ROC_FIN_pp5_astTimes[i] = ROC_FIN_pp5_passTimes[i]
      if (length(ROC_FIN_pp5_astTimes) > 1) {
        if (ROC_FIN_pp5_astTimes[i - 1] - ROC_FIN_pp5_astTimes[i] <= 3 & ROC_FIN_pp5_astTimes[i] > 0) {
          ROC_FIN_pp5_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(ROC_FIN_pp5_passTimes)) {
  ROC_FIN_pp5_events <- ROC_FIN_pp5_events %>%
    mutate(assist = if_else(clock_seconds == ROC_FIN_pp5_astTimes[i] |
                              ROC_FIN_pp5_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  ROC_FIN_pp5_events %>% filter(clock_seconds == ROC_FIN_pp5_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

ROC_FIN_pp5_numPass <- vector()
ROC_FIN_pp5_totSecs <- vector()
max_secs <- max(ROC_FIN_pp5_events$clock_seconds)

for (i in 1:length(ROC_FIN_pp5_keyTimes)) {
  if (length(ROC_FIN_pp5_passTimes) == 0) {
    ROC_FIN_pp5_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(ROC_FIN_pp5_passTimes)) {
      if (ROC_FIN_pp5_passTimes[j] > ROC_FIN_pp5_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        ROC_FIN_pp5_passTimes <- ROC_FIN_pp5_passTimes[-1]
      }
    }
    ROC_FIN_pp5_numPass[i] = counter
  }
  if (i == 1) {
    ROC_FIN_pp5_totSecs[i] = max_secs - ROC_FIN_pp5_keyTimes[i]
  }
  else {
    ROC_FIN_pp5_totSecs[i] = ROC_FIN_pp5_keyTimes[i - 1] - ROC_FIN_pp5_keyTimes[i]
  }
}
ROC_FIN_pp5_numPass
ROC_FIN_pp5_totSecs

ROC_FIN_pp5_events_updated <- ROC_FIN_pp5_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(ROC_FIN_pp5_keyTimes)) {
  ROC_FIN_pp5_events_updated <- ROC_FIN_pp5_events_updated %>%
    mutate(numPass = if_else(clock_seconds == ROC_FIN_pp5_keyTimes[i] & event != "Play",
                             ROC_FIN_pp5_numPass[i], numPass),
           totSecs = if_else(clock_seconds == ROC_FIN_pp5_keyTimes[i] & event != "Play",
                             ROC_FIN_pp5_totSecs[i], totSecs))
}

ROC_FIN_pp5_events_updated <- ROC_FIN_pp5_events_updated %>% filter(period == 2 & (clock_seconds <= 456 & clock_seconds >= 446) |
                                                                       (clock_seconds <= 424 & clock_seconds >= 416) |
                                                                       (clock_seconds <= 411 & clock_seconds >= 336)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(ROC_FIN_pp5_tracking$frame_id)
min_frame <- min(ROC_FIN_pp5_tracking$frame_id)
max_secs <- max(ROC_FIN_pp5_events_updated$clock_seconds)
min_secs <- min(ROC_FIN_pp5_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    ROC_FIN_pp5_tracking <- ROC_FIN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    ROC_FIN_pp5_tracking <- ROC_FIN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

ROC_FIN_pp5_trackRost <- left_join(ROC_FIN_pp5_tracking, ROC_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
ROC_FIN_pp5_eventTrack <- left_join(ROC_FIN_pp5_events_updated, ROC_FIN_pp5_trackRost, by = c("clock_seconds" = "clock_seconds"))


ROC_FIN_pp5_shots <- ROC_FIN_pp5_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(rebound = -1)
  # mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  # mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
  #        distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  # pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  # group_by(clock_seconds) %>%
  # mutate(gk_pos = min(FIN, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(FIN, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  # filter(is.na(distance_from_goal) == FALSE) %>%
  # filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  # ungroup() %>%
  # group_by(clock_seconds) %>%
  # mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "FIN"], na.rm = TRUE)) %>%
  # ungroup() %>%
  # group_by(clock_seconds, team_name.y) %>%
  # mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
  #        team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  # ungroup() %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  # group_by(clock_seconds) %>%
  # mutate(def_mean_distance_from_y_middle = min(FIN, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  # mutate(def_mean_distance_from_goal = max(FIN, na.rm = TRUE)) %>%
  # pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  # ungroup() %>%
  # group_by(clock_seconds, team_name.y) %>%
  # mutate(centroid_x = sum(x_ft)/n(),
  #        centroid_y = sum(y_ft)/n(),
  #        distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
  #        team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  # mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  # ungroup() %>%
  # group_by(clock_seconds) %>%
  # pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  # mutate(def_mean_distance_from_centroid = max(FIN, na.rm = TRUE)) %>%
  # pivot_longer(c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  # pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  # mutate(def_centroid_distance_from_goal = max(FIN, na.rm = TRUE),
  #        shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
  #                                       TRUE, FALSE)) %>%
  # ungroup() %>%
  # group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  # ungroup() %>%
  # group_by(clock_seconds, track_id) %>% 
  # slice(max(frame_total)) %>%
  # select(-c(frame_total, ROC, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  # mutate(rebound = -1)

ROC_FIN_pp5_shotTimes <- ROC_FIN_pp5_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp5_rebounds <- vector()
for (i in 1:length(ROC_FIN_pp5_shotTimes)) {
  if (i == 1) {
    ROC_FIN_pp5_rebounds[i] = 0
  }
  else {
    if (ROC_FIN_pp5_shotTimes[i] - ROC_FIN_pp5_shotTimes[i - 1] < 2) {
      ROC_FIN_pp5_rebounds[i] = 1
    }
    else {
      ROC_FIN_pp5_rebounds[i] = 0
    }
  }
}
for (i in 1:length(ROC_FIN_pp5_shotTimes)) {
  ROC_FIN_pp5_shots <- ROC_FIN_pp5_shots %>%
    mutate(rebound = if_else(clock_seconds == ROC_FIN_pp5_shotTimes[i],
                             ROC_FIN_pp5_rebounds[i], rebound))
}

ROC_FIN_pp5_shotProb <- ROC_FIN_pp5_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>% 
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

ROC_FIN_pp5_full <- ROC_FIN_pp5_shotProb %>% select(c(3,4,6,7,12:16,20:24,35:39))

ROC_FIN_pp5_shotProb_goals <- ROC_FIN_pp5_full %>% filter(event_successful == TRUE) 
```

# PowerPlay 6
```{r}
ROC_FIN_pp6_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland P3 pp6.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", team_name))
ROC_FIN_pp6_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-08 ROC at Finland/videoShotsInfo_2022-02-08 ROC at Finland P3 pp6.csv")
pp_info

ROC_FIN_pp6_events <- ROC_FIN_game_events %>% filter(period == 3 & (clock_seconds <= 880 & clock_seconds >= 764)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

ROC_FIN_pp6_keyTimes <- ROC_FIN_pp6_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp6_passTimes <- ROC_FIN_pp6_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
ROC_FIN_pp6_shotTimes <- ROC_FIN_pp6_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
ROC_FIN_pp6_astTimes <- vector()

ROC_FIN_pp6_events <- ROC_FIN_pp6_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(ROC_FIN_pp6_passTimes)) {
  ROC_FIN_pp6_astTimes[i] = -1
  for (j in 1:length(ROC_FIN_pp6_shotTimes)) {
    if (ROC_FIN_pp6_passTimes[i] >= ROC_FIN_pp6_shotTimes[j] & ROC_FIN_pp6_passTimes[i] - ROC_FIN_pp6_shotTimes[j] <= 3) {
      ROC_FIN_pp6_astTimes[i] = ROC_FIN_pp6_passTimes[i]
      if (length(ROC_FIN_pp6_astTimes) > 1) {
        if (ROC_FIN_pp6_astTimes[i - 1] - ROC_FIN_pp6_astTimes[i] <= 3 & ROC_FIN_pp6_astTimes[i] > 0) {
          ROC_FIN_pp6_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(ROC_FIN_pp6_passTimes)) {
  ROC_FIN_pp6_events <- ROC_FIN_pp6_events %>%
    mutate(assist = if_else(clock_seconds == ROC_FIN_pp6_astTimes[i] |
                              ROC_FIN_pp6_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  ROC_FIN_pp6_events %>% filter(clock_seconds == ROC_FIN_pp6_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

ROC_FIN_pp6_numPass <- vector()
ROC_FIN_pp6_totSecs <- vector()
max_secs <- max(ROC_FIN_pp6_events$clock_seconds)

for (i in 1:length(ROC_FIN_pp6_keyTimes)) {
  if (length(ROC_FIN_pp6_passTimes) == 0) {
    ROC_FIN_pp6_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(ROC_FIN_pp6_passTimes)) {
      if (ROC_FIN_pp6_passTimes[j] > ROC_FIN_pp6_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        ROC_FIN_pp6_passTimes <- ROC_FIN_pp6_passTimes[-1]
      }
    }
    ROC_FIN_pp6_numPass[i] = counter
  }
  if (i == 1) {
    ROC_FIN_pp6_totSecs[i] = max_secs - ROC_FIN_pp6_keyTimes[i]
  }
  else {
    ROC_FIN_pp6_totSecs[i] = ROC_FIN_pp6_keyTimes[i - 1] - ROC_FIN_pp6_keyTimes[i]
  }
}
ROC_FIN_pp6_numPass
ROC_FIN_pp6_totSecs

ROC_FIN_pp6_events_updated <- ROC_FIN_pp6_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(ROC_FIN_pp6_keyTimes)) {
  ROC_FIN_pp6_events_updated <- ROC_FIN_pp6_events_updated %>%
    mutate(numPass = if_else(clock_seconds == ROC_FIN_pp6_keyTimes[i] & event != "Play",
                             ROC_FIN_pp6_numPass[i], numPass),
           totSecs = if_else(clock_seconds == ROC_FIN_pp6_keyTimes[i] & event != "Play",
                             ROC_FIN_pp6_totSecs[i], totSecs))
}

ROC_FIN_pp6_events_updated <- ROC_FIN_pp6_events_updated %>% filter(period == 3 & (clock_seconds <= 878 & clock_seconds >= 858)|
                                                                      (clock_seconds <= 854 & clock_seconds >= 824) |
                                                                      (clock_seconds <= 818 & clock_seconds >= 764)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(ROC_FIN_pp6_tracking$frame_id)
min_frame <- min(ROC_FIN_pp6_tracking$frame_id)
max_secs <- max(ROC_FIN_pp6_events_updated$clock_seconds)
min_secs <- min(ROC_FIN_pp6_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    ROC_FIN_pp6_tracking <- ROC_FIN_pp6_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    ROC_FIN_pp6_tracking <- ROC_FIN_pp6_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

ROC_FIN_pp6_trackRost <- left_join(ROC_FIN_pp6_tracking, ROC_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
ROC_FIN_pp6_eventTrack <- left_join(ROC_FIN_pp6_events_updated, ROC_FIN_pp6_trackRost, by = c("clock_seconds" = "clock_seconds"))

ROC_FIN_pp6_assistTrack <- ROC_FIN_pp6_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, ROC ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( ROC, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, ROC ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( ROC, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

ROC_FIN_pp6_shots <- ROC_FIN_pp6_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% select(-c(`NA`)) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "ROC"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(c(ROC, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(ROC, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

ROC_FIN_pp6_shotTimes <- ROC_FIN_pp6_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

ROC_FIN_pp6_rebounds <- vector()
for (i in 1:length(ROC_FIN_pp6_shotTimes)) {
  if (i == 1) {
    ROC_FIN_pp6_rebounds[i] = 0
  }
  else {
    if (ROC_FIN_pp6_shotTimes[i] - ROC_FIN_pp6_shotTimes[i - 1] < 2) {
      ROC_FIN_pp6_rebounds[i] = 1
    }
    else {
      ROC_FIN_pp6_rebounds[i] = 0
    }
  }
}
for (i in 1:length(ROC_FIN_pp6_shotTimes)) {
  ROC_FIN_pp6_shots <- ROC_FIN_pp6_shots %>%
    mutate(rebound = if_else(clock_seconds == ROC_FIN_pp6_shotTimes[i],
                             ROC_FIN_pp6_rebounds[i], rebound))
}

ROC_FIN_pp6_shotProb <- ROC_FIN_pp6_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

ROC_FIN_pp6_full <- ROC_FIN_pp6_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

ROC_FIN_pp6_shotProb_goals <- ROC_FIN_pp6_full %>% filter(event_successful == TRUE)
```

# Combined
```{r}
ROC_FIN_pp_combined <- bind_rows(ROC_FIN_pp1_full,
                                ROC_FIN_pp4_full,
                                ROC_FIN_pp5_full,
                                ROC_FIN_pp6_full)
ROC_FIN_ast_combined <- bind_rows(ROC_FIN_pp1_assistTrack,
                                  ROC_FIN_pp6_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```



__2022-02-12 Switzerland at ROC__
```{r}
SUI_ROC_game_events <- play_by_play %>% filter(game_date == "12/2/2022" & (team_name == 'Olympic (Women) - Olympic Athletes from Russia' |
                                         team_name == 'Olympic (Women) - Switzerland')) %>% 
  mutate(team_name = fct_recode(team_name, ROC = "Olympic (Women) - Olympic Athletes from Russia", SUI = "Olympic (Women) - Switzerland"),
         opp_team_name = fct_recode(opp_team_name, SUI = "Olympic (Women) - Switzerland", ROC = "Olympic (Women) - Olympic Athletes from Russia"))
SUI_ROC_roster <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/2022-02-12 Switzerland at ROC roster.csv") %>%
  mutate(team = if_else(team == "home", "ROC", "SUI"))
```

# PowerPlay 2
```{r}
SUI_ROC_pp2_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/2022-02-12 Switzerland at ROC P1 PP2.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", team_name))
SUI_ROC_pp2_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/videoShotsInfo_2022-02-12 Switzerland at ROC P1 PP2.csv")
pp_info

SUI_ROC_pp2_events <- SUI_ROC_game_events %>% filter(period == 1 & (clock_seconds <= 492 & clock_seconds >= 372)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_ROC_pp2_keyTimes <- SUI_ROC_pp2_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp2_passTimes <- SUI_ROC_pp2_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_ROC_pp2_shotTimes <- SUI_ROC_pp2_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_ROC_pp2_astTimes <- vector()

SUI_ROC_pp2_events <- SUI_ROC_pp2_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_ROC_pp2_passTimes)) {
  SUI_ROC_pp2_astTimes[i] = -1
  for (j in 1:length(SUI_ROC_pp2_shotTimes)) {
    if (SUI_ROC_pp2_passTimes[i] >= SUI_ROC_pp2_shotTimes[j] & SUI_ROC_pp2_passTimes[i] - SUI_ROC_pp2_shotTimes[j] <= 3) {
      SUI_ROC_pp2_astTimes[i] = SUI_ROC_pp2_passTimes[i]
      if (length(SUI_ROC_pp2_astTimes) > 1) {
        if (SUI_ROC_pp2_astTimes[i - 1] - SUI_ROC_pp2_astTimes[i] <= 3 & SUI_ROC_pp2_astTimes[i] > 0) {
          SUI_ROC_pp2_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_ROC_pp2_passTimes)) {
  SUI_ROC_pp2_events <- SUI_ROC_pp2_events %>%
    mutate(assist = if_else(clock_seconds == SUI_ROC_pp2_astTimes[i] |
                              SUI_ROC_pp2_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_ROC_pp2_events %>% filter(clock_seconds == SUI_ROC_pp2_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_ROC_pp2_numPass <- vector()
SUI_ROC_pp2_totSecs <- vector()
max_secs <- max(SUI_ROC_pp2_events$clock_seconds)

for (i in 1:length(SUI_ROC_pp2_keyTimes)) {
  if (length(SUI_ROC_pp2_passTimes) == 0) {
    SUI_ROC_pp2_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_ROC_pp2_passTimes)) {
      if (SUI_ROC_pp2_passTimes[j] > SUI_ROC_pp2_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_ROC_pp2_passTimes <- SUI_ROC_pp2_passTimes[-1]
      }
    }
    SUI_ROC_pp2_numPass[i] = counter
  }
  if (i == 1) {
    SUI_ROC_pp2_totSecs[i] = max_secs - SUI_ROC_pp2_keyTimes[i]
  }
  else {
    SUI_ROC_pp2_totSecs[i] = SUI_ROC_pp2_keyTimes[i - 1] - SUI_ROC_pp2_keyTimes[i]
  }
}
SUI_ROC_pp2_numPass
SUI_ROC_pp2_totSecs

SUI_ROC_pp2_events_updated <- SUI_ROC_pp2_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_ROC_pp2_keyTimes)) {
  SUI_ROC_pp2_events_updated <- SUI_ROC_pp2_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_ROC_pp2_keyTimes[i] & event != "Play",
                             SUI_ROC_pp2_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_ROC_pp2_keyTimes[i] & event != "Play",
                             SUI_ROC_pp2_totSecs[i], totSecs))
}

SUI_ROC_pp2_events_updated <- SUI_ROC_pp2_events_updated %>% filter(period == 1 & (clock_seconds <= 492 & clock_seconds >= 460)|
                                                                      (clock_seconds <= 458 & clock_seconds >= 385)|
                                                                      (clock_seconds <= 364 & clock_seconds >= 346)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_ROC_pp2_tracking$frame_id)
min_frame <- min(SUI_ROC_pp2_tracking$frame_id)
max_secs <- max(SUI_ROC_pp2_events_updated$clock_seconds)
min_secs <- min(SUI_ROC_pp2_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_ROC_pp2_tracking <- SUI_ROC_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_ROC_pp2_tracking <- SUI_ROC_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_ROC_pp2_trackRost <- left_join(SUI_ROC_pp2_tracking, SUI_ROC_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_ROC_pp2_eventTrack <- left_join(SUI_ROC_pp2_events_updated, SUI_ROC_pp2_trackRost, by = c("clock_seconds" = "clock_seconds"))


 

SUI_ROC_pp2_shots <- SUI_ROC_pp2_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_ROC_pp2_shotTimes <- SUI_ROC_pp2_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp2_rebounds <- vector()
for (i in 1:length(SUI_ROC_pp2_shotTimes)) {
  if (i == 1) {
    SUI_ROC_pp2_rebounds[i] = 0
  }
  else {
    if (SUI_ROC_pp2_shotTimes[i] - SUI_ROC_pp2_shotTimes[i - 1] < 2) {
      SUI_ROC_pp2_rebounds[i] = 1
    }
    else {
      SUI_ROC_pp2_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_ROC_pp2_shotTimes)) {
  SUI_ROC_pp2_shots <- SUI_ROC_pp2_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_ROC_pp2_shotTimes[i],
                             SUI_ROC_pp2_rebounds[i], rebound))
}

SUI_ROC_pp2_shotProb <- SUI_ROC_pp2_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_ROC_pp2_full <- SUI_ROC_pp2_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_ROC_pp2_shotProb_goals <- SUI_ROC_pp2_full %>% filter(event_successful == TRUE)
```

# PowerPlay 3
```{r}
SUI_ROC_pp3_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/2022-02-12 Switzerland at ROC P3 pp3.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", team_name))
SUI_ROC_pp3_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/videoShotsInfo_2022-02-12 Switzerland at ROC P3 pp3.csv")
pp_info

SUI_ROC_pp3_events <- SUI_ROC_game_events %>% filter(period == 3 & (clock_seconds <= 744 & clock_seconds >= 624)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_ROC_pp3_keyTimes <- SUI_ROC_pp3_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp3_passTimes <- SUI_ROC_pp3_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_ROC_pp3_shotTimes <- SUI_ROC_pp3_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_ROC_pp3_astTimes <- vector()

SUI_ROC_pp3_events <- SUI_ROC_pp3_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_ROC_pp3_passTimes)) {
  SUI_ROC_pp3_astTimes[i] = -1
  for (j in 1:length(SUI_ROC_pp3_shotTimes)) {
    if (SUI_ROC_pp3_passTimes[i] >= SUI_ROC_pp3_shotTimes[j] & SUI_ROC_pp3_passTimes[i] - SUI_ROC_pp3_shotTimes[j] <= 3) {
      SUI_ROC_pp3_astTimes[i] = SUI_ROC_pp3_passTimes[i]
      if (length(SUI_ROC_pp3_astTimes) > 1) {
        if (SUI_ROC_pp3_astTimes[i - 1] - SUI_ROC_pp3_astTimes[i] <= 3 & SUI_ROC_pp3_astTimes[i] > 0) {
          SUI_ROC_pp3_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_ROC_pp3_passTimes)) {
  SUI_ROC_pp3_events <- SUI_ROC_pp3_events %>%
    mutate(assist = if_else(clock_seconds == SUI_ROC_pp3_astTimes[i] |
                              SUI_ROC_pp3_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_ROC_pp3_events %>% filter(clock_seconds == SUI_ROC_pp3_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_ROC_pp3_numPass <- vector()
SUI_ROC_pp3_totSecs <- vector()
max_secs <- max(SUI_ROC_pp3_events$clock_seconds)

for (i in 1:length(SUI_ROC_pp3_keyTimes)) {
  if (length(SUI_ROC_pp3_passTimes) == 0) {
    SUI_ROC_pp3_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_ROC_pp3_passTimes)) {
      if (SUI_ROC_pp3_passTimes[j] > SUI_ROC_pp3_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_ROC_pp3_passTimes <- SUI_ROC_pp3_passTimes[-1]
      }
    }
    SUI_ROC_pp3_numPass[i] = counter
  }
  if (i == 1) {
    SUI_ROC_pp3_totSecs[i] = max_secs - SUI_ROC_pp3_keyTimes[i]
  }
  else {
    SUI_ROC_pp3_totSecs[i] = SUI_ROC_pp3_keyTimes[i - 1] - SUI_ROC_pp3_keyTimes[i]
  }
}
SUI_ROC_pp3_numPass
SUI_ROC_pp3_totSecs

SUI_ROC_pp3_events_updated <- SUI_ROC_pp3_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_ROC_pp3_keyTimes)) {
  SUI_ROC_pp3_events_updated <- SUI_ROC_pp3_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_ROC_pp3_keyTimes[i] & event != "Play",
                             SUI_ROC_pp3_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_ROC_pp3_keyTimes[i] & event != "Play",
                             SUI_ROC_pp3_totSecs[i], totSecs))
}

SUI_ROC_pp3_events_updated <- SUI_ROC_pp3_events_updated %>% filter(period == 3 & (clock_seconds <= 741 & clock_seconds >= 702)|
                                                                      (clock_seconds <= 665 & clock_seconds >= 627)|
                                                                      (clock_seconds <= 594 & clock_seconds >= 560)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "ROC" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_ROC_pp3_tracking$frame_id)
min_frame <- min(SUI_ROC_pp3_tracking$frame_id)
max_secs <- max(SUI_ROC_pp3_events_updated$clock_seconds)
min_secs <- min(SUI_ROC_pp3_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_ROC_pp3_tracking <- SUI_ROC_pp3_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_ROC_pp3_tracking <- SUI_ROC_pp3_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_ROC_pp3_trackRost <- left_join(SUI_ROC_pp3_tracking, SUI_ROC_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_ROC_pp3_eventTrack <- left_join(SUI_ROC_pp3_events_updated, SUI_ROC_pp3_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_ROC_pp3_assistTrack <- SUI_ROC_pp3_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c( SUI, ROC ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( ROC, na.rm = TRUE)) %>%
  pivot_longer(c( SUI, ROC ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( ROC, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC ,  SUI, gk_pos, team_mean_distance_from_centroid))
 

SUI_ROC_pp3_shots <- SUI_ROC_pp3_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "ROC"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(ROC, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_ROC_pp3_shotTimes <- SUI_ROC_pp3_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp3_rebounds <- vector()
for (i in 1:length(SUI_ROC_pp3_shotTimes)) {
  if (i == 1) {
    SUI_ROC_pp3_rebounds[i] = 0
  }
  else {
    if (SUI_ROC_pp3_shotTimes[i] - SUI_ROC_pp3_shotTimes[i - 1] < 2) {
      SUI_ROC_pp3_rebounds[i] = 1
    }
    else {
      SUI_ROC_pp3_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_ROC_pp3_shotTimes)) {
  SUI_ROC_pp3_shots <- SUI_ROC_pp3_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_ROC_pp3_shotTimes[i],
                             SUI_ROC_pp3_rebounds[i], rebound))
}

SUI_ROC_pp3_shotProb <- SUI_ROC_pp3_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_ROC_pp3_full <- SUI_ROC_pp3_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_ROC_pp3_shotProb_goals <- SUI_ROC_pp3_full %>% filter(event_successful == TRUE)
```

# PowerPlay 5
```{r}
SUI_ROC_pp5_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/2022-02-12 Switzerland at ROC P3 pp5.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", team_name))
SUI_ROC_pp5_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-12 Switzerland at ROC/videoShotsInfo_2022-02-12 Switzerland at ROC P3 pp5.csv")
pp_info

SUI_ROC_pp5_events <- SUI_ROC_game_events %>% filter(period == 3 & (clock_seconds <= 107 & clock_seconds >= 37)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_ROC_pp5_keyTimes <- SUI_ROC_pp5_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp5_passTimes <- SUI_ROC_pp5_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_ROC_pp5_shotTimes <- SUI_ROC_pp5_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_ROC_pp5_astTimes <- vector()

SUI_ROC_pp5_events <- SUI_ROC_pp5_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_ROC_pp5_passTimes)) {
  SUI_ROC_pp5_astTimes[i] = -1
  for (j in 1:length(SUI_ROC_pp5_shotTimes)) {
    if (SUI_ROC_pp5_passTimes[i] >= SUI_ROC_pp5_shotTimes[j] & SUI_ROC_pp5_passTimes[i] - SUI_ROC_pp5_shotTimes[j] <= 3) {
      SUI_ROC_pp5_astTimes[i] = SUI_ROC_pp5_passTimes[i]
      if (length(SUI_ROC_pp5_astTimes) > 1) {
        if (SUI_ROC_pp5_astTimes[i - 1] - SUI_ROC_pp5_astTimes[i] <= 3 & SUI_ROC_pp5_astTimes[i] > 0) {
          SUI_ROC_pp5_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_ROC_pp5_passTimes)) {
  SUI_ROC_pp5_events <- SUI_ROC_pp5_events %>%
    mutate(assist = if_else(clock_seconds == SUI_ROC_pp5_astTimes[i] |
                              SUI_ROC_pp5_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_ROC_pp5_events %>% filter(clock_seconds == SUI_ROC_pp5_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_ROC_pp5_numPass <- vector()
SUI_ROC_pp5_totSecs <- vector()
max_secs <- max(SUI_ROC_pp5_events$clock_seconds)

for (i in 1:length(SUI_ROC_pp5_keyTimes)) {
  if (length(SUI_ROC_pp5_passTimes) == 0) {
    SUI_ROC_pp5_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_ROC_pp5_passTimes)) {
      if (SUI_ROC_pp5_passTimes[j] > SUI_ROC_pp5_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_ROC_pp5_passTimes <- SUI_ROC_pp5_passTimes[-1]
      }
    }
    SUI_ROC_pp5_numPass[i] = counter
  }
  if (i == 1) {
    SUI_ROC_pp5_totSecs[i] = max_secs - SUI_ROC_pp5_keyTimes[i]
  }
  else {
    SUI_ROC_pp5_totSecs[i] = SUI_ROC_pp5_keyTimes[i - 1] - SUI_ROC_pp5_keyTimes[i]
  }
}
SUI_ROC_pp5_numPass
SUI_ROC_pp5_totSecs

SUI_ROC_pp5_events_updated <- SUI_ROC_pp5_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_ROC_pp5_keyTimes)) {
  SUI_ROC_pp5_events_updated <- SUI_ROC_pp5_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_ROC_pp5_keyTimes[i] & event != "Play",
                             SUI_ROC_pp5_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_ROC_pp5_keyTimes[i] & event != "Play",
                             SUI_ROC_pp5_totSecs[i], totSecs))
}

SUI_ROC_pp5_events_updated <- SUI_ROC_pp5_events_updated %>% filter(period == 3 & (clock_seconds <= 106 & clock_seconds >= 86)|
                                                                      (clock_seconds <= 76 & clock_seconds >= 36)) %>%
  filter(team_name == "ROC" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_ROC_pp5_tracking$frame_id)
min_frame <- min(SUI_ROC_pp5_tracking$frame_id)
max_secs <- max(SUI_ROC_pp5_events_updated$clock_seconds)
min_secs <- min(SUI_ROC_pp5_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_ROC_pp5_tracking <- SUI_ROC_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_ROC_pp5_tracking <- SUI_ROC_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_ROC_pp5_trackRost <- left_join(SUI_ROC_pp5_tracking, SUI_ROC_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_ROC_pp5_eventTrack <- left_join(SUI_ROC_pp5_events_updated, SUI_ROC_pp5_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_ROC_pp5_assistTrack <- SUI_ROC_pp5_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c( SUI, ROC ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( SUI, na.rm = TRUE)) %>%
  pivot_longer(c( SUI, ROC ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( SUI, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC ,  SUI, gk_pos, team_mean_distance_from_centroid))
 

SUI_ROC_pp5_shots <- SUI_ROC_pp5_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, ROC), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(ROC, na.rm = TRUE)) %>%
  pivot_longer(cols = c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(ROC, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, ROC, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_ROC_pp5_shotTimes <- SUI_ROC_pp5_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_ROC_pp5_rebounds <- vector()
for (i in 1:length(SUI_ROC_pp5_shotTimes)) {
  if (i == 1) {
    SUI_ROC_pp5_rebounds[i] = 0
  }
  else {
    if (SUI_ROC_pp5_shotTimes[i] - SUI_ROC_pp5_shotTimes[i - 1] < 2) {
      SUI_ROC_pp5_rebounds[i] = 1
    }
    else {
      SUI_ROC_pp5_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_ROC_pp5_shotTimes)) {
  SUI_ROC_pp5_shots <- SUI_ROC_pp5_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_ROC_pp5_shotTimes[i],
                             SUI_ROC_pp5_rebounds[i], rebound))
}

SUI_ROC_pp5_shotProb <- SUI_ROC_pp5_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_ROC_pp5_full <- SUI_ROC_pp5_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_ROC_pp5_shotProb_goals <- SUI_ROC_pp5_full %>% filter(event_successful == TRUE)
```

# Combined
```{r}
SUI_ROC_combined <- bind_rows(SUI_ROC_pp2_full,
                              SUI_ROC_pp3_full,
                              SUI_ROC_pp5_full)
SUI_ROC_ast_combined <- bind_rows(SUI_ROC_pp3_assistTrack,
                                  SUI_ROC_pp5_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```


__2022-02-14 Switzerland at Canada__
```{r}
SUI_CAN_game_events <- play_by_play %>% filter(game_date == "14/2/2022" & (team_name == 'Olympic (Women) - Canada' |
                                         team_name == 'Olympic (Women) - Switzerland')) %>% 
  mutate(team_name = fct_recode(team_name, CAN = "Olympic (Women) - Canada", SUI = "Olympic (Women) - Switzerland"),
         opp_team_name = fct_recode(opp_team_name, SUI = "Olympic (Women) - Switzerland", CAN = "Olympic (Women) - Canada"))
SUI_CAN_roster <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/2022-02-14 Switzerland at Canada roster.csv") %>%
  mutate(team = if_else(team == "home", "CAN", "SUI"))
```

# PowerPlay 2
```{r}
SUI_CAN_pp2_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/2022-02-14 Switzerland at Canada P1 pp2.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", "CAN"))
SUI_CAN_pp2_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/videoShotsInfo_2022-02-14 Switzerland at Canada P1 pp2.csv")
pp_info

SUI_CAN_pp2_events <- SUI_CAN_game_events %>% filter(period == 1 & (clock_seconds <= 172 & clock_seconds >= 83)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "CAN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_CAN_pp2_keyTimes <- SUI_CAN_pp2_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp2_passTimes <- SUI_CAN_pp2_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_CAN_pp2_shotTimes <- SUI_CAN_pp2_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_CAN_pp2_astTimes <- vector()

SUI_CAN_pp2_events <- SUI_CAN_pp2_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_CAN_pp2_passTimes)) {
  SUI_CAN_pp2_astTimes[i] = -1
  for (j in 1:length(SUI_CAN_pp2_shotTimes)) {
    if (SUI_CAN_pp2_passTimes[i] >= SUI_CAN_pp2_shotTimes[j] & SUI_CAN_pp2_passTimes[i] - SUI_CAN_pp2_shotTimes[j] <= 3) {
      SUI_CAN_pp2_astTimes[i] = SUI_CAN_pp2_passTimes[i]
      if (length(SUI_CAN_pp2_astTimes) > 1) {
        if (SUI_CAN_pp2_astTimes[i - 1] - SUI_CAN_pp2_astTimes[i] <= 3 & SUI_CAN_pp2_astTimes[i] > 0) {
          SUI_CAN_pp2_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_CAN_pp2_passTimes)) {
  SUI_CAN_pp2_events <- SUI_CAN_pp2_events %>%
    mutate(assist = if_else(clock_seconds == SUI_CAN_pp2_astTimes[i] |
                              SUI_CAN_pp2_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_CAN_pp2_events %>% filter(clock_seconds == SUI_CAN_pp2_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_CAN_pp2_numPass <- vector()
SUI_CAN_pp2_totSecs <- vector()
max_secs <- max(SUI_CAN_pp2_events$clock_seconds)

for (i in 1:length(SUI_CAN_pp2_keyTimes)) {
  if (length(SUI_CAN_pp2_passTimes) == 0) {
    SUI_CAN_pp2_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_CAN_pp2_passTimes)) {
      if (SUI_CAN_pp2_passTimes[j] > SUI_CAN_pp2_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_CAN_pp2_passTimes <- SUI_CAN_pp2_passTimes[-1]
      }
    }
    SUI_CAN_pp2_numPass[i] = counter
  }
  if (i == 1) {
    SUI_CAN_pp2_totSecs[i] = max_secs - SUI_CAN_pp2_keyTimes[i]
  }
  else {
    SUI_CAN_pp2_totSecs[i] = SUI_CAN_pp2_keyTimes[i - 1] - SUI_CAN_pp2_keyTimes[i]
  }
}
SUI_CAN_pp2_numPass
SUI_CAN_pp2_totSecs

SUI_CAN_pp2_events_updated <- SUI_CAN_pp2_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_CAN_pp2_keyTimes)) {
  SUI_CAN_pp2_events_updated <- SUI_CAN_pp2_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_CAN_pp2_keyTimes[i] & event != "Play",
                             SUI_CAN_pp2_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_CAN_pp2_keyTimes[i] & event != "Play",
                             SUI_CAN_pp2_totSecs[i], totSecs))
}

SUI_CAN_pp2_events_updated <- SUI_CAN_pp2_events_updated %>% filter(period == 1 & (clock_seconds <= 146 & clock_seconds >= 141)|
                                                                      (clock_seconds <= 133 & clock_seconds >= 110)|
                                                                      (clock_seconds <= 107 & clock_seconds >= 83)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "CAN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_CAN_pp2_tracking$frame_id)
min_frame <- min(SUI_CAN_pp2_tracking$frame_id)
max_secs <- max(SUI_CAN_pp2_events_updated$clock_seconds)
min_secs <- min(SUI_CAN_pp2_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_CAN_pp2_tracking <- SUI_CAN_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_CAN_pp2_tracking <- SUI_CAN_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_CAN_pp2_trackRost <- left_join(SUI_CAN_pp2_tracking, SUI_CAN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_CAN_pp2_eventTrack <- left_join(SUI_CAN_pp2_events_updated, SUI_CAN_pp2_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_CAN_pp2_assistTrack <- SUI_CAN_pp2_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c( SUI, CAN ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( CAN, na.rm = TRUE)) %>%
  pivot_longer(c( SUI, CAN ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( CAN, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN ,  SUI, gk_pos, team_mean_distance_from_centroid))
 

SUI_CAN_pp2_shots <- SUI_CAN_pp2_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, CAN), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "CAN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(CAN, na.rm = TRUE)) %>%
  pivot_longer(c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(CAN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_CAN_pp2_shotTimes <- SUI_CAN_pp2_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp2_rebounds <- vector()
for (i in 1:length(SUI_CAN_pp2_shotTimes)) {
  if (i == 1) {
    SUI_CAN_pp2_rebounds[i] = 0
  }
  else {
    if (SUI_CAN_pp2_shotTimes[i] - SUI_CAN_pp2_shotTimes[i - 1] < 2) {
      SUI_CAN_pp2_rebounds[i] = 1
    }
    else {
      SUI_CAN_pp2_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_CAN_pp2_shotTimes)) {
  SUI_CAN_pp2_shots <- SUI_CAN_pp2_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_CAN_pp2_shotTimes[i],
                             SUI_CAN_pp2_rebounds[i], rebound))
}

SUI_CAN_pp2_shotProb <- SUI_CAN_pp2_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_CAN_pp2_full <- SUI_CAN_pp2_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_CAN_pp2_shotProb_goals <- SUI_CAN_pp2_full %>% filter(event_successful == TRUE)
```

# PowerPlay 4
```{r}
SUI_CAN_pp4_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/2022-02-14 Switzerland at Canada P2 pp4.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", "CAN"))
SUI_CAN_pp4_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/videoShotsInfo_2022-02-14 Switzerland at Canada P2 pp4.csv")
pp_info

SUI_CAN_pp4_events <- SUI_CAN_game_events %>% filter(period == 2 & (clock_seconds <= 209 & clock_seconds >= 89)) %>%
  filter(team_name == "CAN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_CAN_pp4_keyTimes <- SUI_CAN_pp4_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp4_passTimes <- SUI_CAN_pp4_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_CAN_pp4_shotTimes <- SUI_CAN_pp4_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_CAN_pp4_astTimes <- vector()

SUI_CAN_pp4_events <- SUI_CAN_pp4_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_CAN_pp4_passTimes)) {
  SUI_CAN_pp4_astTimes[i] = -1
  for (j in 1:length(SUI_CAN_pp4_shotTimes)) {
    if (SUI_CAN_pp4_passTimes[i] >= SUI_CAN_pp4_shotTimes[j] & SUI_CAN_pp4_passTimes[i] - SUI_CAN_pp4_shotTimes[j] <= 3) {
      SUI_CAN_pp4_astTimes[i] = SUI_CAN_pp4_passTimes[i]
      if (length(SUI_CAN_pp4_astTimes) > 1) {
        if (SUI_CAN_pp4_astTimes[i - 1] - SUI_CAN_pp4_astTimes[i] <= 3 & SUI_CAN_pp4_astTimes[i] > 0) {
          SUI_CAN_pp4_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_CAN_pp4_passTimes)) {
  SUI_CAN_pp4_events <- SUI_CAN_pp4_events %>%
    mutate(assist = if_else(clock_seconds == SUI_CAN_pp4_astTimes[i] |
                              SUI_CAN_pp4_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_CAN_pp4_events %>% filter(clock_seconds == SUI_CAN_pp4_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_CAN_pp4_numPass <- vector()
SUI_CAN_pp4_totSecs <- vector()
max_secs <- max(SUI_CAN_pp4_events$clock_seconds)

for (i in 1:length(SUI_CAN_pp4_keyTimes)) {
  if (length(SUI_CAN_pp4_passTimes) == 0) {
    SUI_CAN_pp4_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_CAN_pp4_passTimes)) {
      if (SUI_CAN_pp4_passTimes[j] > SUI_CAN_pp4_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_CAN_pp4_passTimes <- SUI_CAN_pp4_passTimes[-1]
      }
    }
    SUI_CAN_pp4_numPass[i] = counter
  }
  if (i == 1) {
    SUI_CAN_pp4_totSecs[i] = max_secs - SUI_CAN_pp4_keyTimes[i]
  }
  else {
    SUI_CAN_pp4_totSecs[i] = SUI_CAN_pp4_keyTimes[i - 1] - SUI_CAN_pp4_keyTimes[i]
  }
}
SUI_CAN_pp4_numPass
SUI_CAN_pp4_totSecs

SUI_CAN_pp4_events_updated <- SUI_CAN_pp4_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_CAN_pp4_keyTimes)) {
  SUI_CAN_pp4_events_updated <- SUI_CAN_pp4_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_CAN_pp4_keyTimes[i] & event != "Play",
                             SUI_CAN_pp4_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_CAN_pp4_keyTimes[i] & event != "Play",
                             SUI_CAN_pp4_totSecs[i], totSecs))
}

SUI_CAN_pp4_events_updated <- SUI_CAN_pp4_events_updated %>% filter(period == 2 & (clock_seconds <= 206 & clock_seconds >= 100)|
                                                                      (clock_seconds <= 66 & clock_seconds >= 46)|
                                                                      (clock_seconds <= 31 & clock_seconds >= 28)) %>%
  filter(team_name == "CAN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_CAN_pp4_tracking$frame_id)
min_frame <- min(SUI_CAN_pp4_tracking$frame_id)
max_secs <- max(SUI_CAN_pp4_events_updated$clock_seconds)
min_secs <- min(SUI_CAN_pp4_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_CAN_pp4_tracking <- SUI_CAN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_CAN_pp4_tracking <- SUI_CAN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_CAN_pp4_trackRost <- left_join(SUI_CAN_pp4_tracking, SUI_CAN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_CAN_pp4_eventTrack <- left_join(SUI_CAN_pp4_events_updated, SUI_CAN_pp4_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_CAN_pp4_assistTrack <- SUI_CAN_pp4_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c( SUI, CAN ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( SUI, na.rm = TRUE)) %>%
  pivot_longer(c( SUI, CAN ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( SUI, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN ,  SUI, gk_pos, team_mean_distance_from_centroid))
 

SUI_CAN_pp4_shots <- SUI_CAN_pp4_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, CAN), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_CAN_pp4_shotTimes <- SUI_CAN_pp4_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp4_rebounds <- vector()
for (i in 1:length(SUI_CAN_pp4_shotTimes)) {
  if (i == 1) {
    SUI_CAN_pp4_rebounds[i] = 0
  }
  else {
    if (SUI_CAN_pp4_shotTimes[i] - SUI_CAN_pp4_shotTimes[i - 1] < 2) {
      SUI_CAN_pp4_rebounds[i] = 1
    }
    else {
      SUI_CAN_pp4_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_CAN_pp4_shotTimes)) {
  SUI_CAN_pp4_shots <- SUI_CAN_pp4_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_CAN_pp4_shotTimes[i],
                             SUI_CAN_pp4_rebounds[i], rebound))
}

SUI_CAN_pp4_shotProb <- SUI_CAN_pp4_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_CAN_pp4_full <- SUI_CAN_pp4_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_CAN_pp4_shotProb_goals <- SUI_CAN_pp4_full %>% filter(event_successful == TRUE)
```

# PowerPlay 5
```{r}
SUI_CAN_pp5_tracking <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/2022-02-14 Switzerland at Canada P3 pp5.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Switzerland", "SUI", "CAN"))
SUI_CAN_pp5_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Switzerland at Canada/videoShotsInfo_2022-02-14 Switzerland at Canada P3 pp5.csv")
pp_info

SUI_CAN_pp5_events <- SUI_CAN_game_events %>% filter(period == 3 & (clock_seconds <= 677 & clock_seconds >= 557)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "CAN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_CAN_pp5_keyTimes <- SUI_CAN_pp5_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp5_passTimes <- SUI_CAN_pp5_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_CAN_pp5_shotTimes <- SUI_CAN_pp5_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_CAN_pp5_astTimes <- vector()

SUI_CAN_pp5_events <- SUI_CAN_pp5_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_CAN_pp5_passTimes)) {
  SUI_CAN_pp5_astTimes[i] = -1
  for (j in 1:length(SUI_CAN_pp5_shotTimes)) {
    if (SUI_CAN_pp5_passTimes[i] >= SUI_CAN_pp5_shotTimes[j] & SUI_CAN_pp5_passTimes[i] - SUI_CAN_pp5_shotTimes[j] <= 3) {
      SUI_CAN_pp5_astTimes[i] = SUI_CAN_pp5_passTimes[i]
      if (length(SUI_CAN_pp5_astTimes) > 1) {
        if (SUI_CAN_pp5_astTimes[i - 1] - SUI_CAN_pp5_astTimes[i] <= 3 & SUI_CAN_pp5_astTimes[i] > 0) {
          SUI_CAN_pp5_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_CAN_pp5_passTimes)) {
  SUI_CAN_pp5_events <- SUI_CAN_pp5_events %>%
    mutate(assist = if_else(clock_seconds == SUI_CAN_pp5_astTimes[i] |
                              SUI_CAN_pp5_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_CAN_pp5_events %>% filter(clock_seconds == SUI_CAN_pp5_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_CAN_pp5_numPass <- vector()
SUI_CAN_pp5_totSecs <- vector()
max_secs <- max(SUI_CAN_pp5_events$clock_seconds)

for (i in 1:length(SUI_CAN_pp5_keyTimes)) {
  if (length(SUI_CAN_pp5_passTimes) == 0) {
    SUI_CAN_pp5_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_CAN_pp5_passTimes)) {
      if (SUI_CAN_pp5_passTimes[j] > SUI_CAN_pp5_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_CAN_pp5_passTimes <- SUI_CAN_pp5_passTimes[-1]
      }
    }
    SUI_CAN_pp5_numPass[i] = counter
  }
  if (i == 1) {
    SUI_CAN_pp5_totSecs[i] = max_secs - SUI_CAN_pp5_keyTimes[i]
  }
  else {
    SUI_CAN_pp5_totSecs[i] = SUI_CAN_pp5_keyTimes[i - 1] - SUI_CAN_pp5_keyTimes[i]
  }
}
SUI_CAN_pp5_numPass
SUI_CAN_pp5_totSecs

SUI_CAN_pp5_events_updated <- SUI_CAN_pp5_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_CAN_pp5_keyTimes)) {
  SUI_CAN_pp5_events_updated <- SUI_CAN_pp5_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_CAN_pp5_keyTimes[i] & event != "Play",
                             SUI_CAN_pp5_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_CAN_pp5_keyTimes[i] & event != "Play",
                             SUI_CAN_pp5_totSecs[i], totSecs))
}

SUI_CAN_pp5_events_updated <- SUI_CAN_pp5_events_updated %>% filter(period == 3 & (clock_seconds <= 675 & clock_seconds >= 593)|
                                                                      (clock_seconds <= 582 & clock_seconds >= 532)|
                                                                      (clock_seconds <= 528 & clock_seconds >= 516)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "CAN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_CAN_pp5_tracking$frame_id)
min_frame <- min(SUI_CAN_pp5_tracking$frame_id)
max_secs <- max(SUI_CAN_pp5_events_updated$clock_seconds)
min_secs <- min(SUI_CAN_pp5_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_CAN_pp5_tracking <- SUI_CAN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_CAN_pp5_tracking <- SUI_CAN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_CAN_pp5_trackRost <- left_join(SUI_CAN_pp5_tracking, SUI_CAN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_CAN_pp5_eventTrack <- left_join(SUI_CAN_pp5_events_updated, SUI_CAN_pp5_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_CAN_pp5_assistTrack <- SUI_CAN_pp5_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c( SUI, CAN ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( CAN, na.rm = TRUE)) %>%
  pivot_longer(c( SUI, CAN ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( CAN, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN ,  SUI, gk_pos, team_mean_distance_from_centroid))
 

SUI_CAN_pp5_shots <- SUI_CAN_pp5_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, CAN), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "CAN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(CAN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(CAN, na.rm = TRUE)) %>%
  pivot_longer(c(CAN, SUI), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(CAN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, CAN, SUI, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_CAN_pp5_shotTimes <- SUI_CAN_pp5_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_CAN_pp5_rebounds <- vector()
for (i in 1:length(SUI_CAN_pp5_shotTimes)) {
  if (i == 1) {
    SUI_CAN_pp5_rebounds[i] = 0
  }
  else {
    if (SUI_CAN_pp5_shotTimes[i] - SUI_CAN_pp5_shotTimes[i - 1] < 2) {
      SUI_CAN_pp5_rebounds[i] = 1
    }
    else {
      SUI_CAN_pp5_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_CAN_pp5_shotTimes)) {
  SUI_CAN_pp5_shots <- SUI_CAN_pp5_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_CAN_pp5_shotTimes[i],
                             SUI_CAN_pp5_rebounds[i], rebound))
}

SUI_CAN_pp5_shotProb <- SUI_CAN_pp5_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_CAN_pp5_full <- SUI_CAN_pp5_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_CAN_pp5_shotProb_goals <- SUI_CAN_pp5_full %>% filter(event_successful == TRUE)
```


# Combined
```{r}
SUI_CAN_combined <- bind_rows(SUI_CAN_pp2_full,
                              SUI_CAN_pp4_full,
                              SUI_CAN_pp5_full)
SUI_CAN_ast_combined <- bind_rows(SUI_CAN_pp2_assistTrack,
                                  SUI_CAN_pp4_assistTrack,
                                  SUI_CAN_pp5_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```


__2022-02-14 Finland at USA__
```{r}
FIN_USA_game_events <- play_by_play %>% filter(game_date == "14/2/2022" & (team_name == 'Olympic (Women) - Finland' | 
                                                                             team_name == 'Olympic (Women) - United States')) %>%
  mutate(team_name = fct_recode(team_name, FIN = 'Olympic (Women) - Finland', USA = 'Olympic (Women) - United States'),
         opp_team_name = fct_recode(opp_team_name, FIN = 'Olympic (Women) - Finland', USA = 'Olympic (Women) - United States'))
FIN_USA_roster <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Finland at USA/2022-02-14 Finland at USA roster.csv") %>%
  mutate(team = if_else(team == "home", "FIN", "USA"))
```

# PowerPlay 1
```{r}
FIN_USA_pp1_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Finland at USA/2022-02-14 Finland at USA P2 PP1.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "USA"))
FIN_USA_pp1_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Finland at USA/videoShotsInfo_2022-02-14 Finland at USA P2 PP1.csv")
pp_info

FIN_USA_pp1_events <- FIN_USA_game_events %>% filter(period == 2 & (clock_seconds <= 1068 & clock_seconds >= 981)) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

FIN_USA_pp1_keyTimes <- FIN_USA_pp1_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

FIN_USA_pp1_passTimes <- FIN_USA_pp1_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
FIN_USA_pp1_shotTimes <- FIN_USA_pp1_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
FIN_USA_pp1_astTimes <- vector()

FIN_USA_pp1_events <- FIN_USA_pp1_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(FIN_USA_pp1_passTimes)) {
  FIN_USA_pp1_astTimes[i] = -1
  for (j in 1:length(FIN_USA_pp1_shotTimes)) {
    if (FIN_USA_pp1_passTimes[i] >= FIN_USA_pp1_shotTimes[j] & FIN_USA_pp1_passTimes[i] - FIN_USA_pp1_shotTimes[j] <= 3) {
      FIN_USA_pp1_astTimes[i] = FIN_USA_pp1_passTimes[i]
      if (length(FIN_USA_pp1_astTimes) > 1) {
        if (FIN_USA_pp1_astTimes[i - 1] - FIN_USA_pp1_astTimes[i] <= 3 & FIN_USA_pp1_astTimes[i] > 0) {
          FIN_USA_pp1_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(FIN_USA_pp1_passTimes)) {
  FIN_USA_pp1_events <- FIN_USA_pp1_events %>%
    mutate(assist = if_else(clock_seconds == FIN_USA_pp1_astTimes[i] |
                              FIN_USA_pp1_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  FIN_USA_pp1_events %>% filter(clock_seconds == FIN_USA_pp1_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

FIN_USA_pp1_numPass <- vector()
FIN_USA_pp1_totSecs <- vector()
max_secs <- max(FIN_USA_pp1_events$clock_seconds)

for (i in 1:length(FIN_USA_pp1_keyTimes)) {
  if (length(FIN_USA_pp1_passTimes) == 0) {
    FIN_USA_pp1_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(FIN_USA_pp1_passTimes)) {
      if (FIN_USA_pp1_passTimes[j] > FIN_USA_pp1_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        FIN_USA_pp1_passTimes <- FIN_USA_pp1_passTimes[-1]
      }
    }
    FIN_USA_pp1_numPass[i] = counter
  }
  if (i == 1) {
    FIN_USA_pp1_totSecs[i] = max_secs - FIN_USA_pp1_keyTimes[i]
  }
  else {
    FIN_USA_pp1_totSecs[i] = FIN_USA_pp1_keyTimes[i - 1] - FIN_USA_pp1_keyTimes[i]
  }
}
FIN_USA_pp1_numPass
FIN_USA_pp1_totSecs

FIN_USA_pp1_events_updated <- FIN_USA_pp1_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(FIN_USA_pp1_keyTimes)) {
  FIN_USA_pp1_events_updated <- FIN_USA_pp1_events_updated %>%
    mutate(numPass = if_else(clock_seconds == FIN_USA_pp1_keyTimes[i] & event != "Play",
                             FIN_USA_pp1_numPass[i], numPass),
           totSecs = if_else(clock_seconds == FIN_USA_pp1_keyTimes[i] & event != "Play",
                             FIN_USA_pp1_totSecs[i], totSecs))
}

FIN_USA_pp1_events_updated <- FIN_USA_pp1_events_updated %>% filter(period == 2 & (clock_seconds <= 1068 & clock_seconds >= 1027)|
                                                                      (clock_seconds <= 1024 & clock_seconds >= 994)) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(FIN_USA_pp1_tracking$frame_id)
min_frame <- min(FIN_USA_pp1_tracking$frame_id)
max_secs <- max(FIN_USA_pp1_events_updated$clock_seconds)
min_secs <- min(FIN_USA_pp1_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    FIN_USA_pp1_tracking <- FIN_USA_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    FIN_USA_pp1_tracking <- FIN_USA_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

FIN_USA_pp1_trackRost <- left_join(FIN_USA_pp1_tracking, FIN_USA_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
FIN_USA_pp1_eventTrack <- left_join(FIN_USA_pp1_events_updated, FIN_USA_pp1_trackRost, by = c("clock_seconds" = "clock_seconds"))

FIN_USA_pp1_assistTrack <- FIN_USA_pp1_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, USA ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( FIN, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, USA ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( FIN, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, USA ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

FIN_USA_pp1_shots <- FIN_USA_pp1_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, USA), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "FIN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(FIN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, USA, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

FIN_USA_pp1_shotTimes <- FIN_USA_pp1_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

FIN_USA_pp1_rebounds <- vector()
for (i in 1:length(FIN_USA_pp1_shotTimes)) {
  if (i == 1) {
    FIN_USA_pp1_rebounds[i] = 0
  }
  else {
    if (FIN_USA_pp1_shotTimes[i] - FIN_USA_pp1_shotTimes[i - 1] < 2) {
      FIN_USA_pp1_rebounds[i] = 1
    }
    else {
      FIN_USA_pp1_rebounds[i] = 0
    }
  }
}
for (i in 1:length(FIN_USA_pp1_shotTimes)) {
  FIN_USA_pp1_shots <- FIN_USA_pp1_shots %>%
    mutate(rebound = if_else(clock_seconds == FIN_USA_pp1_shotTimes[i],
                             FIN_USA_pp1_rebounds[i], rebound))
}

FIN_USA_pp1_shotProb <- FIN_USA_pp1_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

FIN_USA_pp1_full <- FIN_USA_pp1_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

FIN_USA_pp1_shotProb_goals <- FIN_USA_pp1_full %>% filter(event_successful == TRUE)
```

# PowerPlay 4
```{r}
FIN_USA_pp4_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Finland at USA/2022-02-14 Finland at USA P3 pp4.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "USA"))
FIN_USA_pp4_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-14 Finland at USA/videoShotsInfo_2022-02-14 Finland at USA P3 pp4.csv")
pp_info

FIN_USA_pp4_events <- FIN_USA_game_events %>% filter(period == 3 & (clock_seconds <= 1171 & clock_seconds >= 1051)) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

FIN_USA_pp4_keyTimes <- FIN_USA_pp4_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

FIN_USA_pp4_passTimes <- FIN_USA_pp4_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
FIN_USA_pp4_shotTimes <- FIN_USA_pp4_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
FIN_USA_pp4_astTimes <- vector()

FIN_USA_pp4_events <- FIN_USA_pp4_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(FIN_USA_pp4_passTimes)) {
  FIN_USA_pp4_astTimes[i] = -1
  for (j in 1:length(FIN_USA_pp4_shotTimes)) {
    if (FIN_USA_pp4_passTimes[i] >= FIN_USA_pp4_shotTimes[j] & FIN_USA_pp4_passTimes[i] - FIN_USA_pp4_shotTimes[j] <= 3) {
      FIN_USA_pp4_astTimes[i] = FIN_USA_pp4_passTimes[i]
      if (length(FIN_USA_pp4_astTimes) > 1) {
        if (FIN_USA_pp4_astTimes[i - 1] - FIN_USA_pp4_astTimes[i] <= 3 & FIN_USA_pp4_astTimes[i] > 0) {
          FIN_USA_pp4_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(FIN_USA_pp4_passTimes)) {
  FIN_USA_pp4_events <- FIN_USA_pp4_events %>%
    mutate(assist = if_else(clock_seconds == FIN_USA_pp4_astTimes[i] |
                              FIN_USA_pp4_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  FIN_USA_pp4_events %>% filter(clock_seconds == FIN_USA_pp4_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

FIN_USA_pp4_numPass <- vector()
FIN_USA_pp4_totSecs <- vector()
max_secs <- max(FIN_USA_pp4_events$clock_seconds)

for (i in 1:length(FIN_USA_pp4_keyTimes)) {
  if (length(FIN_USA_pp4_passTimes) == 0) {
    FIN_USA_pp4_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(FIN_USA_pp4_passTimes)) {
      if (FIN_USA_pp4_passTimes[j] > FIN_USA_pp4_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        FIN_USA_pp4_passTimes <- FIN_USA_pp4_passTimes[-1]
      }
    }
    FIN_USA_pp4_numPass[i] = counter
  }
  if (i == 1) {
    FIN_USA_pp4_totSecs[i] = max_secs - FIN_USA_pp4_keyTimes[i]
  }
  else {
    FIN_USA_pp4_totSecs[i] = FIN_USA_pp4_keyTimes[i - 1] - FIN_USA_pp4_keyTimes[i]
  }
}
FIN_USA_pp4_numPass
FIN_USA_pp4_totSecs

FIN_USA_pp4_events_updated <- FIN_USA_pp4_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(FIN_USA_pp4_keyTimes)) {
  FIN_USA_pp4_events_updated <- FIN_USA_pp4_events_updated %>%
    mutate(numPass = if_else(clock_seconds == FIN_USA_pp4_keyTimes[i] & event != "Play",
                             FIN_USA_pp4_numPass[i], numPass),
           totSecs = if_else(clock_seconds == FIN_USA_pp4_keyTimes[i] & event != "Play",
                             FIN_USA_pp4_totSecs[i], totSecs))
}

FIN_USA_pp4_events_updated <- FIN_USA_pp4_events_updated %>% filter(period == 3 & (clock_seconds <= 1151 & clock_seconds >= 1091)|
                                                                      (clock_seconds <= 1086 & clock_seconds >= 1050)) %>%
  filter(team_name == "USA" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(FIN_USA_pp4_tracking$frame_id)
min_frame <- min(FIN_USA_pp4_tracking$frame_id)
max_secs <- max(FIN_USA_pp4_events_updated$clock_seconds)
min_secs <- min(FIN_USA_pp4_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    FIN_USA_pp4_tracking <- FIN_USA_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    FIN_USA_pp4_tracking <- FIN_USA_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

FIN_USA_pp4_trackRost <- left_join(FIN_USA_pp4_tracking, FIN_USA_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
FIN_USA_pp4_eventTrack <- left_join(FIN_USA_pp4_events_updated, FIN_USA_pp4_trackRost, by = c("clock_seconds" = "clock_seconds"))

FIN_USA_pp4_assistTrack <- FIN_USA_pp4_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, USA ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( FIN, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, USA ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( FIN, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, USA ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

FIN_USA_pp4_shots <- FIN_USA_pp4_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, USA), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "FIN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(c(USA, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(FIN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, USA, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

FIN_USA_pp4_shotTimes <- FIN_USA_pp4_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

FIN_USA_pp4_rebounds <- vector()
for (i in 1:length(FIN_USA_pp4_shotTimes)) {
  if (i == 1) {
    FIN_USA_pp4_rebounds[i] = 0
  }
  else {
    if (FIN_USA_pp4_shotTimes[i] - FIN_USA_pp4_shotTimes[i - 1] < 2) {
      FIN_USA_pp4_rebounds[i] = 1
    }
    else {
      FIN_USA_pp4_rebounds[i] = 0
    }
  }
}
for (i in 1:length(FIN_USA_pp4_shotTimes)) {
  FIN_USA_pp4_shots <- FIN_USA_pp4_shots %>%
    mutate(rebound = if_else(clock_seconds == FIN_USA_pp4_shotTimes[i],
                             FIN_USA_pp4_rebounds[i], rebound))
}

FIN_USA_pp4_shotProb <- FIN_USA_pp4_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

FIN_USA_pp4_full <- FIN_USA_pp4_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

FIN_USA_pp4_shotProb_goals <- FIN_USA_pp4_full %>% filter(event_successful == TRUE)
```

# Combined
```{r}
FIN_USA_combined <- bind_rows(FIN_USA_pp1_full, FIN_USA_pp4_full)

FIN_USA_ast_combined <- bind_rows(FIN_USA_pp1_assistTrack, FIN_USA_pp4_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```

__2022-02-16 Switzerland at Finland__
```{r}
SUI_FIN_game_events <- play_by_play %>% filter(game_date == "16/2/2022" & (team_name == 'Olympic (Women) - Finland' | 
                                                                             team_name == 'Olympic (Women) - Switzerland'))  %>%
  mutate(team_name = fct_recode(team_name, FIN = 'Olympic (Women) - Finland', SUI = 'Olympic (Women) - Switzerland'),
         opp_team_name = fct_recode(opp_team_name, FIN = 'Olympic (Women) - Finland', SUI = 'Olympic (Women) - Switzerland'))
SUI_FIN_roster <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland roster.csv") %>%
  mutate(team = if_else(team == "home", "FIN", "SUI"))
```

# PowerPlay 1
```{r}
SUI_FIN_pp1_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P1 PP1.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp1_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland P1 PP1.csv")
pp_info

SUI_FIN_pp1_events <- SUI_FIN_game_events %>% filter(period == 1 & (clock_seconds <= 658 & clock_seconds >= 538)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp1_keyTimes <- SUI_FIN_pp1_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp1_passTimes <- SUI_FIN_pp1_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp1_shotTimes <- SUI_FIN_pp1_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp1_astTimes <- vector()

SUI_FIN_pp1_events <- SUI_FIN_pp1_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp1_passTimes)) {
  SUI_FIN_pp1_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp1_shotTimes)) {
    if (SUI_FIN_pp1_passTimes[i] >= SUI_FIN_pp1_shotTimes[j] & SUI_FIN_pp1_passTimes[i] - SUI_FIN_pp1_shotTimes[j] <= 3) {
      SUI_FIN_pp1_astTimes[i] = SUI_FIN_pp1_passTimes[i]
      if (length(SUI_FIN_pp1_astTimes) > 1) {
        if (SUI_FIN_pp1_astTimes[i - 1] - SUI_FIN_pp1_astTimes[i] <= 3 & SUI_FIN_pp1_astTimes[i] > 0) {
          SUI_FIN_pp1_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp1_passTimes)) {
  SUI_FIN_pp1_events <- SUI_FIN_pp1_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp1_astTimes[i] |
                              SUI_FIN_pp1_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp1_events %>% filter(clock_seconds == SUI_FIN_pp1_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp1_numPass <- vector()
SUI_FIN_pp1_totSecs <- vector()
max_secs <- max(SUI_FIN_pp1_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp1_keyTimes)) {
  if (length(SUI_FIN_pp1_passTimes) == 0) {
    SUI_FIN_pp1_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp1_passTimes)) {
      if (SUI_FIN_pp1_passTimes[j] > SUI_FIN_pp1_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp1_passTimes <- SUI_FIN_pp1_passTimes[-1]
      }
    }
    SUI_FIN_pp1_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp1_totSecs[i] = max_secs - SUI_FIN_pp1_keyTimes[i]
  }
  else {
    SUI_FIN_pp1_totSecs[i] = SUI_FIN_pp1_keyTimes[i - 1] - SUI_FIN_pp1_keyTimes[i]
  }
}
SUI_FIN_pp1_numPass
SUI_FIN_pp1_totSecs

SUI_FIN_pp1_events_updated <- SUI_FIN_pp1_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp1_keyTimes)) {
  SUI_FIN_pp1_events_updated <- SUI_FIN_pp1_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp1_keyTimes[i] & event != "Play",
                             SUI_FIN_pp1_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp1_keyTimes[i] & event != "Play",
                             SUI_FIN_pp1_totSecs[i], totSecs))
}

SUI_FIN_pp1_events_updated <- SUI_FIN_pp1_events_updated %>% filter(period == 1 & (clock_seconds <= 656 & clock_seconds >= 630)|
                                                                      (clock_seconds <= 542 & clock_seconds >= 517)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp1_tracking$frame_id)
min_frame <- min(SUI_FIN_pp1_tracking$frame_id)
max_secs <- max(SUI_FIN_pp1_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp1_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp1_tracking <- SUI_FIN_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp1_tracking <- SUI_FIN_pp1_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp1_trackRost <- left_join(SUI_FIN_pp1_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp1_eventTrack <- left_join(SUI_FIN_pp1_events_updated, SUI_FIN_pp1_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_FIN_pp1_assistTrack <- SUI_FIN_pp1_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, SUI ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( FIN, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, SUI ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( FIN, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

SUI_FIN_pp1_shots <- SUI_FIN_pp1_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "FIN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(FIN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp1_shotTimes <- SUI_FIN_pp1_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp1_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp1_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp1_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp1_shotTimes[i] - SUI_FIN_pp1_shotTimes[i - 1] < 2) {
      SUI_FIN_pp1_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp1_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp1_shotTimes)) {
  SUI_FIN_pp1_shots <- SUI_FIN_pp1_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp1_shotTimes[i],
                             SUI_FIN_pp1_rebounds[i], rebound))
}

SUI_FIN_pp1_shotProb <- SUI_FIN_pp1_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp1_full <- SUI_FIN_pp1_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp1_shotProb_goals <- SUI_FIN_pp1_full %>% filter(event_successful == TRUE)
```

# PowerPlay 2
```{r}
SUI_FIN_pp2_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P1 pp2.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp2_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland P1 pp2.csv")
pp_info

SUI_FIN_pp2_events <- SUI_FIN_game_events %>% filter(period == 1 & (clock_seconds <= 417 & clock_seconds >= 297)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp2_keyTimes <- SUI_FIN_pp2_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp2_passTimes <- SUI_FIN_pp2_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp2_shotTimes <- SUI_FIN_pp2_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp2_astTimes <- vector()

SUI_FIN_pp2_events <- SUI_FIN_pp2_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp2_passTimes)) {
  SUI_FIN_pp2_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp2_shotTimes)) {
    if (SUI_FIN_pp2_passTimes[i] >= SUI_FIN_pp2_shotTimes[j] & SUI_FIN_pp2_passTimes[i] - SUI_FIN_pp2_shotTimes[j] <= 3) {
      SUI_FIN_pp2_astTimes[i] = SUI_FIN_pp2_passTimes[i]
      if (length(SUI_FIN_pp2_astTimes) > 1) {
        if (SUI_FIN_pp2_astTimes[i - 1] - SUI_FIN_pp2_astTimes[i] <= 3 & SUI_FIN_pp2_astTimes[i] > 0) {
          SUI_FIN_pp2_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp2_passTimes)) {
  SUI_FIN_pp2_events <- SUI_FIN_pp2_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp2_astTimes[i] |
                              SUI_FIN_pp2_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp2_events %>% filter(clock_seconds == SUI_FIN_pp2_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp2_numPass <- vector()
SUI_FIN_pp2_totSecs <- vector()
max_secs <- max(SUI_FIN_pp2_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp2_keyTimes)) {
  if (length(SUI_FIN_pp2_passTimes) == 0) {
    SUI_FIN_pp2_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp2_passTimes)) {
      if (SUI_FIN_pp2_passTimes[j] > SUI_FIN_pp2_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp2_passTimes <- SUI_FIN_pp2_passTimes[-1]
      }
    }
    SUI_FIN_pp2_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp2_totSecs[i] = max_secs - SUI_FIN_pp2_keyTimes[i]
  }
  else {
    SUI_FIN_pp2_totSecs[i] = SUI_FIN_pp2_keyTimes[i - 1] - SUI_FIN_pp2_keyTimes[i]
  }
}
SUI_FIN_pp2_numPass
SUI_FIN_pp2_totSecs

SUI_FIN_pp2_events_updated <- SUI_FIN_pp2_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp2_keyTimes)) {
  SUI_FIN_pp2_events_updated <- SUI_FIN_pp2_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp2_keyTimes[i] & event != "Play",
                             SUI_FIN_pp2_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp2_keyTimes[i] & event != "Play",
                             SUI_FIN_pp2_totSecs[i], totSecs))
}

SUI_FIN_pp2_events_updated <- SUI_FIN_pp2_events_updated %>% filter(period == 1 & (clock_seconds <= 417 & clock_seconds >= 367)|
                                                                      (clock_seconds <= 355 & clock_seconds >= 311)|
                                                                      (clock_seconds <= 309 & clock_seconds >= 274)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp2_tracking$frame_id)
min_frame <- min(SUI_FIN_pp2_tracking$frame_id)
max_secs <- max(SUI_FIN_pp2_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp2_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp2_tracking <- SUI_FIN_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp2_tracking <- SUI_FIN_pp2_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp2_trackRost <- left_join(SUI_FIN_pp2_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp2_eventTrack <- left_join(SUI_FIN_pp2_events_updated, SUI_FIN_pp2_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_FIN_pp2_assistTrack <- SUI_FIN_pp2_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, SUI ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( SUI, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, SUI ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( SUI, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

SUI_FIN_pp2_shots <- SUI_FIN_pp2_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp2_shotTimes <- SUI_FIN_pp2_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp2_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp2_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp2_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp2_shotTimes[i] - SUI_FIN_pp2_shotTimes[i - 1] < 2) {
      SUI_FIN_pp2_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp2_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp2_shotTimes)) {
  SUI_FIN_pp2_shots <- SUI_FIN_pp2_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp2_shotTimes[i],
                             SUI_FIN_pp2_rebounds[i], rebound))
}

SUI_FIN_pp2_shotProb <- SUI_FIN_pp2_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp2_full <- SUI_FIN_pp2_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp2_shotProb_goals <- SUI_FIN_pp2_full %>% filter(event_successful == TRUE)
```

# PowerPlay 4
```{r}
SUI_FIN_pp4_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P2 pp4.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp4_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland P2 pp4.csv")
pp_info

SUI_FIN_pp4_events <- SUI_FIN_game_events %>% filter(period == 2 & (clock_seconds <= 594 & clock_seconds >= 474)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp4_keyTimes <- SUI_FIN_pp4_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp4_passTimes <- SUI_FIN_pp4_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp4_shotTimes <- SUI_FIN_pp4_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp4_astTimes <- vector()

SUI_FIN_pp4_events <- SUI_FIN_pp4_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp4_passTimes)) {
  SUI_FIN_pp4_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp4_shotTimes)) {
    if (SUI_FIN_pp4_passTimes[i] >= SUI_FIN_pp4_shotTimes[j] & SUI_FIN_pp4_passTimes[i] - SUI_FIN_pp4_shotTimes[j] <= 3) {
      SUI_FIN_pp4_astTimes[i] = SUI_FIN_pp4_passTimes[i]
      if (length(SUI_FIN_pp4_astTimes) > 1) {
        if (SUI_FIN_pp4_astTimes[i - 1] - SUI_FIN_pp4_astTimes[i] <= 3 & SUI_FIN_pp4_astTimes[i] > 0) {
          SUI_FIN_pp4_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp4_passTimes)) {
  SUI_FIN_pp4_events <- SUI_FIN_pp4_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp4_astTimes[i] |
                              SUI_FIN_pp4_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp4_events %>% filter(clock_seconds == SUI_FIN_pp4_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp4_numPass <- vector()
SUI_FIN_pp4_totSecs <- vector()
max_secs <- max(SUI_FIN_pp4_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp4_keyTimes)) {
  if (length(SUI_FIN_pp4_passTimes) == 0) {
    SUI_FIN_pp4_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp4_passTimes)) {
      if (SUI_FIN_pp4_passTimes[j] > SUI_FIN_pp4_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp4_passTimes <- SUI_FIN_pp4_passTimes[-1]
      }
    }
    SUI_FIN_pp4_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp4_totSecs[i] = max_secs - SUI_FIN_pp4_keyTimes[i]
  }
  else {
    SUI_FIN_pp4_totSecs[i] = SUI_FIN_pp4_keyTimes[i - 1] - SUI_FIN_pp4_keyTimes[i]
  }
}
SUI_FIN_pp4_numPass
SUI_FIN_pp4_totSecs

SUI_FIN_pp4_events_updated <- SUI_FIN_pp4_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp4_keyTimes)) {
  SUI_FIN_pp4_events_updated <- SUI_FIN_pp4_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp4_keyTimes[i] & event != "Play",
                             SUI_FIN_pp4_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp4_keyTimes[i] & event != "Play",
                             SUI_FIN_pp4_totSecs[i], totSecs))
}

SUI_FIN_pp4_events_updated <- SUI_FIN_pp4_events_updated %>% filter(period == 2 & (clock_seconds <= 594 & clock_seconds >= 561)|
                                                                      (clock_seconds <= 561 & clock_seconds >= 557)|
                                                                      (clock_seconds <= 557 & clock_seconds >= 538)|
                                                                      (clock_seconds <= 502 & clock_seconds >= 454)|
                                                                      (clock_seconds <= 447 & clock_seconds >= 429)) %>%
  filter(team_name == "SUI" & x_coord >= 125 | team_name == "FIN" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp4_tracking$frame_id)
min_frame <- min(SUI_FIN_pp4_tracking$frame_id)
max_secs <- max(SUI_FIN_pp4_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp4_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp4_tracking <- SUI_FIN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp4_tracking <- SUI_FIN_pp4_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp4_trackRost <- left_join(SUI_FIN_pp4_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp4_eventTrack <- left_join(SUI_FIN_pp4_events_updated, SUI_FIN_pp4_trackRost, by = c("clock_seconds" = "clock_seconds"))

 

SUI_FIN_pp4_shots <- SUI_FIN_pp4_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "FIN"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(FIN, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(FIN, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp4_shotTimes <- SUI_FIN_pp4_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp4_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp4_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp4_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp4_shotTimes[i] - SUI_FIN_pp4_shotTimes[i - 1] < 2) {
      SUI_FIN_pp4_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp4_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp4_shotTimes)) {
  SUI_FIN_pp4_shots <- SUI_FIN_pp4_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp4_shotTimes[i],
                             SUI_FIN_pp4_rebounds[i], rebound))
}

SUI_FIN_pp4_shotProb <- SUI_FIN_pp4_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp4_full <- SUI_FIN_pp4_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp4_shotProb_goals <- SUI_FIN_pp4_full %>% filter(event_successful == TRUE)
```

# PowerPlay 5
```{r}
SUI_FIN_pp5_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P2 pp5.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp5_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland P2 pp5.csv")
pp_info

SUI_FIN_pp5_events <- SUI_FIN_game_events %>% filter(period == 2 & (clock_seconds <= 229 & clock_seconds >= 109)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp5_keyTimes <- SUI_FIN_pp5_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp5_passTimes <- SUI_FIN_pp5_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp5_shotTimes <- SUI_FIN_pp5_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp5_astTimes <- vector()

SUI_FIN_pp5_events <- SUI_FIN_pp5_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp5_passTimes)) {
  SUI_FIN_pp5_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp5_shotTimes)) {
    if (SUI_FIN_pp5_passTimes[i] >= SUI_FIN_pp5_shotTimes[j] & SUI_FIN_pp5_passTimes[i] - SUI_FIN_pp5_shotTimes[j] <= 3) {
      SUI_FIN_pp5_astTimes[i] = SUI_FIN_pp5_passTimes[i]
      if (length(SUI_FIN_pp5_astTimes) > 1) {
        if (SUI_FIN_pp5_astTimes[i - 1] - SUI_FIN_pp5_astTimes[i] <= 3 & SUI_FIN_pp5_astTimes[i] > 0) {
          SUI_FIN_pp5_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp5_passTimes)) {
  SUI_FIN_pp5_events <- SUI_FIN_pp5_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp5_astTimes[i] |
                              SUI_FIN_pp5_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp5_events %>% filter(clock_seconds == SUI_FIN_pp5_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp5_numPass <- vector()
SUI_FIN_pp5_totSecs <- vector()
max_secs <- max(SUI_FIN_pp5_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp5_keyTimes)) {
  if (length(SUI_FIN_pp5_passTimes) == 0) {
    SUI_FIN_pp5_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp5_passTimes)) {
      if (SUI_FIN_pp5_passTimes[j] > SUI_FIN_pp5_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp5_passTimes <- SUI_FIN_pp5_passTimes[-1]
      }
    }
    SUI_FIN_pp5_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp5_totSecs[i] = max_secs - SUI_FIN_pp5_keyTimes[i]
  }
  else {
    SUI_FIN_pp5_totSecs[i] = SUI_FIN_pp5_keyTimes[i - 1] - SUI_FIN_pp5_keyTimes[i]
  }
}
SUI_FIN_pp5_numPass
SUI_FIN_pp5_totSecs

SUI_FIN_pp5_events_updated <- SUI_FIN_pp5_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp5_keyTimes)) {
  SUI_FIN_pp5_events_updated <- SUI_FIN_pp5_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp5_keyTimes[i] & event != "Play",
                             SUI_FIN_pp5_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp5_keyTimes[i] & event != "Play",
                             SUI_FIN_pp5_totSecs[i], totSecs))
}

SUI_FIN_pp5_events_updated <- SUI_FIN_pp5_events_updated %>% filter(period == 2 & (clock_seconds <= 219 & clock_seconds >= 128)|
                                                                      (clock_seconds <= 114 & clock_seconds >= 109)|
                                                                      (clock_seconds <= 104 & clock_seconds >= 91)|
                                                                      (clock_seconds <= 77 & clock_seconds >= 66)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp5_tracking$frame_id)
min_frame <- min(SUI_FIN_pp5_tracking$frame_id)
max_secs <- max(SUI_FIN_pp5_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp5_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp5_tracking <- SUI_FIN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp5_tracking <- SUI_FIN_pp5_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp5_trackRost <- left_join(SUI_FIN_pp5_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp5_eventTrack <- left_join(SUI_FIN_pp5_events_updated, SUI_FIN_pp5_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_FIN_pp5_assistTrack <- SUI_FIN_pp5_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, SUI ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( SUI, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, SUI ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( SUI, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

SUI_FIN_pp5_shots <- SUI_FIN_pp5_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((100 + x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((11 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>% select(-c(`NA`)) %>%
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((11 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp5_shotTimes <- SUI_FIN_pp5_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp5_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp5_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp5_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp5_shotTimes[i] - SUI_FIN_pp5_shotTimes[i - 1] < 2) {
      SUI_FIN_pp5_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp5_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp5_shotTimes)) {
  SUI_FIN_pp5_shots <- SUI_FIN_pp5_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp5_shotTimes[i],
                             SUI_FIN_pp5_rebounds[i], rebound))
}

SUI_FIN_pp5_shotProb <- SUI_FIN_pp5_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp5_full <- SUI_FIN_pp5_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp5_shotProb_goals <- SUI_FIN_pp5_full %>% filter(event_successful == TRUE)
```

# PowerPlay 7
```{r}
SUI_FIN_pp7_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P3 pp7.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp7_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland p3 pp7.csv")
pp_info

SUI_FIN_pp7_events <- SUI_FIN_game_events %>% filter(period == 3 & (clock_seconds <= 378 & clock_seconds >= 336)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp7_keyTimes <- SUI_FIN_pp7_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp7_passTimes <- SUI_FIN_pp7_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp7_shotTimes <- SUI_FIN_pp7_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp7_astTimes <- vector()

SUI_FIN_pp7_events <- SUI_FIN_pp7_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp7_passTimes)) {
  SUI_FIN_pp7_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp7_shotTimes)) {
    if (SUI_FIN_pp7_passTimes[i] >= SUI_FIN_pp7_shotTimes[j] & SUI_FIN_pp7_passTimes[i] - SUI_FIN_pp7_shotTimes[j] <= 3) {
      SUI_FIN_pp7_astTimes[i] = SUI_FIN_pp7_passTimes[i]
      if (length(SUI_FIN_pp7_astTimes) > 1) {
        if (SUI_FIN_pp7_astTimes[i - 1] - SUI_FIN_pp7_astTimes[i] <= 3 & SUI_FIN_pp7_astTimes[i] > 0) {
          SUI_FIN_pp7_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp7_passTimes)) {
  SUI_FIN_pp7_events <- SUI_FIN_pp7_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp7_astTimes[i] |
                              SUI_FIN_pp7_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp7_events %>% filter(clock_seconds == SUI_FIN_pp7_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp7_numPass <- vector()
SUI_FIN_pp7_totSecs <- vector()
max_secs <- max(SUI_FIN_pp7_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp7_keyTimes)) {
  if (length(SUI_FIN_pp7_passTimes) == 0) {
    SUI_FIN_pp7_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp7_passTimes)) {
      if (SUI_FIN_pp7_passTimes[j] > SUI_FIN_pp7_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp7_passTimes <- SUI_FIN_pp7_passTimes[-1]
      }
    }
    SUI_FIN_pp7_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp7_totSecs[i] = max_secs - SUI_FIN_pp7_keyTimes[i]
  }
  else {
    SUI_FIN_pp7_totSecs[i] = SUI_FIN_pp7_keyTimes[i - 1] - SUI_FIN_pp7_keyTimes[i]
  }
}
SUI_FIN_pp7_numPass
SUI_FIN_pp7_totSecs

SUI_FIN_pp7_events_updated <- SUI_FIN_pp7_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp7_keyTimes)) {
  SUI_FIN_pp7_events_updated <- SUI_FIN_pp7_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp7_keyTimes[i] & event != "Play",
                             SUI_FIN_pp7_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp7_keyTimes[i] & event != "Play",
                             SUI_FIN_pp7_totSecs[i], totSecs))
}

SUI_FIN_pp7_events_updated <- SUI_FIN_pp7_events_updated %>% filter(period == 3 & (clock_seconds <= 378 & clock_seconds >= 336)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp7_tracking$frame_id)
min_frame <- min(SUI_FIN_pp7_tracking$frame_id)
max_secs <- max(SUI_FIN_pp7_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp7_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp7_tracking <- SUI_FIN_pp7_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp7_tracking <- SUI_FIN_pp7_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp7_trackRost <- left_join(SUI_FIN_pp7_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp7_eventTrack <- left_join(SUI_FIN_pp7_events_updated, SUI_FIN_pp7_trackRost, by = c("clock_seconds" = "clock_seconds"))

SUI_FIN_pp7_assistTrack <- SUI_FIN_pp7_eventTrack %>% filter(event == "Play" & assist == TRUE) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>% 
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>%
  group_by(clock_seconds) %>%
  mutate(gk_pos = min( SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c( FIN, SUI ), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(team_id, frame_id) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max( SUI, na.rm = TRUE)) %>%
  pivot_longer(c( FIN, SUI ), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max( SUI, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI ,  FIN, gk_pos, team_mean_distance_from_centroid))
 

SUI_FIN_pp7_shots <- SUI_FIN_pp7_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>% 
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp7_shotTimes <- SUI_FIN_pp7_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp7_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp7_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp7_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp7_shotTimes[i] - SUI_FIN_pp7_shotTimes[i - 1] < 2) {
      SUI_FIN_pp7_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp7_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp7_shotTimes)) {
  SUI_FIN_pp7_shots <- SUI_FIN_pp7_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp7_shotTimes[i],
                             SUI_FIN_pp7_rebounds[i], rebound))
}

SUI_FIN_pp7_shotProb <- SUI_FIN_pp7_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp7_full <- SUI_FIN_pp7_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp7_shotProb_goals <- SUI_FIN_pp7_full %>% filter(event_successful == TRUE)
```

# PowerPlay 8
```{r}
SUI_FIN_pp8_tracking <-  read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland P3 pp8.csv") %>% mutate(clock_seconds = 0) %>% mutate(team_name = if_else(team_name == "Finland", "FIN", "SUI"))
SUI_FIN_pp8_tracking_info <- read_csv("Big-Data-Cup-2021-main/Big-Data-Cup-2021-main/TrackingData/2022-02-16 Switzerland at Finland/videoShotsInfo_2022-02-16 Switzerland at Finland p3 pp8.csv")
pp_info

SUI_FIN_pp8_events <- SUI_FIN_game_events %>% filter(period == 3 & (clock_seconds <= 171 & clock_seconds >= 57)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

SUI_FIN_pp8_keyTimes <- SUI_FIN_pp8_events %>% filter(event == "Shot" | 
                                                      (event == "Play" & event_successful == FALSE) | 
                                                      event == "Puck Recovery" |
                                                      event == "Zone Entry") %>% 
  select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp8_passTimes <- SUI_FIN_pp8_events %>% filter(event == "Play" & event_successful == TRUE) %>% select(clock_seconds) %>% pull()
SUI_FIN_pp8_shotTimes <- SUI_FIN_pp8_events %>% filter(event == "Shot") %>% select(clock_seconds) %>% pull()
SUI_FIN_pp8_astTimes <- vector()

SUI_FIN_pp8_events <- SUI_FIN_pp8_events %>% group_by(clock_seconds) %>% 
  mutate(assist = FALSE) %>%
  group_by(clock_seconds, event) %>%
  mutate(intersection = ifelse(event == "Play" & event_successful == TRUE,
                                intersect(x_coord,y_coord, x_coord_2, y_coord_2,154,49,189,49), NA))

for(i in 1:length(SUI_FIN_pp8_passTimes)) {
  SUI_FIN_pp8_astTimes[i] = -1
  for (j in 1:length(SUI_FIN_pp8_shotTimes)) {
    if (SUI_FIN_pp8_passTimes[i] >= SUI_FIN_pp8_shotTimes[j] & SUI_FIN_pp8_passTimes[i] - SUI_FIN_pp8_shotTimes[j] <= 3) {
      SUI_FIN_pp8_astTimes[i] = SUI_FIN_pp8_passTimes[i]
      if (length(SUI_FIN_pp8_astTimes) > 1) {
        if (SUI_FIN_pp8_astTimes[i - 1] - SUI_FIN_pp8_astTimes[i] <= 3 & SUI_FIN_pp8_astTimes[i] > 0) {
          SUI_FIN_pp8_astTimes[i - 1] = -1
        }
      }
    }
  }
}

for (i in 1:length(SUI_FIN_pp8_passTimes)) {
  SUI_FIN_pp8_events <- SUI_FIN_pp8_events %>%
    mutate(assist = if_else(clock_seconds == SUI_FIN_pp8_astTimes[i] |
                              SUI_FIN_pp8_astTimes[i] - clock_seconds <= 3 & event == "Shot", 
                            TRUE, assist),
           intersection = if_else(event == "Shot" & assist == TRUE,
                                  SUI_FIN_pp8_events %>% filter(clock_seconds == SUI_FIN_pp8_passTimes[i] & event == "Play") %>%
                                    select(intersection) %>% pull(),intersection))
}

SUI_FIN_pp8_numPass <- vector()
SUI_FIN_pp8_totSecs <- vector()
max_secs <- max(SUI_FIN_pp8_events$clock_seconds)

for (i in 1:length(SUI_FIN_pp8_keyTimes)) {
  if (length(SUI_FIN_pp8_passTimes) == 0) {
    SUI_FIN_pp8_numPass[i] = 0
  }
  else {
    counter = 0
    for (j in 1:length(SUI_FIN_pp8_passTimes)) {
      if (SUI_FIN_pp8_passTimes[j] > SUI_FIN_pp8_keyTimes[i]) {
        counter = counter + 1
      }
    }
    if (counter > 0) {
      for (k in 1:counter) {
        SUI_FIN_pp8_passTimes <- SUI_FIN_pp8_passTimes[-1]
      }
    }
    SUI_FIN_pp8_numPass[i] = counter
  }
  if (i == 1) {
    SUI_FIN_pp8_totSecs[i] = max_secs - SUI_FIN_pp8_keyTimes[i]
  }
  else {
    SUI_FIN_pp8_totSecs[i] = SUI_FIN_pp8_keyTimes[i - 1] - SUI_FIN_pp8_keyTimes[i]
  }
}
SUI_FIN_pp8_numPass
SUI_FIN_pp8_totSecs

SUI_FIN_pp8_events_updated <- SUI_FIN_pp8_events %>% mutate(numPass = -1,
                                                          totSecs = -1)
for (i in 1:length(SUI_FIN_pp8_keyTimes)) {
  SUI_FIN_pp8_events_updated <- SUI_FIN_pp8_events_updated %>%
    mutate(numPass = if_else(clock_seconds == SUI_FIN_pp8_keyTimes[i] & event != "Play",
                             SUI_FIN_pp8_numPass[i], numPass),
           totSecs = if_else(clock_seconds == SUI_FIN_pp8_keyTimes[i] & event != "Play",
                             SUI_FIN_pp8_totSecs[i], totSecs))
}

SUI_FIN_pp8_events_updated <- SUI_FIN_pp8_events_updated %>% filter(period == 3 & (clock_seconds <= 107 & clock_seconds >= 35)) %>%
  filter(team_name == "FIN" & x_coord >= 125 | team_name == "SUI" & x_coord <= 75) %>%
  filter(situation_type == "5 on 4" | situation_type == "4 on 5")

max_frame <- max(SUI_FIN_pp8_tracking$frame_id)
min_frame <- min(SUI_FIN_pp8_tracking$frame_id)
max_secs <- max(SUI_FIN_pp8_events_updated$clock_seconds)
min_secs <- min(SUI_FIN_pp8_events_updated$clock_seconds)

count = 0
seconds = max_secs
for (i in min_frame:max_frame) {
  if (count < 30) {
    SUI_FIN_pp8_tracking <- SUI_FIN_pp8_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  else {
    count = 0
    seconds = seconds - 1
    SUI_FIN_pp8_tracking <- SUI_FIN_pp8_tracking %>%
      mutate(clock_seconds = if_else(frame_id == i, seconds, clock_seconds))
  }
  count = count + 1
}

SUI_FIN_pp8_trackRost <- left_join(SUI_FIN_pp8_tracking, SUI_FIN_roster, by = c("team_name" = "team", "jersey_number" = "jn"))
SUI_FIN_pp8_eventTrack <- left_join(SUI_FIN_pp8_events_updated, SUI_FIN_pp8_trackRost, by = c("clock_seconds" = "clock_seconds"))
 

SUI_FIN_pp8_shots <- SUI_FIN_pp8_eventTrack %>% filter(event == "Shot") %>% 
  mutate(shot_distance_from_goal = sqrt((189 - x_coord)^2 + (49 - y_coord)^2),
         shot_angle_from_goal = tan(-1*(y_coord/(189 - x_coord)*(180/pi)))) %>%
  mutate(distance_from_shot_release = sqrt((x_ft - x_coord)^2 + (y_ft - y_coord)^2)) %>%
  mutate(distance_from_y_middle = sqrt((y_ft - 49)^2),
         distance_from_goal = sqrt((189 - x_ft)^2 + (49 - y_ft)^2)) %>%
  pivot_wider(names_from = team_name.y, values_from = distance_from_goal) %>% 
  group_by(clock_seconds) %>%
  mutate(gk_pos = min(SUI, na.rm = TRUE)) %>% 
  pivot_longer(cols = c(FIN, SUI), names_to = "team_name.y", values_to = "distance_from_goal") %>%
  filter(is.na(distance_from_goal) == FALSE) %>%
  filter(distance_from_goal != gk_pos | gk_pos > 6) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  mutate(closest_defender_distance = min(distance_from_shot_release[team_name.y == "SUI"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(team_mean_distance_from_y_middle = mean(distance_from_y_middle, na.rm = TRUE),
         team_mean_distance_from_goal = mean(distance_from_goal, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_y_middle) %>%
  group_by(clock_seconds) %>%
  mutate(def_mean_distance_from_y_middle = min(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_y_middle") %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_goal) %>%
  mutate(def_mean_distance_from_goal = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(cols = c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_goal") %>%
  ungroup() %>%
  group_by(clock_seconds, team_name.y) %>%
  mutate(centroid_x = sum(x_ft)/n(),
         centroid_y = sum(y_ft)/n(),
         distance_from_centroid = sqrt((centroid_x - x_ft)^2 + (centroid_y - y_ft)^2),
         team_mean_distance_from_centroid = mean(distance_from_centroid)) %>%
  mutate(centroid_distance_from_goal = sqrt((189 - centroid_x)^2 + (49 - centroid_y)^2)) %>%
  ungroup() %>%
  group_by(clock_seconds) %>%
  pivot_wider(names_from = team_name.y, values_from = team_mean_distance_from_centroid) %>%
  mutate(def_mean_distance_from_centroid = max(SUI, na.rm = TRUE)) %>%
  pivot_longer(c(SUI, FIN), names_to = "team_name.y", values_to = "team_mean_distance_from_centroid") %>%
  pivot_wider(names_from = team_name.y, values_from = centroid_distance_from_goal) %>%
  mutate(def_centroid_distance_from_goal = max(SUI, na.rm = TRUE),
         shot_behind_centroid = if_else(shot_distance_from_goal < def_centroid_distance_from_goal,
                                        TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(clock_seconds, frame_id) %>% mutate(frame_total = n()) %>%
  ungroup() %>%
  group_by(clock_seconds, track_id) %>% 
  slice(max(frame_total)) %>%
  select(-c(frame_total, SUI, FIN, gk_pos, team_mean_distance_from_y_middle, team_mean_distance_from_goal, team_mean_distance_from_centroid)) %>%
  mutate(rebound = -1)

SUI_FIN_pp8_shotTimes <- SUI_FIN_pp8_shots %>% ungroup() %>% select(clock_seconds) %>% distinct() %>% pull() 

SUI_FIN_pp8_rebounds <- vector()
for (i in 1:length(SUI_FIN_pp8_shotTimes)) {
  if (i == 1) {
    SUI_FIN_pp8_rebounds[i] = 0
  }
  else {
    if (SUI_FIN_pp8_shotTimes[i] - SUI_FIN_pp8_shotTimes[i - 1] < 2) {
      SUI_FIN_pp8_rebounds[i] = 1
    }
    else {
      SUI_FIN_pp8_rebounds[i] = 0
    }
  }
}
for (i in 1:length(SUI_FIN_pp8_shotTimes)) {
  SUI_FIN_pp8_shots <- SUI_FIN_pp8_shots %>%
    mutate(rebound = if_else(clock_seconds == SUI_FIN_pp8_shotTimes[i],
                             SUI_FIN_pp8_rebounds[i], rebound))
}

SUI_FIN_pp8_shotProb <- SUI_FIN_pp8_shots %>% 
  mutate(distance_points = case_when(shot_distance_from_goal < 10 ~ 0.6884,
                                     shot_distance_from_goal >= 10 & shot_distance_from_goal < 12.5 ~ 0.6374,
                                     shot_distance_from_goal >= 12.5 & shot_distance_from_goal < 14.5 ~ 0.5564,
                                     shot_distance_from_goal >= 14.5 & shot_distance_from_goal < 16.5 ~ 0.5174,
                                     shot_distance_from_goal >= 16.5 & shot_distance_from_goal < 22.5 ~ 0.3654,
                                     shot_distance_from_goal >= 22.5 & shot_distance_from_goal < 31.5 ~ 0,
                                     shot_distance_from_goal >= 31.5 & shot_distance_from_goal < 36.5 ~ -0.3805,
                                     shot_distance_from_goal >= 36.5 & shot_distance_from_goal < 38.5 ~ -0.4758,
                                     shot_distance_from_goal >= 38.5 & shot_distance_from_goal < 44.5 ~ -0.8155,
                                     shot_distance_from_goal >= 44.5 & shot_distance_from_goal < 57.5 ~ -1.0848,
                                     shot_distance_from_goal >= 57.5 ~ -1.3824),
         shotType_points = case_when(event_type == "Snapshot" ~ 0.0130,
                                     event_type == "Slapshot" ~ -0.0573,
                                     event_type == "Wristshot" ~ 0.0093,
                                     event_type == "Wrap Around" ~ -0.0742,
                                     event_type == "Deflection" & event_detail_1 != "Blocked" & event_detail_3 == TRUE  ~ 0.1487),
         rebound_points = if_else(rebound == 1, 1.3362, 0),
         points = -2.2369 + 0.4007 + distance_points + shotType_points + rebound_points,
         shot_probability = 1/(1 + exp(-points))) %>%
  mutate(points2 = -2.2899 + 0.4370 - 0.0437*shot_distance_from_goal - 0.0162*shot_angle_from_goal + 0.9948*rebound,
         shot_probability2 = 1/(1 + exp(-points2))) %>%
  select(-c(distance_points, shotType_points, rebound_points, points, points2))

SUI_FIN_pp8_full <- SUI_FIN_pp8_shotProb %>% select(c(3,4,6,12:16,18:26,29,32,33, 36:52))

SUI_FIN_pp8_shotProb_goals <- SUI_FIN_pp8_full %>% filter(event_successful == TRUE)
```

# Combined
```{r}
SUI_FIN_combined <- bind_rows(SUI_FIN_pp1_full,
                              SUI_FIN_pp2_full,
                              SUI_FIN_pp4_full,
                              SUI_FIN_pp5_full,
                              SUI_FIN_pp7_full,
                              SUI_FIN_pp8_full)

SUI_FIN_ast_combined <- bind_rows(SUI_FIN_pp1_assistTrack,
                                  SUI_FIN_pp2_assistTrack,
                                  SUI_FIN_pp5_assistTrack,
                                  SUI_FIN_pp7_assistTrack) %>% filter(def_centroid_distance_from_goal < 100)
```


__All PowerPlays Combined__
```{r}

ast_combined_all <- bind_rows(CAN_US_ast_combined,
                              ROC_FIN_ast_combined,
                              SUI_ROC_ast_combined,
                              SUI_CAN_ast_combined,
                              FIN_USA_ast_combined,
                              SUI_FIN_ast_combined) %>% group_by(clock_seconds, team_name.x, opp_team_name, period.x) %>% slice(1) %>%
  mutate(centInt = intersect(x_coord,y_coord,x_coord_2,y_coord_2,centroid_x,0,centroid_x,98))

pp_combined_all <- bind_rows(CAN_US_pp_combined,
                         ROC_FIN_pp_combined,
                         SUI_ROC_combined,
                         SUI_CAN_combined,
                         FIN_USA_combined,
                         SUI_FIN_combined)
pp_combined <- pp_combined_all %>% group_by(clock_seconds, team_name.x, opp_team_name, period.x) %>% slice(1) %>% filter(!is.na(shot_probability)) %>%
  filter(shot_probability < 0.5)

pp_combined <- pp_combined %>% mutate(shot_distance_from_centroid = if_else(centroid_x > 100,
                                                                   sqrt((x_coord - centroid_x)^2 + (y_coord - centroid_y)^2),
                                                                   sqrt((x_coord - centroid_x - 100)^2 + (y_coord - centroid_y)^2)))
pp_combined <- pp_combined %>% filter(!is.na(intersection)) %>%
         mutate(intersection = as.character(intersection)
           ,intersection = fct_recode(intersection,
                                          "Royal Road Cross" = "TRUE", 
                                          "No Royal Road Cros" = "FALSE")) %>%
         mutate(shot_behind_centroid = as.character(shot_behind_centroid),
                shot_behind_centroid = fct_recode(shot_behind_centroid,
                                                  "Shot Behind Defensive Centroid with" = "TRUE",
                                                  "Shot in Front of Defensive Centriod with" = "FALSE"))
pp_combined <- pp_combined %>% filter(!is.na(intersection)) %>%
         mutate(intersection = as.character(intersection)
           ,intersection = fct_recode(intersection,
                                          "Royal Road Cross" = "TRUE", 
                                          "No Royal Road Cros" = "FALSE")) %>%
         mutate(shot_behind_centroid = as.character(shot_behind_centroid),
                shot_behind_centroid = fct_recode(shot_behind_centroid,
                                                  "Shot Closer than Centroid" = "TRUE",
                                                  "Shot Further than Defensive Centriod" = "FALSE"))
```

```{r}
library(knitr)
kable(pp_combined %>% ungroup() %>% summarise("Control Model" = mean(shot_probability), `Position Model` = mean(shot_probability2)))
```


```{r}
library(ggtech)
ggplot(pp_combined, aes(x = numPass)) +
  geom_histogram(color = "black", fill = "red", binwidth = 1) +
  labs(x = "Number of Consectuive Passes Leading to Shot") 
ggplot(pp_combined, aes(x = totSecs)) +
  geom_histogram(color = "black", fill = "red", binwidth = 2) +
  labs(x = "Seconds of Sustained Pressure Until Shot")

ggplot(pp_combined, aes(y = shot_probability, x = def_centroid_distance_from_goal)) +
  geom_point() +
  facet_wrap(~shot_behind_centroid) 
ggplot(pp_combined, aes(x = shot_probability2, y = def_centroid_distance_from_goal)) +
  geom_point() +
  facet_wrap(~shot_behind_centroid) 
ggplot(pp_combined, aes(x = totSecs, y = def_centroid_distance_from_goal)) + geom_point() +
  geom_smooth(method = "lm")
ggplot(pp_combined, aes(x = numPass, y = def_centroid_distance_from_goal)) + geom_point() +
  geom_smooth(method = "lm")

ggplot(pp_combined, aes(x = shot_probability, y = def_mean_distance_from_centroid)) +
  geom_point() +
  facet_wrap(~shot_behind_centroid)
ggplot(pp_combined, aes(x = shot_probability2, y = def_mean_distance_from_centroid)) +
  geom_point() +
  facet_wrap(~shot_behind_centroid) 
ggplot(pp_combined, aes(x = totSecs, y = def_mean_distance_from_centroid)) + geom_point() +
  geom_smooth(method = "lm")
ggplot(pp_combined, aes(x = numPass, y = def_mean_distance_from_centroid)) + geom_point() +
  geom_smooth(method = "lm")


ggplot(pp_combined,
       aes(x = shot_probability, y = shot_probability2, color = shot_behind_centroid)) +
  geom_point() +
  labs(x = "Shot Probability from Shot Control Model",
       y = "Shot Probability from Shot Position Model",
       color = "Shot Location") +
  geom_jitter() +
  scale_color_brewer(palette = "Set1")
ggplot(pp_combined,
       aes(x = shot_probability, y = shot_probability2, color = intersection)) +
  geom_point() +
  labs(x = "Shot Probability from Shot Control Model",
       y = "Shot Probability from Shot Position Model",
       color = "Pass Directly Leading to Shot") +
  scale_color_brewer(palette = "Set1") 

ggplot(pp_combined, 
       aes(x = shot_probability, y = shot_probability2)) +
  geom_point() +
  facet_wrap(shot_behind_centroid~ intersection) +
  labs(x = "Control Model Shot Probability",
       y = "Position Model Shot Probability")
ggplot(pp_combined, aes(x = shot_probability2, y = intersection)) +
  geom_point() +
  facet_wrap(~shot_behind_centroid)
ggplot(pp_combined, aes(x = shot_probability, y = intersection)) +
  geom_col() +
  facet_wrap(~shot_behind_centroid)

ggplot(pp_combined,
       aes(x = def_mean_distance_from_centroid, y = def_centroid_distance_from_goal, color = shot_probability)) +
  geom_point() +
  labs(color = "Control Model Shot Probability",
       x = "Defenders Average Distance from Centroid(feet)",
       y = "Centroid Distance from Goal(feet)") +
  scale_color_viridis_c(option = "magma") +
  theme_dark() +
  facet_wrap(~shot_behind_centroid)
ggplot(pp_combined,
       aes(x = def_mean_distance_from_centroid, y = def_centroid_distance_from_goal, color = intersection)) +
  geom_point() +
  labs(color = "Shot Location",
       x = "Defenders Average Distance from Centroid(feet)",
       y = "Centroid Distance from Goal(feet)") +
  scale_color_brewer(palette = "Set1")

ggplot(ast_combined_all, aes(x = def_mean_distance_from_centroid, y = def_centroid_distance_from_goal, color = intersection )) +
  geom_point()

plot_rink = function(p_object){
  
  require(ggforce)
  require(cowplot)
  require(tidyverse)
  
  upper_outline = data.frame(
    x = c(
      115,
      172 + 28*sin(seq(0,pi/2,length=20)),
      172 + 28*sin(seq(pi/2,0,length=20)),
      115
    ),
    y = c(
      0, 
      0 + 28 - 28*cos(seq(0,pi/2,length=20)),
      85 - 28 + 28*cos(seq(pi/2,0,length=20)),
      85
    )
  )
  
  lower_outline = data.frame(
    x = c(
      115,
      100-72 - 28*sin(seq(0,pi/2,length=20)),
      100-72 - 28*sin(seq(pi/2,0,length=20)),
      115
    ),
    y = c(
      0, 
      0 + 28 - 28*cos(seq(0,pi/2,length=20)),
      85 - 28 + 28*cos(seq(pi/2,0,length=20)),
      85
    )
  )
  
  p = p_object +
    ## FACEOFF CIRCLES ##
    geom_circle(data = data.frame(x0 = 100, y0 = 42.5, r = 15), aes(x0 = x0, y0 = y0, r = r), lwd = 0.5, col = "gray50", inherit.aes = FALSE) +
    geom_circle(data = data.frame(x0 = 169, y0 = 20.5, r = 15), aes(x0 = x0, y0 = y0, r = r), lwd = 0.5, col = "gray50", inherit.aes = FALSE) +
    geom_circle(data = data.frame(x0 = 169, y0 = 64.5, r = 15), aes(x0 = x0, y0 = y0, r = r), lwd = 0.5, col = "gray50", inherit.aes = FALSE) +
    geom_circle(data = data.frame(x0 = 31, y0 = 64.5, r = 15), aes(x0 = x0, y0 = y0, r = r), lwd = 0.5, col = "gray50", inherit.aes = FALSE) +
    geom_circle(data = data.frame(x0 = 31, y0 = 20.5, r = 15), aes(x0 = x0, y0 = y0, r = r), lwd = 0.5, col = "gray50", inherit.aes = FALSE) +
    ## FACEOFF DOTS ##
    geom_point(inherit.aes = FALSE, aes(y = 42.5, x = 100), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 20.5, x = 169), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 64.5, x = 169), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 20.5, x = 120), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 64.5, x = 120), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 20.5, x = 31), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 64.5, x = 31), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 20.5, x = 80), col = "gray50", size = 1) +
    geom_point(inherit.aes = FALSE, aes(y = 64.5, x = 80), col = "gray50", size = 1) +
    ## BLUE AND RED LINES ##
    annotate("segment", col = "gray50",  x = 75, xend = 75, y = 0, yend = 85, lwd = 0.5) +
    annotate("segment", col = "gray50", x = 100, xend = 100, y = 0, yend = 85, lwd = 0.5) +
    annotate("segment", col = "gray50",  x = 125, xend = 125, y = 0, yend = 85, lwd = 0.5) +
    ## NET AND GOAL LINE ##
    geom_segment(col = "gray50", inherit.aes = FALSE, lwd = 0.5, aes(y = 79.25, x = 11, yend = 5.75, xend = 11)) +
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 39.5, x = 7.5, yend = 45.5, xend = 7.5)) + 
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 39.5, x = 7.5, yend = 39.5, xend = 11)) +  
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 45.5, x = 7.5, yend = 45.5, xend = 11)) +
    geom_segment(col = "gray50", inherit.aes = FALSE, lwd = 0.5, aes(y = 5.75, x = 189, yend = 79.25, xend = 189)) +
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 39.5, x = 192.5, yend = 45.5, xend = 192.5)) + 
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 39.5, x = 192.5, yend = 39.5, xend = 189)) +  
    geom_segment(col = "indianred", inherit.aes = FALSE, lwd = 0.5, aes(y = 45.5, x = 192.5, yend = 45.5, xend = 189)) +
    ## OUTLINE ##
    geom_path(data = upper_outline, aes(x = x, y = y), colour = "gray80", inherit.aes = FALSE, lwd = 0.5) +
    geom_path(data = lower_outline, aes(x = x, y = y), colour = "gray80", inherit.aes = FALSE, lwd = 0.5) +
    ## ADDITIONAL SPECS ##
    scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + scale_y_continuous(expand = c(0,0), limits = c(0,85)) +
    coord_fixed() +
    theme_void()
  
  return(p)
}
library(plotly)

plot_rink(ggplot(pp_combined, aes(x_coord, y_coord))+
            geom_point(aes(color = shot_behind_centroid))+
            geom_point(data = pp_combined %>% mutate(centroid_x = if_else(centroid_x < 100, 200 - centroid_x , centroid_x)),
                       aes(centroid_x, centroid_y)))
plot_rink(ggplot(pp_combined %>% mutate(centroid_x = if_else(centroid_x < 100, 200 - centroid_x , centroid_x)), aes(centroid_x, centroid_y))+
            geom_point()) 
plot_rink(ggplot(pp_combined, aes(x_coord, y_coord))+
            geom_tile(aes(fill = shot_probability2), size = 50)) 

```

